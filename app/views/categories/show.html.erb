<div class="flex h-screen relative" style="background-color: #F5F5F5;">
  <%= render 'shared/sidebar' %>

  <!-- Mobile overlay -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 md:hidden hidden"></div>

  <!-- Menu flag button -->
  <button id="menu-button" class="fixed left-0 z-20 md:hidden rounded-r-lg shadow-lg flex items-center justify-center py-1.5 px-3 transition-all"
    style="top: 200px; background: linear-gradient(135deg, #1d3e4c, #45606b); writing-mode: vertical-rl;">
    <span class="text-white font-bold text-sm tracking-wider">MENU</span>
  </button>

<script>
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  const menuButton = document.getElementById('menu-button');
  const closeButton = document.getElementById('sidebar-close');

  function openSidebar() {
    sidebar.classList.remove('-translate-x-full');
    sidebar.classList.add('translate-x-0');
    overlay.classList.remove('hidden');
    menuButton.classList.add('hidden');
  }

  function closeSidebar() {
    sidebar.classList.add('-translate-x-full');
    sidebar.classList.remove('translate-x-0');
    overlay.classList.add('hidden');
    menuButton.classList.remove('hidden');
  }

  menuButton.addEventListener('click', openSidebar);
  closeButton.addEventListener('click', closeSidebar);
  overlay.addEventListener('click', closeSidebar);
</script>

  <!-- Main Content Area -->
  <main class="flex-1 overflow-y-auto" style="background-color: #F5F5F5;" x-data="{
      showEditModal: false,
      showNewHabitModal: false,
      editHabitId: null,
      categoryName: '<%= @category.name.gsub("'", "\\\\'") %>',
      categoryDescription: '<%= @category.description.to_s.gsub("'", "\\\\'") %>',
      selectedColor: '<%= @category.color %>',
      selectedIcon: '<%= @category.icon %>',
      colorMap: {
        '#6B8A99': { light: '#E8EEF1', dark: '#1d3e4c' },
        '#9C8B7E': { light: '#E8E0D5', dark: '#5C4F45' },
        '#F8796D': { light: '#FFD4CE', dark: '#B8352A' },
        '#FFA07A': { light: '#FFE4D6', dark: '#D66A3E' },
        '#E5C730': { light: '#FEF7C3', dark: '#B89F0A' },
        '#A8A356': { light: '#E8EBCD', dark: '#7A7637' },
        '#7CB342': { light: '#D7EDCB', dark: '#4A6B27' },
        '#6EE7B7': { light: '#D1FAF0', dark: '#2C9D73' },
        '#22D3EE': { light: '#CFFAFE', dark: '#0E7490' },
        '#6366F1': { light: '#E0E7FF', dark: '#3730A3' },
        '#A78BFA': { light: '#EDE9FE', dark: '#6B21A8' },
        '#E879F9': { light: '#FAE8FF', dark: '#A21CAF' },
        '#FB7185': { light: '#FFE4E6', dark: '#BE123C' },
        '#9CA3A8': { light: '#E8E8E8', dark: '#4A5057' }
      }
    }">
    <!-- White Header Section with Shadow -->
    <div class="bg-white shadow-md sticky top-0 z-10">
      <div class="p-8 pb-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center shadow-lg" style="background-color: <%= @category.color %>;">
              <i class="fa-solid <%= @category.icon %> text-white text-xl"></i>
            </div>
            <div>
              <%
                color_map = {
                  '#6B8A99' => '#1d3e4c', '#9C8B7E' => '#5C4F45', '#F8796D' => '#B8352A',
                  '#FFA07A' => '#D66A3E', '#E5C730' => '#B89F0A', '#A8A356' => '#7A7637',
                  '#7CB342' => '#4A6B27', '#6EE7B7' => '#2C9D73', '#22D3EE' => '#0E7490',
                  '#6366F1' => '#3730A3', '#A78BFA' => '#6B21A8', '#E879F9' => '#A21CAF',
                  '#FB7185' => '#BE123C', '#9CA3A8' => '#4A5057'
                }
                light_color_map = {
                  '#6B8A99' => '#E8EEF1', '#9C8B7E' => '#E8E0D5', '#F8796D' => '#FFD4CE',
                  '#FFA07A' => '#FFE4D6', '#E5C730' => '#FEF7C3', '#A8A356' => '#E8EBCD',
                  '#7CB342' => '#D7EDCB', '#6EE7B7' => '#D1FAF0', '#22D3EE' => '#CFFAFE',
                  '#6366F1' => '#E0E7FF', '#A78BFA' => '#EDE9FE', '#E879F9' => '#FAE8FF',
                  '#FB7185' => '#FFE4E6', '#9CA3A8' => '#E8E8E8'
                }
                dark_color = color_map[@category.color] || '#1d3e4c'
                light_color = light_color_map[@category.color] || '#E8EEF1'
              %>
              <h1 class="text-4xl font-bold display-font mb-1" style="color: <%= @category.color %>;"><%= @category.name %></h1>
              <p class="text-sm font-light" style="color: #657b84;">
                <%= @category.description.present? ? @category.description : "Track Your Habits" %>
              </p>
            </div>
          </div>
          <div class="gap-3">
            <button @click="showNewHabitModal = true" class="px-4 py-2 rounded-lg text-white font-semibold shadow-md hover:shadow-lg transition transform hover:scale-[1.02]" style="background-color: <%= @category.color %>;">
              <i class="fa-solid fa-plus mr-2"></i>Add Habit
            </button>
            <button @click="showEditModal = true" class="font-semibold hover:opacity-70 transition" style="color: <%= dark_color %>;">
              <i class="fa-solid fa-pen-to-square mr-2"></i>Edit Category
            </button>
          </div>
        </div>
      </div>
    </div>

    <%= render partial: 'categories/edit_modal', locals: { category: @category } %>

    <!-- Grey Background Content -->
    <div class="p-8 pt-6">
      <!-- Habits Section -->
      <div class="flex items-center justify-between mb-6">
        <%
          dark_color = {
            '#6B8A99' => '#1d3e4c', '#9C8B7E' => '#5C4F45', '#F8796D' => '#B8352A',
            '#FFA07A' => '#D66A3E', '#E5C730' => '#B89F0A', '#A8A356' => '#7A7637',
            '#7CB342' => '#4A6B27', '#6EE7B7' => '#2C9D73', '#22D3EE' => '#0E7490',
            '#6366F1' => '#3730A3', '#A78BFA' => '#6B21A8', '#E879F9' => '#A21CAF',
            '#FB7185' => '#BE123C', '#9CA3A8' => '#4A5057'
          }[@category.color] || '#1d3e4c'
        %>
        <h2 class="text-2xl font-bold display-font" style="color: <%= dark_color %>;">Habits</h2>

        <!-- Sort Toggle -->
        <div class="flex gap-1 bg-white p-0.5 rounded-lg shadow-sm">
          <%= link_to category_path(@category, sort: 'priority'), class: "px-3 py-1.5 rounded-lg text-xs font-semibold transition #{@sort_by == 'priority' ? 'shadow-sm' : 'hover:bg-gray-100'}", style: @sort_by == 'priority' ? "background-color: #{light_color}; color: #{dark_color};" : "color: #{dark_color};" do %>
            <i class="fa-solid fa-star mr-1"></i>Priority
          <% end %>
          <%= link_to category_path(@category, sort: 'time'), class: "px-3 py-1.5 rounded-lg text-xs font-semibold transition #{@sort_by == 'time' ? 'shadow-sm' : 'hover:bg-gray-100'}", style: @sort_by == 'time' ? "background-color: #{light_color}; color: #{dark_color};" : "color: #{dark_color};" do %>
            <i class="fa-solid fa-clock mr-1"></i>Time
          <% end %>
        </div>
      </div>

        <% if @habits.any? %>
          <div class="grid gap-4">
            <% @habits.each do |habit| %>
              <%
                completion = @today_completions[habit.id]
                current_count = completion ? completion.count : 0
              %>
              <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition" style="border-left: 4px solid <%= @category.color %>;" x-data="{
                count: <%= current_count %>,
                streak: <%= habit.current_streak %>,
                async updateCompletion(action) {
                  const response = await fetch(`/habits/<%= habit.id %>/completions/${action}`, {
                    method: 'POST',
                    headers: {
                      'X-CSRF-Token': document.querySelector('[name=csrf-token]').content,
                      'Content-Type': 'application/json'
                    }
                  });
                  const data = await response.json();
                  this.count = data.count;
                  this.streak = data.streak;
                }
              }">
                <div class="flex items-center gap-3">
                  <!-- Completion Indicator -->
                  <div class="flex-shrink-0">
                    <% if habit.target_count == 1 %>
                      <button @click="count > 0 ? updateCompletion('decrement') : updateCompletion('increment')" class="w-10 h-10 rounded-lg border-2 flex items-center justify-center font-bold transition hover:scale-110" style="border-color: <%= @category.color %>; color: <%= @category.color %>;" :style="count > 0 ? { backgroundColor: '<%= @category.color %>', color: 'white' } : {}">
                        <i class="fa-solid" :class="count > 0 ? 'fa-check' : 'fa-plus'"></i>
                      </button>
                    <% else %>
                      <!-- Counter with +/- buttons -->
                      <div class="flex items-center rounded-lg border-2 overflow-hidden" style="border-color: <%= @category.color %>;">
                        <button @click="updateCompletion('decrement')" class="flex-1 h-10 px-[5px] flex items-center justify-center font-bold transition hover:bg-gray-50" style="color: <%= @category.color %>;">
                          <i class="fa-solid fa-minus"></i>
                        </button>
                        <div class="flex-[2] h-10 px-[10px] flex items-center justify-center font-bold" style="color: <%= @category.color %>;" x-text="count">
                          <%= current_count %>
                        </div>
                        <button @click="updateCompletion('increment')" class="flex-1 h-10 px-[5px] flex items-center justify-center font-bold transition hover:bg-gray-50" style="color: <%= @category.color %>;">
                          <i class="fa-solid fa-plus"></i>
                        </button>
                      </div>
                    <% end %>
                  </div>

                  <!-- Habit Name & Info -->
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                      <div class="font-semibold" style="color: <%= dark_color %>;">
                        <%= habit.name %>
                      </div>
                      <% if habit.importance.present? && habit.importance != 'normal' %>
                        <div class="flex-shrink-0 w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold" style="background-color: <%= @category.color %>; color: white;">
                          <%= case habit.importance
                            when 'critical' then '!!'
                            when 'important' then '!'
                            when 'optional' then '?'
                          end %>
                        </div>
                      <% end %>
                      <button @click="editHabitId = <%= habit.id %>" class="text-sm hover:opacity-70 transition flex-shrink-0" style="color: <%= @category.color %>40;">
                        <i class="fa-solid fa-pen-to-square"></i>
                      </button>
                    </div>
                    <div class="text-xs font-light flex items-center gap-2" style="color: #657b84;">
                      <span><%= habit.target_count %> <%= habit.target_count == 1 ? 'time' : 'times' %></span>
                      <% if habit.time_of_day.present? && !['anytime', 'any'].include?(habit.time_of_day.downcase) %>
                        <span>â€¢</span>
                        <span><%= habit.time_of_day.downcase == 'night' ? 'Night' : habit.time_of_day.upcase %></span>
                      <% end %>
                    </div>
                  </div>

                  <!-- Streak Badge -->
                  <div class="flex-shrink-0">
                    <% if habit.current_streak > 0 %>
                      <div class="flex flex-col items-center">
                        <div class="text-2xl font-bold display-font" style="color: <%= @category.color %>;" x-text="streak">
                          <%= habit.current_streak %>
                        </div>
                        <div class="text-xs text-gray-500 font-semibold">day streak</div>
                      </div>
                    <% end %>
                  </div>
                </div>

              </div>
            <% end %>
          </div>
      <% else %>
        <div class="bg-white rounded-xl shadow-md p-12 text-center">
          <i class="fa-solid fa-check-circle text-6xl mb-4" style="color: <%= @category.color %>40;"></i>
          <p class="text-gray-500 font-light">No habits yet. Click "Add Habit" to get started!</p>
        </div>
      <% end %>
    </div>
  </main>
</div>
