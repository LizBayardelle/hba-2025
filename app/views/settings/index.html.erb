<div class="flex h-screen relative" style="background: #F5F5F7;">
  <%= render 'shared/sidebar' %>

  <!-- Mobile overlay -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 md:hidden hidden"></div>

  <!-- Menu flag button -->
  <button id="menu-button" class="fixed left-0 z-20 md:hidden rounded-r-lg shadow-lg flex items-center justify-center py-1.5 px-3 transition-all"
    style="top: 200px; background: linear-gradient(135deg, #424245, #2C2C2E); writing-mode: vertical-rl;">
    <span class="text-white font-bold text-sm tracking-wider">MENU</span>
  </button>

  <script>
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const menuButton = document.getElementById('menu-button');
    const closeButton = document.getElementById('sidebar-close');

    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      sidebar.classList.add('translate-x-0');
      overlay.classList.remove('hidden');
      menuButton.classList.add('hidden');
    }

    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      sidebar.classList.remove('translate-x-0');
      overlay.classList.add('hidden');
      menuButton.classList.remove('hidden');
    }

    menuButton.addEventListener('click', openSidebar);
    closeButton.addEventListener('click', closeSidebar);
    overlay.addEventListener('click', closeSidebar);
  </script>

  <!-- Main Content Area -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <%= render 'shared/navbar' %>

    <!-- Scrollable Content -->
    <main class="flex-1 overflow-y-auto p-8" style="background: #F5F5F7;">
      <div class="max-w-3xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
          <h1 class="text-5xl font-display" style="color: #1D1D1F;">Settings</h1>
          <p class="text-sm mt-1" style="color: #8E8E93; font-weight: 300; font-family: 'Inter', sans-serif;">Customize your habit tracking experience</p>
        </div>

        <% if notice %>
          <div class="mb-6 p-4 rounded-lg border-2" style="background-color: #D1FAF0; border-color: #6EE7B7;">
            <p class="text-sm font-semibold" style="color: #065F46;"><%= notice %></p>
          </div>
        <% end %>
        <% if alert %>
          <div class="mb-6 p-4 rounded-lg border-2" style="background-color: #FFE4E6; border-color: #FB7185;">
            <p class="text-sm font-semibold" style="color: #BE123C;"><%= alert %></p>
          </div>
        <% end %>

        <%= form_with model: current_user, url: settings_path, method: :patch, local: false, id: "settings-form" do |f| %>
          <!-- General Settings Card -->
          <div class="bg-white rounded-2xl p-6 mb-6" style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
            <h2 class="text-2xl font-display mb-4" style="color: #1D1D1F;">
              <i class="fa-solid fa-sliders mr-2"></i>General Settings
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Timezone -->
              <div class="setting-group" data-setting="timezone">
                <%= f.label :timezone, class: "block text-sm font-semibold mb-1", style: "color: #1D1D1F;" do %>
                  <i class="fa-solid fa-globe mr-1 text-xs" style="color: #8E8E93;"></i>Time Zone
                <% end %>
                <%= f.select :timezone,
                    ActiveSupport::TimeZone.us_zones.map { |tz| [tz.to_s, tz.name] },
                    {},
                    class: "w-full px-3 py-2 rounded-lg border focus:outline-none transition font-light text-sm auto-save",
                    style: "border-color: #E8EEF1;" %>
              </div>

              <!-- Week Starts On -->
              <div class="setting-group" data-setting="week_starts_on">
                <%= f.label :week_starts_on, class: "block text-sm font-semibold mb-1", style: "color: #1D1D1F;" do %>
                  <i class="fa-solid fa-calendar-week mr-1 text-xs" style="color: #8E8E93;"></i>Week Starts On
                <% end %>
                <%= f.select :week_starts_on,
                    [['Monday', 'monday'], ['Sunday', 'sunday'], ['Saturday', 'saturday']],
                    {},
                    class: "w-full px-3 py-2 rounded-lg border focus:outline-none transition font-light text-sm auto-save",
                    style: "border-color: #E8EEF1;" %>
              </div>

              <!-- Date Format -->
              <div class="setting-group" data-setting="date_format">
                <%= f.label :date_format, class: "block text-sm font-semibold mb-1", style: "color: #1D1D1F;" do %>
                  <i class="fa-solid fa-calendar mr-1 text-xs" style="color: #8E8E93;"></i>Date Format
                <% end %>
                <%= f.select :date_format,
                    [['MM/DD/YYYY', 'MM/DD/YYYY'],
                     ['DD/MM/YYYY', 'DD/MM/YYYY'],
                     ['YYYY-MM-DD', 'YYYY-MM-DD']],
                    {},
                    class: "w-full px-3 py-2 rounded-lg border focus:outline-none transition font-light text-sm auto-save",
                    style: "border-color: #E8EEF1;" %>
              </div>

              <!-- Time Format -->
              <div class="setting-group" data-setting="time_format">
                <%= f.label :time_format, class: "block text-sm font-semibold mb-1", style: "color: #1D1D1F;" do %>
                  <i class="fa-solid fa-clock mr-1 text-xs" style="color: #8E8E93;"></i>Time Format
                <% end %>
                <%= f.select :time_format,
                    [['12-hour (3:45 PM)', '12-hour'], ['24-hour (15:45)', '24-hour']],
                    {},
                    class: "w-full px-3 py-2 rounded-lg border focus:outline-none transition font-light text-sm auto-save",
                    style: "border-color: #E8EEF1;" %>
              </div>

            </div>
          </div>
        <% end %>

        <%= form_with model: current_user, url: settings_path, method: :patch, local: false, id: "settings-form-continued" do |f| %>
          <!-- Display Preferences Card -->
          <div class="bg-white rounded-2xl p-6 mb-6" style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
            <h2 class="text-2xl font-display mb-4" style="color: #1D1D1F;">
              <i class="fa-solid fa-palette mr-2"></i>Display Preferences
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Home Page -->
              <div class="setting-group" data-setting="root_location">
                <%= f.label :root_location, class: "block text-sm font-semibold mb-1", style: "color: #1D1D1F;" do %>
                  <i class="fa-solid fa-home mr-1 text-xs" style="color: #8E8E93;"></i>Home Page
                <% end %>
                <%= f.select :root_location,
                    [['Dashboard', 'dashboard'], ['Habits', 'habits'], ['Analytics', 'analytics']],
                    {},
                    class: "w-full px-3 py-2 rounded-lg border focus:outline-none transition font-light text-sm auto-save",
                    style: "border-color: #E8EEF1;" %>
              </div>

              <!-- Theme -->
              <div class="setting-group" data-setting="theme">
                <%= f.label :theme, class: "block text-sm font-semibold mb-1", style: "color: #1D1D1F;" do %>
                  <i class="fa-solid fa-sun mr-1 text-xs" style="color: #8E8E93;"></i>Theme
                <% end %>
                <%= f.select :theme,
                    [['Light', 'light'], ['Dark', 'dark'], ['Auto (match system)', 'auto']],
                    {},
                    class: "w-full px-3 py-2 rounded-lg border focus:outline-none transition font-light text-sm auto-save",
                    style: "border-color: #E8EEF1;" %>
              </div>
            </div>

            <!-- Default Groupings -->
            <h3 class="text-sm font-semibold mt-5 mb-3" style="color: #1D1D1F;">
              <i class="fa-solid fa-layer-group mr-1 text-xs" style="color: #8E8E93;"></i>Default Groupings
            </h3>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <!-- Default Habits Grouping -->
              <div class="setting-group" data-setting="default_habits_grouping">
                <%= f.label :default_habits_grouping, "Habits", class: "block text-xs font-medium mb-1", style: "color: #8E8E93;" %>
                <%= f.select :default_habits_grouping,
                    [['None', 'none'], ['Category', 'category'], ['Time of Day', 'time'], ['Priority', 'priority']],
                    {},
                    class: "w-full px-3 py-2 rounded-lg border focus:outline-none transition font-light text-sm auto-save",
                    style: "border-color: #E8EEF1;" %>
              </div>

              <!-- Default Tasks Grouping -->
              <div class="setting-group" data-setting="default_tasks_grouping">
                <%= f.label :default_tasks_grouping, "Tasks", class: "block text-xs font-medium mb-1", style: "color: #8E8E93;" %>
                <%= f.select :default_tasks_grouping,
                    [['None', 'none'], ['Date Added', 'status'], ['Category', 'category'], ['Due Date', 'due_date'], ['Importance', 'importance']],
                    {},
                    class: "w-full px-3 py-2 rounded-lg border focus:outline-none transition font-light text-sm auto-save",
                    style: "border-color: #E8EEF1;" %>
              </div>

              <!-- Default Lists Grouping -->
              <div class="setting-group" data-setting="default_lists_grouping">
                <%= f.label :default_lists_grouping, "Lists", class: "block text-xs font-medium mb-1", style: "color: #8E8E93;" %>
                <%= f.select :default_lists_grouping,
                    [['None', 'none'], ['Type', 'type'], ['Category', 'category']],
                    {},
                    class: "w-full px-3 py-2 rounded-lg border focus:outline-none transition font-light text-sm auto-save",
                    style: "border-color: #E8EEF1;" %>
              </div>

              <!-- Default Documents Grouping -->
              <div class="setting-group" data-setting="default_documents_grouping">
                <%= f.label :default_documents_grouping, "Documents", class: "block text-xs font-medium mb-1", style: "color: #8E8E93;" %>
                <%= f.select :default_documents_grouping,
                    [['None', 'none'], ['Type', 'type'], ['Tag', 'tag'], ['Category', 'category']],
                    {},
                    class: "w-full px-3 py-2 rounded-lg border focus:outline-none transition font-light text-sm auto-save",
                    style: "border-color: #E8EEF1;" %>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Importance Levels Card -->
        <div class="bg-white rounded-2xl p-8 mb-6" style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-display" style="color: #1D1D1F;">
              <i class="fa-solid fa-star mr-2"></i>Importance Levels
            </h2>
            <button id="add-importance-level-btn" class="px-4 py-2 rounded-lg text-sm transition transform hover:scale-105" style="background: linear-gradient(135deg, #2C2C2E, #1D1D1F); color: white; font-weight: 600; font-family: 'Inter', sans-serif; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);">
              <i class="fa-solid fa-plus mr-2"></i>Add Level
            </button>
          </div>

          <p class="text-xs font-light mb-6" style="color: #8E8E93;">
            Customize your priority levels for tasks and habits. Drag to reorder.
            <br><strong>Darker colors work best with white text.</strong>
          </p>

          <div id="importance-levels-list" class="space-y-3">
            <!-- Importance levels will be loaded here -->
          </div>
        </div>

        <!-- Time Blocks Card -->
        <div class="bg-white rounded-2xl p-8 mb-6" style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-display" style="color: #1D1D1F;">
              <i class="fa-solid fa-clock mr-2"></i>Time Blocks
            </h2>
            <button id="add-time-block-btn" class="px-4 py-2 rounded-lg text-sm transition transform hover:scale-105" style="background: linear-gradient(135deg, #2C2C2E, #1D1D1F); color: white; font-weight: 600; font-family: 'Inter', sans-serif; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);">
              <i class="fa-solid fa-plus mr-2"></i>Add Time Block
            </button>
          </div>

          <p class="text-xs font-light mb-6" style="color: #8E8E93;">
            Customize your time blocks for organizing habits by time of day. Drag to reorder.
            <br><strong>Darker colors work best with white text.</strong>
          </p>

          <div id="time-blocks-list" class="space-y-3">
            <!-- Time blocks will be loaded here -->
          </div>
        </div>

        <!-- Google Calendar Integration Card -->
        <div class="bg-white rounded-2xl p-8 mb-6" style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
          <h2 class="text-2xl font-display mb-6" style="color: #1D1D1F;">
            <i class="fa-brands fa-google mr-2"></i>Google Calendar Integration
          </h2>

          <% if current_user.google_sync_enabled && current_user.google_refresh_token %>
            <!-- Connected State -->
            <div class="mb-6">
              <div class="flex items-center gap-3 mb-4 p-4 rounded-lg" style="background-color: #D1FAF0; border: 2px solid #6EE7B7;">
                <i class="fa-solid fa-check-circle text-xl" style="color: #065F46;"></i>
                <div class="flex-1">
                  <div class="text-sm font-semibold" style="color: #065F46;">Connected to Google Calendar</div>
                  <div class="text-xs font-light" style="color: #065F46;">Your calendar events will appear on your dashboard</div>
                </div>
              </div>

              <!-- Calendar Selection -->
              <div class="mb-4">
                <label class="block text-sm font-semibold mb-2" style="color: #1D1D1F;">
                  <i class="fa-solid fa-calendar mr-2"></i>Select Calendars
                </label>
                <p class="text-xs font-light mb-3" style="color: #8E8E93;">
                  Choose which Google Calendars to display on your dashboard
                </p>
                <div id="google-calendar-checkboxes" class="space-y-2 p-4 rounded-lg border-2" style="border-color: #E8EEF1;">
                  <p class="text-xs" style="color: #8E8E93;">Loading calendars...</p>
                </div>
              </div>

              <!-- Disconnect Button -->
              <%= button_to google_calendar_disconnect_path, method: :delete, data: { confirm: 'Are you sure you want to disconnect Google Calendar?' }, class: "px-4 py-2 rounded-lg text-sm font-semibold transition hover:bg-red-600", style: "background-color: #FB7185; color: white;" do %>
                <i class="fa-solid fa-unlink mr-2"></i>Disconnect Google Calendar
              <% end %>
            </div>
          <% else %>
            <!-- Not Connected State -->
            <div class="text-center py-8">
              <i class="fa-brands fa-google text-5xl mb-4" style="color: #E8EEF1;"></i>
              <h3 class="text-lg font-semibold mb-2" style="color: #1D1D1F;">Connect Your Google Calendar</h3>
              <p class="text-sm font-light mb-6" style="color: #8E8E93;">
                View your calendar events directly on your dashboard for better planning
              </p>
              <%= link_to google_calendar_connect_path, class: "inline-block px-6 py-3 rounded-lg text-sm transition transform hover:scale-105", style: "background: linear-gradient(135deg, #2C2C2E, #1D1D1F); color: white; font-weight: 600; font-family: 'Inter', sans-serif; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);" do %>
                <i class="fa-brands fa-google mr-2"></i>Connect Google Calendar
              <% end %>
              <p class="text-xs font-light mt-4" style="color: #8E8E93;">
                We'll only request read-only access to your calendar events
              </p>
            </div>
          <% end %>
        </div>

        <!-- Dashboard Layout Card -->
        <div class="bg-white rounded-2xl p-6 mb-6" style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
          <h2 class="text-2xl font-display mb-4" style="color: #1D1D1F;">
            <i class="fa-solid fa-grip mr-2"></i>Dashboard Layout
          </h2>
          <p class="text-xs font-light mb-4" style="color: #8E8E93;">
            Drag to reorder blocks. Choose which column each block appears in.
          </p>

          <div id="dashboard-layout-list" class="space-y-2">
            <!-- Blocks will be loaded here -->
          </div>
        </div>

        <script>
          // Dashboard Layout Management
          (function() {
            const layoutList = document.getElementById('dashboard-layout-list');
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

            const blockLabels = {
              calendar: { name: 'Calendar', icon: 'fa-calendar' },
              quick_links: { name: 'Quick Links', icon: 'fa-link' },
              habits: { name: 'Habits', icon: 'fa-chart-line' },
              tasks: { name: 'Tasks', icon: 'fa-check' }
            };

            let currentLayout = <%= raw (current_user.dashboard_layout.presence || User::DEFAULT_DASHBOARD_LAYOUT).to_json %>;

            function renderLayout() {
              // Sort by position only (maintains drag order)
              const sorted = [...currentLayout].sort((a, b) => a.position - b.position);

              layoutList.innerHTML = sorted.map((item, index) => {
                const block = blockLabels[item.block] || { name: item.block, icon: 'fa-square' };
                return `
                  <div class="flex items-center gap-3 p-3 rounded-lg border bg-white cursor-grab active:cursor-grabbing"
                       style="border-color: #E8EEF1;"
                       draggable="true"
                       data-block="${item.block}">
                    <i class="fa-solid fa-grip-vertical" style="color: #C7C7CC;"></i>
                    <i class="fa-solid ${block.icon} w-5 text-center" style="color: #8E8E93;"></i>
                    <span class="flex-1 text-sm font-medium" style="color: #1D1D1F;">${block.name}</span>
                    <select class="column-select px-3 py-1.5 rounded-lg border text-sm"
                            style="border-color: #E8EEF1;"
                            data-block="${item.block}">
                      <option value="left" ${item.column === 'left' ? 'selected' : ''}>Left Column</option>
                      <option value="right" ${item.column === 'right' ? 'selected' : ''}>Right Column</option>
                      <option value="full" ${item.column === 'full' ? 'selected' : ''}>Full Width</option>
                    </select>
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" class="visible-checkbox w-4 h-4 rounded"
                             data-block="${item.block}"
                             ${item.visible !== false ? 'checked' : ''}>
                      <span class="text-xs" style="color: #8E8E93;">Show</span>
                    </label>
                  </div>
                `;
              }).join('');

              // Add event listeners
              attachEventListeners();
            }

            function attachEventListeners() {
              // Column select changes
              layoutList.querySelectorAll('.column-select').forEach(select => {
                select.addEventListener('change', (e) => {
                  const block = e.target.dataset.block;
                  const item = currentLayout.find(i => i.block === block);
                  if (item) {
                    item.column = e.target.value;
                    saveLayout();
                  }
                });
              });

              // Visibility checkbox changes
              layoutList.querySelectorAll('.visible-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                  const block = e.target.dataset.block;
                  const item = currentLayout.find(i => i.block === block);
                  if (item) {
                    item.visible = e.target.checked;
                    saveLayout();
                  }
                });
              });

              // Drag and drop
              const items = layoutList.querySelectorAll('[draggable="true"]');
              items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
              });
            }

            let draggedItem = null;

            function handleDragStart(e) {
              draggedItem = e.target;
              e.target.style.opacity = '0.5';
            }

            function handleDragOver(e) {
              e.preventDefault();
              const target = e.target.closest('[draggable="true"]');
              if (target && target !== draggedItem) {
                target.style.borderColor = '#2C2C2E';
              }
            }

            function handleDrop(e) {
              e.preventDefault();
              const target = e.target.closest('[draggable="true"]');
              if (target && target !== draggedItem) {
                const allItems = [...layoutList.querySelectorAll('[draggable="true"]')];
                const draggedIndex = allItems.indexOf(draggedItem);
                const targetIndex = allItems.indexOf(target);

                // Reorder in DOM
                if (draggedIndex < targetIndex) {
                  target.parentNode.insertBefore(draggedItem, target.nextSibling);
                } else {
                  target.parentNode.insertBefore(draggedItem, target);
                }

                // Update positions in currentLayout
                const newOrder = [...layoutList.querySelectorAll('[draggable="true"]')].map(el => el.dataset.block);
                newOrder.forEach((block, index) => {
                  const item = currentLayout.find(i => i.block === block);
                  if (item) item.position = index;
                });

                saveLayout();
              }
              target.style.borderColor = '#E8EEF1';
            }

            function handleDragEnd(e) {
              e.target.style.opacity = '1';
              layoutList.querySelectorAll('[draggable="true"]').forEach(item => {
                item.style.borderColor = '#E8EEF1';
              });
            }

            function saveLayout() {
              fetch('/settings', {
                method: 'PATCH',
                headers: {
                  'X-CSRF-Token': csrfToken,
                  'Content-Type': 'application/json',
                  'Accept': 'application/json'
                },
                body: JSON.stringify({ user: { dashboard_layout: currentLayout } })
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  showNotification('Layout saved');
                }
              })
              .catch(error => console.error('Error saving layout:', error));
            }

            function showNotification(message) {
              const existing = layoutList.parentElement.querySelector('.layout-notification');
              if (existing) existing.remove();

              const notification = document.createElement('div');
              notification.className = 'layout-notification mt-3 p-2 rounded-lg border-2 text-xs font-semibold';
              notification.style.cssText = 'background-color: #D1FAF0; border-color: #6EE7B7; color: #065F46;';
              notification.innerHTML = '<i class="fa-solid fa-check mr-1"></i>' + message;
              layoutList.parentElement.appendChild(notification);

              setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
              }, 3000);
            }

            // Initial render
            renderLayout();
          })();
        </script>

        <script>
          // Load and handle Google Calendar selection
          <% if current_user.google_sync_enabled && current_user.google_refresh_token %>
            document.addEventListener('DOMContentLoaded', () => {
              const calendarCheckboxes = document.getElementById('google-calendar-checkboxes');
              const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
              const selectedCalendarIds = <%= raw current_user.google_calendar_id.to_json %>;

              // Fetch available calendars
              fetch('/google_calendar/calendars', {
                headers: { 'Accept': 'application/json' }
              })
              .then(response => response.json())
              .then(data => {
                if (data.calendars && data.calendars.length > 0) {
                  calendarCheckboxes.innerHTML = data.calendars.map(cal => {
                    const isChecked = selectedCalendarIds.includes(cal.id);
                    return `
                      <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition" style="border: 1px solid #E8EEF1;">
                        <input type="checkbox"
                               value="${cal.id}"
                               class="calendar-checkbox w-4 h-4 rounded"
                               ${isChecked ? 'checked' : ''}>
                        <span class="flex-1 text-sm" style="color: #1D1D1F;">
                          ${cal.name}${cal.primary ? ' <span class="text-xs font-light" style="color: #8E8E93;">(Primary)</span>' : ''}
                        </span>
                      </label>
                    `;
                  }).join('');

                  // Handle checkbox changes
                  const checkboxes = calendarCheckboxes.querySelectorAll('.calendar-checkbox');
                  checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                      const selectedIds = Array.from(checkboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                      fetch('/google_calendar/select', {
                        method: 'PATCH',
                        headers: {
                          'X-CSRF-Token': csrfToken,
                          'Content-Type': 'application/json',
                          'Accept': 'application/json'
                        },
                        body: JSON.stringify({ calendar_ids: selectedIds })
                      })
                      .then(response => response.json())
                      .then(data => {
                        if (data.success) {
                          // Show success notification
                          const existingNotif = calendarCheckboxes.parentElement.querySelector('.calendar-notification');
                          if (existingNotif) existingNotif.remove();

                          const notification = document.createElement('div');
                          notification.className = 'calendar-notification mt-2 p-2 rounded-lg border-2 text-xs font-semibold';
                          notification.style.cssText = 'background-color: #D1FAF0; border-color: #6EE7B7; color: #065F46;';
                          notification.innerHTML = '<i class="fa-solid fa-check mr-1"></i>Calendars updated';
                          calendarCheckboxes.parentElement.appendChild(notification);

                          setTimeout(() => notification.remove(), 3000);
                        }
                      })
                      .catch(error => console.error('Error updating calendars:', error));
                    });
                  });
                } else {
                  calendarCheckboxes.innerHTML = '<p class="text-xs" style="color: #8E8E93;">No calendars found</p>';
                }
              })
              .catch(error => {
                console.error('Error fetching calendars:', error);
                calendarCheckboxes.innerHTML = '<p class="text-xs text-red-600">Error loading calendars</p>';
              });
            });
          <% end %>
        </script>

        <!-- Add/Edit Time Block Modal -->
        <div id="time-block-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 id="time-block-modal-title" class="text-xl font-display mb-6" style="color: #1D1D1F;">Add Time Block</h3>

            <form id="time-block-form">
              <input type="hidden" id="time-block-id">

              <div class="mb-4">
                <label class="block text-sm font-semibold mb-2" style="color: #1D1D1F;">Name</label>
                <input type="text" id="time-block-name" class="w-full px-4 py-3 rounded-lg border-2 focus:outline-none" style="border-color: #E8EEF1;" required>
              </div>

              <div class="mb-4">
                <label class="block text-sm font-semibold mb-2" style="color: #1D1D1F;">Icon</label>
                <input type="hidden" id="time-block-icon" required>

                <!-- Icon Picker Grid (time-specific icons) -->
                <div id="time-block-icon-picker" class="p-3 rounded-lg border-2 bg-white max-h-64 overflow-y-auto flex flex-wrap gap-2" style="border-color: #E8EEF1; display: grid; grid-template-columns: repeat(12, minmax(0, 1fr));">
                  <!-- Row 1: Time & Sky -->
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-sun">
                    <i class="fa-solid fa-sun text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-cloud-sun">
                    <i class="fa-solid fa-cloud-sun text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-moon">
                    <i class="fa-solid fa-moon text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-cloud-moon">
                    <i class="fa-solid fa-cloud-moon text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-regular fa-sun">
                    <i class="fa-regular fa-sun text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-regular fa-moon">
                    <i class="fa-regular fa-moon text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-cloud">
                    <i class="fa-solid fa-cloud text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-star">
                    <i class="fa-solid fa-star text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-snowflake">
                    <i class="fa-solid fa-snowflake text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-rainbow">
                    <i class="fa-solid fa-rainbow text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-meteor">
                    <i class="fa-solid fa-meteor text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-bolt">
                    <i class="fa-solid fa-bolt text-sm"></i>
                  </button>

                  <!-- Row 2: Clocks & Time -->
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-clock">
                    <i class="fa-solid fa-clock text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-regular fa-clock">
                    <i class="fa-regular fa-clock text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-stopwatch">
                    <i class="fa-solid fa-stopwatch text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-hourglass">
                    <i class="fa-solid fa-hourglass text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-hourglass-half">
                    <i class="fa-solid fa-hourglass-half text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-hourglass-end">
                    <i class="fa-solid fa-hourglass-end text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-bell-concierge">
                    <i class="fa-solid fa-bell-concierge text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-calendar">
                    <i class="fa-solid fa-calendar text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-calendar-day">
                    <i class="fa-solid fa-calendar-day text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-calendar-week">
                    <i class="fa-solid fa-calendar-week text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-regular fa-calendar">
                    <i class="fa-regular fa-calendar text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-watch">
                    <i class="fa-solid fa-watch text-sm"></i>
                  </button>

                  <!-- Row 3: Activities & Lifestyle -->
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-mug-hot">
                    <i class="fa-solid fa-mug-hot text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-coffee">
                    <i class="fa-solid fa-coffee text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-bed">
                    <i class="fa-solid fa-bed text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-utensils">
                    <i class="fa-solid fa-utensils text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-plate-wheat">
                    <i class="fa-solid fa-plate-wheat text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-bowl-rice">
                    <i class="fa-solid fa-bowl-rice text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-pizza-slice">
                    <i class="fa-solid fa-pizza-slice text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-champagne-glasses">
                    <i class="fa-solid fa-champagne-glasses text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-dumbbell">
                    <i class="fa-solid fa-dumbbell text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-person-running">
                    <i class="fa-solid fa-person-running text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-person-walking">
                    <i class="fa-solid fa-person-walking text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-spa">
                    <i class="fa-solid fa-spa text-sm"></i>
                  </button>

                  <!-- Row 4: Places & Context -->
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-home">
                    <i class="fa-solid fa-home text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-briefcase">
                    <i class="fa-solid fa-briefcase text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-school">
                    <i class="fa-solid fa-school text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-building">
                    <i class="fa-solid fa-building text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-car">
                    <i class="fa-solid fa-car text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-plane">
                    <i class="fa-solid fa-plane text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-bell">
                    <i class="fa-solid fa-bell text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-laptop">
                    <i class="fa-solid fa-laptop text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-book">
                    <i class="fa-solid fa-book text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-music">
                    <i class="fa-solid fa-music text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-gamepad">
                    <i class="fa-solid fa-gamepad text-sm"></i>
                  </button>
                  <button type="button" class="time-block-icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-tv">
                    <i class="fa-solid fa-tv text-sm"></i>
                  </button>
                </div>
              </div>

              <div class="mb-6">
                <label class="block text-sm font-semibold mb-2" style="color: #1D1D1F;">Color</label>
                <input type="color" id="time-block-color" class="w-full h-12 rounded-lg border-2 cursor-pointer" style="border-color: #E8EEF1;">
              </div>

              <div class="flex gap-3">
                <button type="button" id="cancel-time-block-modal-btn" class="flex-1 px-4 py-3 rounded-lg border-2 font-semibold transition hover:bg-gray-50" style="border-color: #E8EEF1; color: #1D1D1F;">
                  Cancel
                </button>
                <button type="submit" class="flex-1 px-4 py-3 rounded-lg font-semibold transition hover:opacity-80" style="background: linear-gradient(135deg, #2C2C2E, #1D1D1F); color: white;">
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Add/Edit Importance Level Modal -->
        <div id="importance-level-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-xl font-display mb-6" style="color: #1D1D1F;">Add Importance Level</h3>

            <form id="importance-level-form">
              <input type="hidden" id="importance-level-id">

              <div class="mb-4">
                <label class="block text-sm font-semibold mb-2" style="color: #1D1D1F;">Name</label>
                <input type="text" id="importance-level-name" class="w-full px-4 py-3 rounded-lg border-2 focus:outline-none" style="border-color: #E8EEF1;" required>
              </div>

              <div class="mb-4">
                <label class="block text-sm font-semibold mb-2" style="color: #1D1D1F;">Icon</label>
                <input type="hidden" id="importance-level-icon" required>

                <!-- Icon Picker Grid (always visible) -->
                <div id="icon-picker" class="p-3 rounded-lg border-2 bg-white max-h-48 overflow-y-auto flex flex-wrap gap-2" style="border-color: #E8EEF1; display: grid; grid-template-columns: repeat(12, minmax(0, 1fr));">
                  <!-- Exclamation & Alerts -->
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-circle-exclamation">
                    <i class="fa-solid fa-circle-exclamation text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-triangle-exclamation">
                    <i class="fa-solid fa-triangle-exclamation text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-exclamation">
                    <i class="fa-solid fa-exclamation text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-question">
                    <i class="fa-solid fa-question text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-circle-question">
                    <i class="fa-solid fa-circle-question text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-info">
                    <i class="fa-solid fa-info text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-circle-info">
                    <i class="fa-solid fa-circle-info text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-xmark">
                    <i class="fa-solid fa-xmark text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-circle-xmark">
                    <i class="fa-solid fa-circle-xmark text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-ban">
                    <i class="fa-solid fa-ban text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-skull-crossbones">
                    <i class="fa-solid fa-skull-crossbones text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-radiation">
                    <i class="fa-solid fa-radiation text-sm"></i>
                  </button>

                  <!-- Energy & Urgency -->
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-fire">
                    <i class="fa-solid fa-fire text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-bolt">
                    <i class="fa-solid fa-bolt text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-bolt-lightning">
                    <i class="fa-solid fa-bolt-lightning text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-bomb">
                    <i class="fa-solid fa-bomb text-sm"></i>
                  </button>

                  <!-- Stars & Priority -->
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-star">
                    <i class="fa-solid fa-star text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-star-half-stroke">
                    <i class="fa-solid fa-star-half-stroke text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-regular fa-star">
                    <i class="fa-regular fa-star text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-certificate">
                    <i class="fa-solid fa-certificate text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-award">
                    <i class="fa-solid fa-award text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-medal">
                    <i class="fa-solid fa-medal text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-trophy">
                    <i class="fa-solid fa-trophy text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-crown">
                    <i class="fa-solid fa-crown text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-ranking-star">
                    <i class="fa-solid fa-ranking-star text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-check">
                    <i class="fa-solid fa-check text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-circle-check">
                    <i class="fa-solid fa-circle-check text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-square-check">
                    <i class="fa-solid fa-square-check text-sm"></i>
                  </button>

                  <!-- Markers & Flags -->
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-flag">
                    <i class="fa-solid fa-flag text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-bookmark">
                    <i class="fa-solid fa-bookmark text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-bullseye">
                    <i class="fa-solid fa-bullseye text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-location-pin">
                    <i class="fa-solid fa-location-pin text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-thumbtack">
                    <i class="fa-solid fa-thumbtack text-sm"></i>
                  </button>

                  <!-- Shapes -->
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-circle">
                    <i class="fa-solid fa-circle text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-square">
                    <i class="fa-solid fa-square text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-diamond">
                    <i class="fa-solid fa-diamond text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-heart">
                    <i class="fa-solid fa-heart text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-gem">
                    <i class="fa-solid fa-gem text-sm"></i>
                  </button>

                  <!-- Arrows & Direction -->
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-angles-up">
                    <i class="fa-solid fa-angles-up text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-angle-up">
                    <i class="fa-solid fa-angle-up text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-chevron-up">
                    <i class="fa-solid fa-chevron-up text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-arrow-up">
                    <i class="fa-solid fa-arrow-up text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-circle-up">
                    <i class="fa-solid fa-circle-up text-sm"></i>
                  </button>

                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-minus">
                    <i class="fa-solid fa-minus text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-equals">
                    <i class="fa-solid fa-equals text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-circle-dot">
                    <i class="fa-solid fa-circle-dot text-sm"></i>
                  </button>

                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-angle-down">
                    <i class="fa-solid fa-angle-down text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-angles-down">
                    <i class="fa-solid fa-angles-down text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-chevron-down">
                    <i class="fa-solid fa-chevron-down text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-arrow-down">
                    <i class="fa-solid fa-arrow-down text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-circle-down">
                    <i class="fa-solid fa-circle-down text-sm"></i>
                  </button>

                  <!-- Numbers -->
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-0">
                    <i class="fa-solid fa-0 text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-1">
                    <i class="fa-solid fa-1 text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-2">
                    <i class="fa-solid fa-2 text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-3">
                    <i class="fa-solid fa-3 text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-4">
                    <i class="fa-solid fa-4 text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-5">
                    <i class="fa-solid fa-5 text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-6">
                    <i class="fa-solid fa-6 text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-7">
                    <i class="fa-solid fa-7 text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-8">
                    <i class="fa-solid fa-8 text-sm"></i>
                  </button>
                  <button type="button" class="icon-option w-8 h-8 rounded-lg border-2 hover:bg-gray-100 transition flex items-center justify-center" style="border-color: #E8EEF1;" data-icon="fa-solid fa-9">
                    <i class="fa-solid fa-9 text-sm"></i>
                  </button>
                </div>
              </div>

              <div class="mb-6">
                <label class="block text-sm font-semibold mb-2" style="color: #1D1D1F;">Color</label>
                <input type="color" id="importance-level-color" class="w-full h-12 rounded-lg border-2 cursor-pointer" style="border-color: #E8EEF1;">
              </div>

              <div class="flex gap-3">
                <button type="button" id="cancel-modal-btn" class="flex-1 px-4 py-3 rounded-lg border-2 font-semibold transition hover:bg-gray-50" style="border-color: #E8EEF1; color: #1D1D1F;">
                  Cancel
                </button>
                <button type="submit" class="flex-1 px-4 py-3 rounded-lg font-semibold transition hover:opacity-80" style="background: linear-gradient(135deg, #2C2C2E, #1D1D1F); color: white;">
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>

        <script>
          // Auto-save settings functionality
          const autoSaveElements = document.querySelectorAll('.auto-save');

          autoSaveElements.forEach(element => {
            element.addEventListener('change', function(e) {
              const settingGroup = e.target.closest('.setting-group');
              const form = e.target.closest('form');
              const formData = new FormData(form);

              // Get CSRF token
              const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

              fetch(form.action, {
                method: 'PATCH',
                headers: {
                  'X-CSRF-Token': csrfToken,
                  'Accept': 'application/json'
                },
                body: formData
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  showSuccessNotification(settingGroup);
                } else {
                  showErrorNotification(settingGroup, data.message);
                }
              })
              .catch(error => {
                showErrorNotification(settingGroup, 'An error occurred while saving.');
              });
            });
          });

          function showSuccessNotification(settingGroup) {
            // Remove any existing notifications in this group
            const existingNotif = settingGroup.querySelector('.success-notification');
            if (existingNotif) {
              existingNotif.remove();
            }

            // Create success notification
            const notification = document.createElement('div');
            notification.className = 'success-notification mt-2 p-2 rounded-lg border-2 text-xs font-semibold transition-opacity duration-300';
            notification.style.cssText = 'background-color: #D1FAF0; border-color: #6EE7B7; color: #065F46;';
            notification.innerHTML = '<i class="fa-solid fa-check mr-1"></i>Saved';

            settingGroup.appendChild(notification);

            // Fade out and remove after 3 seconds
            setTimeout(() => {
              notification.style.opacity = '0';
              setTimeout(() => notification.remove(), 300);
            }, 3000);
          }

          function showErrorNotification(settingGroup, message) {
            // Remove any existing notifications in this group
            const existingNotif = settingGroup.querySelector('.error-notification');
            if (existingNotif) {
              existingNotif.remove();
            }

            // Create error notification
            const notification = document.createElement('div');
            notification.className = 'error-notification mt-2 p-2 rounded-lg border-2 text-xs font-semibold transition-opacity duration-300';
            notification.style.cssText = 'background-color: #FFE4E6; border-color: #FB7185; color: #BE123C;';
            notification.innerHTML = `<i class="fa-solid fa-exclamation-circle mr-1"></i>${message}`;

            settingGroup.appendChild(notification);

            // Fade out and remove after 5 seconds
            setTimeout(() => {
              notification.style.opacity = '0';
              setTimeout(() => notification.remove(), 300);
            }, 5000);
          }

          // Importance Levels Management
          const modal = document.getElementById('importance-level-modal');
          const modalTitle = document.getElementById('modal-title');
          const modalForm = document.getElementById('importance-level-form');
          const addBtn = document.getElementById('add-importance-level-btn');
          const cancelBtn = document.getElementById('cancel-modal-btn');
          const levelsList = document.getElementById('importance-levels-list');
          let importanceLevels = [];
          const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

          // Load importance levels
          function loadImportanceLevels() {
            fetch('/settings/importance_levels', {
              headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
              importanceLevels = data;
              renderImportanceLevels();
            });
          }

          function renderImportanceLevels() {
            levelsList.innerHTML = importanceLevels.map(level => {
              const isOptional = level.name === 'Optional';
              return `
              <div class="flex items-center gap-4 p-4 rounded-lg border-2 bg-gray-50 hover:bg-gray-100 transition" style="border-color: #E8EEF1;" data-level-id="${level.id}">
                <div class="cursor-move text-gray-400">
                  <i class="fa-solid fa-grip-vertical"></i>
                </div>
                <div class="text-xl" style="color: ${level.color};">
                  <i class="${level.icon || 'fa-solid fa-star'}"></i>
                </div>
                <div class="flex-1">
                  <div class="font-semibold" style="color: #1D1D1F;">${level.name}${isOptional ? ' <span class="text-xs font-normal" style="color: #8E8E93;">(default)</span>' : ''}</div>
                  <div class="text-xs font-light" style="color: #8E8E93;">Rank: ${level.rank}</div>
                </div>
                <div class="w-8 h-8 rounded border-2" style="background-color: ${level.color}; border-color: #E8EEF1;"></div>
                <button onclick="editImportanceLevel(${level.id})" class="px-3 py-2 rounded-lg text-sm font-semibold transition hover:bg-gray-200">
                  <i class="fa-solid fa-edit"></i>
                </button>
                ${isOptional ? '' : `<button onclick="deleteImportanceLevel(${level.id})" class="px-3 py-2 rounded-lg text-sm font-semibold transition hover:bg-red-100 text-red-600">
                  <i class="fa-solid fa-trash"></i>
                </button>`}
              </div>
            `}).join('');
          }

          // Icon picker functionality
          const iconPicker = document.getElementById('icon-picker');
          const iconInput = document.getElementById('importance-level-icon');
          const iconOptions = document.querySelectorAll('.icon-option');

          iconOptions.forEach(option => {
            option.addEventListener('click', function() {
              const iconClass = this.getAttribute('data-icon');
              iconInput.value = iconClass;

              // Remove selected state from all options
              iconOptions.forEach(opt => {
                opt.classList.remove('bg-blue-100', 'border-blue-500');
                opt.style.borderColor = '#E8EEF1';
              });
              // Add selected state to this option
              this.classList.add('bg-blue-100', 'border-blue-500');
              this.style.borderColor = '#6366F1';
            });
          });

          // Open modal for adding
          addBtn.addEventListener('click', () => {
            modalTitle.textContent = 'Add Importance Level';
            modalForm.reset();
            document.getElementById('importance-level-id').value = '';
            const nameInput = document.getElementById('importance-level-name');
            nameInput.disabled = false;
            nameInput.style.backgroundColor = '';
            nameInput.style.cursor = '';
            iconOptions.forEach(opt => {
              opt.classList.remove('bg-blue-100', 'border-blue-500');
              opt.style.borderColor = '#E8EEF1';
            });
            modal.classList.remove('hidden');
          });

          // Edit importance level
          window.editImportanceLevel = function(id) {
            const level = importanceLevels.find(l => l.id === id);
            if (!level) return;

            const isOptional = level.name === 'Optional';
            const nameInput = document.getElementById('importance-level-name');

            modalTitle.textContent = isOptional ? 'Edit Optional Level' : 'Edit Importance Level';
            document.getElementById('importance-level-id').value = level.id;
            nameInput.value = level.name;
            nameInput.disabled = isOptional;
            nameInput.style.backgroundColor = isOptional ? '#F5F5F7' : '';
            nameInput.style.cursor = isOptional ? 'not-allowed' : '';
            document.getElementById('importance-level-icon').value = level.icon || '';
            document.getElementById('importance-level-color').value = level.color || '#000000';

            // Highlight selected icon in picker
            iconOptions.forEach(opt => {
              opt.classList.remove('bg-blue-100', 'border-blue-500');
              opt.style.borderColor = '#E8EEF1';
              if (level.icon && opt.getAttribute('data-icon') === level.icon) {
                opt.classList.add('bg-blue-100', 'border-blue-500');
                opt.style.borderColor = '#6366F1';
              }
            });

            modal.classList.remove('hidden');
          };

          // Delete importance level
          window.deleteImportanceLevel = function(id) {
            const level = importanceLevels.find(l => l.id === id);
            if (level && level.name === 'Optional') {
              alert('The Optional importance level cannot be deleted.');
              return;
            }
            if (!confirm('Are you sure you want to delete this importance level?')) return;

            fetch(`/settings/importance_levels/${id}`, {
              method: 'DELETE',
              headers: {
                'X-CSRF-Token': csrfToken,
                'Accept': 'application/json'
              }
            })
            .then(response => {
              if (!response.ok) {
                return response.json().then(data => { throw new Error(data.errors ? data.errors.join(', ') : 'Error deleting'); });
              }
              return response.json();
            })
            .then(() => loadImportanceLevels())
            .catch(error => alert(error.message || 'Error deleting importance level'));
          };

          // Close modal
          cancelBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
          });

          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.classList.add('hidden');
            }
          });

          // Save importance level
          modalForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const id = document.getElementById('importance-level-id').value;
            const name = document.getElementById('importance-level-name').value;
            const icon = document.getElementById('importance-level-icon').value;
            const color = document.getElementById('importance-level-color').value;
            const rank = id ? importanceLevels.find(l => l.id == id).rank : (Math.max(...importanceLevels.map(l => l.rank), 0) + 1);

            const url = id ? `/settings/importance_levels/${id}` : '/settings/importance_levels';
            const method = id ? 'PATCH' : 'POST';

            fetch(url, {
              method: method,
              headers: {
                'X-CSRF-Token': csrfToken,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({
                importance_level: { name, icon, color, rank }
              })
            })
            .then(response => response.json())
            .then(() => {
              loadImportanceLevels();
              modal.classList.add('hidden');
            })
            .catch(error => alert('Error saving importance level'));
          });

          // Load on page load
          loadImportanceLevels();

          // Drag and drop functionality
          let draggedElement = null;
          let draggedId = null;

          function initializeDragAndDrop() {
            const levelItems = document.querySelectorAll('[data-level-id]');

            levelItems.forEach(item => {
              item.setAttribute('draggable', 'true');

              item.addEventListener('dragstart', function(e) {
                draggedElement = this;
                draggedId = this.getAttribute('data-level-id');
                this.style.opacity = '0.5';
                e.dataTransfer.effectAllowed = 'move';
              });

              item.addEventListener('dragend', function(e) {
                this.style.opacity = '1';
                // Remove all drag indicators
                levelItems.forEach(level => {
                  level.style.borderColor = '#E8EEF1';
                });
              });

              item.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'move';

                if (draggedElement && draggedElement !== this) {
                  this.style.borderColor = '#8E8E93';
                }
              });

              item.addEventListener('dragleave', function(e) {
                // Only reset if we're actually leaving this element
                if (!this.contains(e.relatedTarget)) {
                  this.style.borderColor = '#E8EEF1';
                }
              });

              item.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '#E8EEF1';

                if (draggedElement && draggedElement !== this) {
                  const allLevels = Array.from(levelsList.children);
                  const draggedIndex = allLevels.indexOf(draggedElement);
                  const targetIndex = allLevels.indexOf(this);

                  // Remove the dragged element first
                  draggedElement.remove();

                  // Insert at the correct position
                  if (draggedIndex < targetIndex) {
                    this.after(draggedElement);
                  } else {
                    this.before(draggedElement);
                  }

                  // Update ranks based on new order
                  updateRanksAfterDrag();
                }
              });
            });
          }

          function updateRanksAfterDrag() {
            const levelItems = Array.from(document.querySelectorAll('[data-level-id]'));
            const updates = levelItems.map((item, index) => {
              const id = item.getAttribute('data-level-id');
              const level = importanceLevels.find(l => l.id == id);
              return {
                id: id,
                rank: index + 1,
                level: level
              };
            });

            // Update ranks sequentially with temporary values first to avoid conflicts
            // First, set all to negative temporary values
            const tempUpdates = updates.map(update => {
              return fetch(`/settings/importance_levels/${update.id}`, {
                method: 'PATCH',
                headers: {
                  'X-CSRF-Token': csrfToken,
                  'Content-Type': 'application/json',
                  'Accept': 'application/json'
                },
                body: JSON.stringify({
                  importance_level: {
                    name: update.level.name,
                    icon: update.level.icon,
                    color: update.level.color,
                    rank: -(parseInt(update.id) + 1000)
                  }
                })
              });
            });

            // Then set final values
            Promise.all(tempUpdates)
              .then(() => {
                return Promise.all(updates.map(update => {
                  return fetch(`/settings/importance_levels/${update.id}`, {
                    method: 'PATCH',
                    headers: {
                      'X-CSRF-Token': csrfToken,
                      'Content-Type': 'application/json',
                      'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                      importance_level: {
                        name: update.level.name,
                        icon: update.level.icon,
                        color: update.level.color,
                        rank: update.rank
                      }
                    })
                  });
                }));
              })
              .then(() => loadImportanceLevels())
              .catch(error => alert('Error updating ranks'));
          }

          // Re-initialize drag and drop after rendering
          const originalRender = renderImportanceLevels;
          renderImportanceLevels = function() {
            originalRender();
            initializeDragAndDrop();
          };

          // ===== TIME BLOCKS MANAGEMENT =====
          const timeBlockModal = document.getElementById('time-block-modal');
          const timeBlockModalTitle = document.getElementById('time-block-modal-title');
          const timeBlockForm = document.getElementById('time-block-form');
          const addTimeBlockBtn = document.getElementById('add-time-block-btn');
          const cancelTimeBlockBtn = document.getElementById('cancel-time-block-modal-btn');
          const timeBlocksList = document.getElementById('time-blocks-list');
          let timeBlocks = [];

          // Load time blocks
          function loadTimeBlocks() {
            fetch('/settings/time_blocks', {
              headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
              timeBlocks = data;
              renderTimeBlocks();
            });
          }

          function renderTimeBlocks() {
            timeBlocksList.innerHTML = timeBlocks.map(block => `
              <div class="flex items-center gap-4 p-4 rounded-lg border-2 bg-gray-50 hover:bg-gray-100 transition" style="border-color: #E8EEF1;" data-block-id="${block.id}">
                <div class="cursor-move text-gray-400">
                  <i class="fa-solid fa-grip-vertical"></i>
                </div>
                <div class="text-xl" style="color: ${block.color};">
                  <i class="${block.icon || 'fa-solid fa-clock'}"></i>
                </div>
                <div class="flex-1">
                  <div class="font-semibold" style="color: #1D1D1F;">${block.name}</div>
                  <div class="text-xs font-light" style="color: #8E8E93;">Rank: ${block.rank}</div>
                </div>
                <div class="w-8 h-8 rounded border-2" style="background-color: ${block.color}; border-color: #E8EEF1;"></div>
                <button onclick="editTimeBlock(${block.id})" class="px-3 py-2 rounded-lg text-sm font-semibold transition hover:bg-gray-200">
                  <i class="fa-solid fa-edit"></i>
                </button>
                <button onclick="deleteTimeBlock(${block.id})" class="px-3 py-2 rounded-lg text-sm font-semibold transition hover:bg-red-100 text-red-600">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            `).join('');
            initializeTimeBlockDragAndDrop();
          }

          // Icon picker for time blocks
          const timeBlockIconPicker = document.getElementById('time-block-icon-picker');
          const timeBlockIconInput = document.getElementById('time-block-icon');
          const timeBlockIconOptions = document.querySelectorAll('.time-block-icon-option');

          timeBlockIconOptions.forEach(option => {
            option.addEventListener('click', function() {
              const iconClass = this.getAttribute('data-icon');
              timeBlockIconInput.value = iconClass;

              timeBlockIconOptions.forEach(opt => {
                opt.classList.remove('bg-blue-100', 'border-blue-500');
                opt.style.borderColor = '#E8EEF1';
              });
              this.classList.add('bg-blue-100', 'border-blue-500');
              this.style.borderColor = '#6366F1';
            });
          });

          // Open modal for adding
          addTimeBlockBtn.addEventListener('click', () => {
            timeBlockModalTitle.textContent = 'Add Time Block';
            timeBlockForm.reset();
            document.getElementById('time-block-id').value = '';
            timeBlockIconOptions.forEach(opt => {
              opt.classList.remove('bg-blue-100', 'border-blue-500');
              opt.style.borderColor = '#E8EEF1';
            });
            timeBlockModal.classList.remove('hidden');
          });

          // Edit time block
          window.editTimeBlock = function(id) {
            const block = timeBlocks.find(b => b.id === id);
            if (!block) return;

            timeBlockModalTitle.textContent = 'Edit Time Block';
            document.getElementById('time-block-id').value = block.id;
            document.getElementById('time-block-name').value = block.name;
            document.getElementById('time-block-icon').value = block.icon || '';
            document.getElementById('time-block-color').value = block.color || '#000000';

            timeBlockIconOptions.forEach(opt => {
              opt.classList.remove('bg-blue-100', 'border-blue-500');
              opt.style.borderColor = '#E8EEF1';
              if (block.icon && opt.getAttribute('data-icon') === block.icon) {
                opt.classList.add('bg-blue-100', 'border-blue-500');
                opt.style.borderColor = '#6366F1';
              }
            });

            timeBlockModal.classList.remove('hidden');
          };

          // Delete time block
          window.deleteTimeBlock = function(id) {
            if (!confirm('Are you sure you want to delete this time block?')) return;

            fetch(`/settings/time_blocks/${id}`, {
              method: 'DELETE',
              headers: {
                'X-CSRF-Token': csrfToken,
                'Accept': 'application/json'
              }
            })
            .then(response => response.json())
            .then(() => loadTimeBlocks())
            .catch(error => alert('Error deleting time block'));
          };

          // Close modal
          cancelTimeBlockBtn.addEventListener('click', () => {
            timeBlockModal.classList.add('hidden');
          });

          timeBlockModal.addEventListener('click', (e) => {
            if (e.target === timeBlockModal) {
              timeBlockModal.classList.add('hidden');
            }
          });

          // Save time block
          timeBlockForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const id = document.getElementById('time-block-id').value;
            const name = document.getElementById('time-block-name').value;
            const icon = document.getElementById('time-block-icon').value;
            const color = document.getElementById('time-block-color').value;
            const rank = id ? timeBlocks.find(b => b.id == id).rank : (Math.max(...timeBlocks.map(b => b.rank), 0) + 1);

            const url = id ? `/settings/time_blocks/${id}` : '/settings/time_blocks';
            const method = id ? 'PATCH' : 'POST';

            fetch(url, {
              method: method,
              headers: {
                'X-CSRF-Token': csrfToken,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({
                time_block: { name, icon, color, rank }
              })
            })
            .then(response => response.json())
            .then(() => {
              loadTimeBlocks();
              timeBlockModal.classList.add('hidden');
            })
            .catch(error => alert('Error saving time block'));
          });

          // Drag and drop for time blocks
          function initializeTimeBlockDragAndDrop() {
            const blockItems = document.querySelectorAll('[data-block-id]');
            let draggedBlockElement = null;

            blockItems.forEach(item => {
              item.setAttribute('draggable', 'true');

              item.addEventListener('dragstart', function(e) {
                draggedBlockElement = this;
                this.style.opacity = '0.5';
                e.dataTransfer.effectAllowed = 'move';
              });

              item.addEventListener('dragend', function(e) {
                this.style.opacity = '1';
                // Remove all drag indicators
                blockItems.forEach(block => {
                  block.style.borderColor = '#E8EEF1';
                });
              });

              item.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'move';

                if (draggedBlockElement && draggedBlockElement !== this) {
                  this.style.borderColor = '#8E8E93';
                }
              });

              item.addEventListener('dragleave', function(e) {
                // Only reset if we're actually leaving this element
                if (!this.contains(e.relatedTarget)) {
                  this.style.borderColor = '#E8EEF1';
                }
              });

              item.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.borderColor = '#E8EEF1';

                if (draggedBlockElement && draggedBlockElement !== this) {
                  const allBlocks = Array.from(timeBlocksList.children);
                  const draggedIndex = allBlocks.indexOf(draggedBlockElement);
                  const targetIndex = allBlocks.indexOf(this);

                  // Remove the dragged element first
                  draggedBlockElement.remove();

                  // Insert at the correct position
                  if (draggedIndex < targetIndex) {
                    this.after(draggedBlockElement);
                  } else {
                    this.before(draggedBlockElement);
                  }

                  updateTimeBlockRanksAfterDrag();
                }
              });
            });
          }

          function updateTimeBlockRanksAfterDrag() {
            const blockItems = Array.from(document.querySelectorAll('[data-block-id]'));
            const updates = blockItems.map((item, index) => {
              const id = item.getAttribute('data-block-id');
              const block = timeBlocks.find(b => b.id == id);
              return {
                id: id,
                rank: index + 1,
                block: block
              };
            });

            // First set temporary values
            const tempUpdates = updates.map(update => {
              return fetch(`/settings/time_blocks/${update.id}`, {
                method: 'PATCH',
                headers: {
                  'X-CSRF-Token': csrfToken,
                  'Content-Type': 'application/json',
                  'Accept': 'application/json'
                },
                body: JSON.stringify({
                  time_block: {
                    name: update.block.name,
                    icon: update.block.icon,
                    color: update.block.color,
                    rank: -(parseInt(update.id) + 1000)
                  }
                })
              });
            });

            // Then set final values
            Promise.all(tempUpdates)
              .then(() => {
                return Promise.all(updates.map(update => {
                  return fetch(`/settings/time_blocks/${update.id}`, {
                    method: 'PATCH',
                    headers: {
                      'X-CSRF-Token': csrfToken,
                      'Content-Type': 'application/json',
                      'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                      time_block: {
                        name: update.block.name,
                        icon: update.block.icon,
                        color: update.block.color,
                        rank: update.rank
                      }
                    })
                  });
                }));
              })
              .then(() => loadTimeBlocks())
              .catch(error => alert('Error updating ranks'));
          }

          // Load time blocks on page load
          loadTimeBlocks();
        </script>
      </div>
    </main>
  </div>
</div>
