<div class="flex h-screen relative" style="background-color: #F5F5F5;">
  <%= render 'shared/sidebar' %>

  <!-- Mobile overlay -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 md:hidden hidden"></div>

  <!-- Menu flag button -->
  <button id="menu-button" class="fixed left-0 z-20 md:hidden rounded-r-lg shadow-lg flex items-center justify-center py-1.5 px-3 cursor-move"
    style="top: 200px; background: linear-gradient(135deg, #1d3e4c, #45606b); writing-mode: vertical-rl;">
    <span class="text-white font-bold text-sm tracking-wider">MENU</span>
  </button>

  <script>
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const menuButton = document.getElementById('menu-button');
    const closeButton = document.getElementById('sidebar-close');

    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      sidebar.classList.add('translate-x-0');
      overlay.classList.remove('hidden');
      menuButton.classList.add('hidden');
    }

    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      sidebar.classList.remove('translate-x-0');
      overlay.classList.add('hidden');
      menuButton.classList.remove('hidden');
    }

    // Draggable menu button
    let isDragging = false;
    let startY = 0;
    let startTop = 200;
    let dragStartTime = 0;

    menuButton.addEventListener('mousedown', (e) => {
      isDragging = true;
      dragStartTime = Date.now();
      startY = e.clientY;
      startTop = parseInt(menuButton.style.top) || 200;
      e.preventDefault();
    });

    menuButton.addEventListener('touchstart', (e) => {
      isDragging = true;
      dragStartTime = Date.now();
      startY = e.touches[0].clientY;
      startTop = parseInt(menuButton.style.top) || 200;
    });

    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        const deltaY = e.clientY - startY;
        const newTop = Math.max(0, Math.min(window.innerHeight - menuButton.offsetHeight, startTop + deltaY));
        menuButton.style.top = newTop + 'px';
        localStorage.setItem('menuButtonTop', newTop);
      }
    });

    document.addEventListener('touchmove', (e) => {
      if (isDragging) {
        const deltaY = e.touches[0].clientY - startY;
        const newTop = Math.max(0, Math.min(window.innerHeight - menuButton.offsetHeight, startTop + deltaY));
        menuButton.style.top = newTop + 'px';
        localStorage.setItem('menuButtonTop', newTop);
      }
    });

    document.addEventListener('mouseup', (e) => {
      if (isDragging) {
        const dragDuration = Date.now() - dragStartTime;
        const dragDistance = Math.abs(e.clientY - startY);

        if (dragDuration < 200 && dragDistance < 5) {
          openSidebar();
        }
        isDragging = false;
      }
    });

    document.addEventListener('touchend', (e) => {
      if (isDragging) {
        const dragDuration = Date.now() - dragStartTime;
        if (dragDuration < 200) {
          openSidebar();
        }
        isDragging = false;
      }
    });

    closeButton.addEventListener('click', closeSidebar);
    overlay.addEventListener('click', closeSidebar);

    const savedTop = localStorage.getItem('menuButtonTop');
    if (savedTop) {
      menuButton.style.top = savedTop + 'px';
    }
  </script>

  <!-- Main Content Area -->
  <main class="flex-1 overflow-y-auto" style="background-color: #F5F5F5;">
    <!-- White Header Section with Shadow -->
    <div class="bg-white shadow-md sticky top-0 z-10">
      <div class="p-8 pb-6">
        <div class="mb-4">
          <h1 class="text-4xl font-bold display-font mb-1" style="color: #1d3e4c;">Daily Briefing</h1>
          <p class="text-sm font-light" style="color: #657b84;"><%= @today.strftime('%A, %B %d, %Y') %></p>
        </div>
      </div>
    </div>

    <!-- Grey Background Content -->
    <div class="p-8 pt-6 space-y-6">
      <!-- Main Content Grid: Habits and Tasks -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Today's Habits -->
          <div class="bg-white rounded-xl shadow-md p-6">
            <div class="mb-4">
              <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold display-font" style="color: #1d3e4c;">Today's Habits</h2>
                <!-- Toggle Buttons -->
                <div class="flex gap-1 rounded-lg p-1" style="background-color: #E8EEF1;">
                  <button id="focus-time-btn" onclick="switchFocusView('time')" class="px-2 py-1 rounded text-xs font-semibold transition" style="background-color: #1d3e4c; color: white;">
                    Time
                  </button>
                  <button id="focus-category-btn" onclick="switchFocusView('category')" class="px-2 py-1 rounded text-xs font-semibold transition" style="color: #657b84;">
                    Category
                  </button>
                  <button id="focus-priority-btn" onclick="switchFocusView('priority')" class="px-2 py-1 rounded text-xs font-semibold transition" style="color: #657b84;">
                    Priority
                  </button>
                </div>
              </div>
              <div id="today-completion-count" class="text-sm font-light mt-1" style="color: #657b84;">
                <%= @completed_today %> / <%= @total_habits %> completed (<%= @today_percentage %>%)
              </div>
            </div>

            <% if @today_habits.any? %>
              <!-- Render all habits once with grouping metadata -->
              <div id="focus-habits-container" class="space-y-4">
                <%
                  # Light color mapping
                  light_color_map = {
                    '#6B8A99' => '#E8EEF1', '#9C8B7E' => '#E8E0D5', '#F8796D' => '#FFD4CE',
                    '#FFA07A' => '#FFE4D6', '#E5C730' => '#FEF7C3', '#A8A356' => '#E8EBCD',
                    '#7CB342' => '#D7EDCB', '#6EE7B7' => '#D1FAF0', '#22D3EE' => '#CFFAFE',
                    '#6366F1' => '#E0E7FF', '#A78BFA' => '#EDE9FE', '#E879F9' => '#FAE8FF',
                    '#FB7185' => '#FFE4E6', '#9CA3A8' => '#E8E8E8'
                  }

                  # Create a single list of all habits with their grouping info
                  all_habits_with_groups = @habits.map do |habit|
                    time_block_id = habit.time_block_id || 'anytime'
                    time_group = time_block_id == 'anytime' ? 'anytime' : "block_#{time_block_id}"

                    priority_group = habit.importance_level_id ? "level_#{habit.importance_level_id}" : 'none'
                    category_group = "category_#{habit.category_id}"

                    {
                      habit: habit,
                      time_group: time_group,
                      time_block_id: time_block_id,
                      time_block_name: habit.time_block&.name || 'Anytime',
                      time_block_icon: habit.time_block&.icon || 'fa-clock',
                      time_block_color: habit.time_block&.color || '#1d3e4c',
                      time_block_rank: habit.time_block&.rank || 999,
                      priority_group: priority_group,
                      priority_name: habit.importance_level&.name || 'No Priority',
                      priority_rank: habit.importance_level&.rank || 999,
                      priority_color: habit.importance_level&.color || '#657b84',
                      priority_icon: habit.importance_level&.icon || 'fa-circle',
                      category_group: category_group,
                      category_name: habit.category.name,
                      category_color: habit.category.color,
                      category_icon: habit.category.icon
                    }
                  end

                  # Sort by time_block rank by default (anytime last)
                  all_habits_with_groups.sort_by! { |h| h[:time_block_rank] }
                %>

                <% all_habits_with_groups.each do |habit_data| %>
                  <%
                    habit = habit_data[:habit]
                    completion_count = @today_completions[habit.id] || 0
                    is_complete = completion_count >= habit.target_count
                    category = habit.category
                    light_color = light_color_map[category.color] || (category.color + '20')
                  %>
                  <div class="habit-item flex items-center gap-2"
                       data-habit-id="<%= habit.id %>"
                       data-target="<%= habit.target_count %>"
                       data-health="<%= habit.health %>"
                       data-time-group="<%= habit_data[:time_group] %>"
                       data-time-block-id="<%= habit_data[:time_block_id] %>"
                       data-time-block-name="<%= habit_data[:time_block_name] %>"
                       data-time-block-icon="<%= habit_data[:time_block_icon] %>"
                       data-time-block-color="<%= habit_data[:time_block_color] %>"
                       data-time-block-rank="<%= habit_data[:time_block_rank] %>"
                       data-priority-group="<%= habit_data[:priority_group] %>"
                       data-priority-name="<%= habit_data[:priority_name] %>"
                       data-priority-rank="<%= habit_data[:priority_rank] %>"
                       data-priority-color="<%= habit_data[:priority_color] %>"
                       data-priority-icon="<%= habit_data[:priority_icon] %>"
                       data-category-group="<%= habit_data[:category_group] %>"
                       data-category-name="<%= habit_data[:category_name] %>"
                       data-category-icon="<%= habit_data[:category_icon] %>"
                       data-category-color="<%= category.color %>"
                       data-light-color="<%= light_color %>">
                    <button
                      onclick="toggleDashboardHabit(<%= habit.id %>, <%= is_complete ? 'true' : 'false' %>)"
                      class="flex-shrink-0 cursor-pointer transition-transform hover:scale-110">
                      <% if is_complete %>
                        <i class="fa-solid fa-circle-check text-sm" style="color: <%= category.color %>;"></i>
                      <% else %>
                        <i class="fa-regular fa-circle text-sm" style="color: <%= light_color %>;"></i>
                      <% end %>
                    </button>
                    <div class="flex-1 flex items-center gap-2">
                      <div class="text-sm font-semibold <%= is_complete ? 'line-through opacity-60' : '' %>" style="color: <%= is_complete ? light_color : category.color %>;">
                        <%= habit.name %>
                      </div>
                      <% if habit.documents.any? %>
                        <%= link_to habit_content_path(habit.documents.first),
                            class: "flex-shrink-0 text-xs hover:opacity-70 transition",
                            style: "color: #{category.color};",
                            title: "View attached content",
                            data: { habit_content_modal: true } do %>
                          <i class="fa-solid fa-file-alt"></i>
                        <% end %>
                      <% end %>
                    </div>
                    <div class="text-xs font-light" style="color: #657b84;">
                      <%= completion_count %> / <%= habit.target_count %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="text-center py-8">
                <i class="fa-solid fa-check-circle text-4xl mb-2" style="color: #E8EEF1;"></i>
                <p class="text-sm font-light" style="color: #657b84;">No habits for today</p>
              </div>
            <% end %>
          </div>

        <!-- Tasks Section -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <div class="mb-4">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-bold display-font" style="color: #1d3e4c;">Tasks</h2>
              <!-- Toggle Buttons -->
              <div class="flex gap-1 rounded-lg p-1" style="background-color: #E8EEF1;">
                <button id="tasks-date-btn" onclick="switchTasksView('date')" class="px-2 py-1 rounded text-xs font-semibold transition" style="background-color: #1d3e4c; color: white;">
                  Date
                </button>
                <button id="tasks-category-btn" onclick="switchTasksView('category')" class="px-2 py-1 rounded text-xs font-semibold transition" style="color: #657b84;">
                  Category
                </button>
                <button id="tasks-priority-btn" onclick="switchTasksView('priority')" class="px-2 py-1 rounded text-xs font-semibold transition" style="color: #657b84;">
                  Priority
                </button>
              </div>
            </div>
          </div>

          <div id="tasks-container">
            <%
              # Build task data with metadata for all tasks
              all_tasks_with_groups = @tasks.map do |task|
                # Date grouping
                date_group = if task.due_date.nil?
                  'no_date'
                elsif task.due_date < @today
                  'overdue'
                elsif task.due_date == @today
                  'today'
                else
                  'future'
                end

                # Category grouping
                category_group = task.category_id ? "category_#{task.category_id}" : 'none'

                # Priority grouping
                priority_group = task.importance_level_id ? "level_#{task.importance_level_id}" : 'none'

                {
                  task: task,
                  date_group: date_group,
                  category_group: category_group,
                  category_name: task.category&.name || 'No Category',
                  category_color: task.category&.color || '#9CA3A8',
                  category_icon: task.category&.icon || 'fa-circle',
                  priority_group: priority_group,
                  priority_name: task.importance_level&.name || 'No Priority',
                  priority_rank: task.importance_level&.rank || 999,
                  priority_color: task.importance_level&.color || '#657b84',
                  priority_icon: task.importance_level&.icon || 'fa-circle'
                }
              end

              # Sort by date by default (overdue, today, no date, future)
              date_order = {'overdue' => 0, 'today' => 1, 'no_date' => 2, 'future' => 3}
              all_tasks_with_groups.sort_by! { |t| [date_order[t[:date_group]] || 999, t[:task].due_date || Date.new(9999)] }
            %>

            <% all_tasks_with_groups.each do |task_data| %>
              <%
                task = task_data[:task]
                color = case task_data[:date_group]
                when 'overdue' then '#F8796D'
                when 'today' then '#1d3e4c'
                else '#657b84'
                end
              %>
              <div class="task-item flex items-center gap-2 mb-2"
                   data-task-id="<%= task.id %>"
                   data-completed="<%= task.completed %>"
                   data-date-group="<%= task_data[:date_group] %>"
                   data-category-group="<%= task_data[:category_group] %>"
                   data-category-name="<%= task_data[:category_name] %>"
                   data-category-color="<%= task_data[:category_color] %>"
                   data-category-icon="<%= task_data[:category_icon] %>"
                   data-priority-group="<%= task_data[:priority_group] %>"
                   data-priority-name="<%= task_data[:priority_name] %>"
                   data-priority-rank="<%= task_data[:priority_rank] %>"
                   data-priority-color="<%= task_data[:priority_color] %>"
                   data-priority-icon="<%= task_data[:priority_icon] %>"
                   data-due-date="<%= task.due_date&.strftime('%b %d') || '' %>">
                <button
                  onclick="toggleTask(<%= task.id %>, <%= task.completed ? 'true' : 'false' %>)"
                  class="flex-shrink-0 cursor-pointer transition-transform hover:scale-110">
                  <% if task.completed %>
                    <i class="fa-solid fa-circle-check text-xs" style="color: <%= color %>;"></i>
                  <% else %>
                    <i class="fa-regular fa-circle text-xs" style="color: <%= color %>;"></i>
                  <% end %>
                </button>
                <span class="flex-1 text-sm <%= task.completed ? 'line-through opacity-60' : '' %>" style="color: <%= color %>;"><%= task.name %></span>
                <% if task.due_date %>
                  <span class="text-xs" style="color: <%= color %>;"><%= task.due_date.strftime('%b %d') %></span>
                <% end %>
              </div>
            <% end %>

            <% if @tasks.empty? %>
              <div class="text-center py-8">
                <i class="fa-solid fa-list-check text-4xl mb-2" style="color: #E8EEF1;"></i>
                <p class="text-sm font-light" style="color: #657b84;">No tasks yet</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Bottom Row: Calendar and Quick Links -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Calendar Placeholder -->
        <div class="md:col-span-2 bg-white rounded-xl shadow-md p-6">
          <h2 class="text-xl font-bold display-font mb-4" style="color: #1d3e4c;">Calendar</h2>
          <div class="text-center py-8 border-2 border-dashed rounded-lg" style="border-color: #E8EEF1;">
            <i class="fa-solid fa-calendar text-4xl mb-2" style="color: #E8EEF1;"></i>
            <p class="text-xs font-light" style="color: #657b84;">Calendar integration coming soon</p>
            <p class="text-xs font-light mt-1" style="color: #657b84;">(Google Calendar / iCal)</p>
          </div>
        </div>

        <!-- Quick Links -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <h2 class="text-xl font-bold display-font mb-4" style="color: #1d3e4c;">Quick Links</h2>
          <div class="space-y-2">
            <%= link_to habits_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition" do %>
              <i class="fa-solid fa-chart-line text-lg" style="color: #1d3e4c;"></i>
              <span class="text-sm font-semibold" style="color: #1d3e4c;">View Analytics</span>
            <% end %>
            <%= link_to root_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition" do %>
              <i class="fa-solid fa-folder text-lg" style="color: #1d3e4c;"></i>
              <span class="text-sm font-semibold" style="color: #1d3e4c;">Browse Categories</span>
            <% end %>
            <%= link_to tasks_path, class: "flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition" do %>
              <i class="fa-solid fa-tasks text-lg" style="color: #1d3e4c;"></i>
              <span class="text-sm font-semibold" style="color: #1d3e4c;">All Tasks</span>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- React Modal Root for Dashboard -->
<div id="dashboard-modals-root"></div>

<script>
// Today's Focus view toggle
function switchFocusView(view) {
  const container = document.getElementById('focus-habits-container');
  const timeBtn = document.getElementById('focus-time-btn');
  const categoryBtn = document.getElementById('focus-category-btn');
  const priorityBtn = document.getElementById('focus-priority-btn');

  // Update button styles
  timeBtn.style.backgroundColor = '';
  timeBtn.style.color = '#657b84';
  categoryBtn.style.backgroundColor = '';
  categoryBtn.style.color = '#657b84';
  priorityBtn.style.backgroundColor = '';
  priorityBtn.style.color = '#657b84';

  if (view === 'time') {
    timeBtn.style.backgroundColor = '#1d3e4c';
    timeBtn.style.color = 'white';
  } else if (view === 'category') {
    categoryBtn.style.backgroundColor = '#1d3e4c';
    categoryBtn.style.color = 'white';
  } else {
    priorityBtn.style.backgroundColor = '#1d3e4c';
    priorityBtn.style.color = 'white';
  }

  // Get all habit items
  const habitItems = Array.from(container.querySelectorAll('.habit-item'));

  // Group and sort based on view
  let groups = {};
  let groupOrder = [];
  let groupIcons = {};

  if (view === 'time') {
    // Group by user-defined time blocks
    const timeGroups = {};

    habitItems.forEach(item => {
      const group = item.dataset.timeGroup;
      const name = item.dataset.timeBlockName;
      const rank = parseInt(item.dataset.timeBlockRank);
      const color = item.dataset.timeBlockColor;
      const icon = item.dataset.timeBlockIcon;

      if (!timeGroups[group]) {
        timeGroups[group] = {
          name: name,
          rank: rank,
          color: color,
          icon: icon,
          items: []
        };
      }
      timeGroups[group].items.push(item);
    });

    // Sort groups by rank (anytime will have rank 999)
    groupOrder = Object.keys(timeGroups).sort((a, b) => {
      return timeGroups[a].rank - timeGroups[b].rank;
    });

    // Build groups object and icons
    groupOrder.forEach(key => {
      groups[key] = timeGroups[key].items;
      groupIcons[key] = timeGroups[key].icon;
    });
  } else if (view === 'category') {
    // Group by category
    const categoryGroups = {};

    habitItems.forEach(item => {
      const group = item.dataset.categoryGroup;
      const name = item.dataset.categoryName;
      const color = item.dataset.categoryColor;
      const icon = item.dataset.categoryIcon;

      if (!categoryGroups[group]) {
        categoryGroups[group] = {
          name: name,
          color: color,
          icon: icon,
          items: []
        };
      }
      categoryGroups[group].items.push(item);
    });

    // Sort groups alphabetically by name
    groupOrder = Object.keys(categoryGroups).sort((a, b) => {
      return categoryGroups[a].name.localeCompare(categoryGroups[b].name);
    });

    // Build groups object and icons
    groupOrder.forEach(key => {
      groups[key] = categoryGroups[key].items;
      groupIcons[key] = categoryGroups[key].icon;
    });
  } else {
    // Group by user-defined importance levels
    const priorityGroups = {};

    habitItems.forEach(item => {
      const group = item.dataset.priorityGroup;
      const name = item.dataset.priorityName;
      const rank = parseInt(item.dataset.priorityRank);
      const color = item.dataset.priorityColor;
      const icon = item.dataset.priorityIcon;

      if (!priorityGroups[group]) {
        priorityGroups[group] = {
          name: name,
          rank: rank,
          color: color,
          icon: icon,
          items: []
        };
      }
      priorityGroups[group].items.push(item);
    });

    // Sort groups by rank
    groupOrder = Object.keys(priorityGroups).sort((a, b) => {
      return priorityGroups[a].rank - priorityGroups[b].rank;
    });

    // Build groups object and icons
    groupOrder.forEach(key => {
      groups[key] = priorityGroups[key].items;
      groupIcons[key] = priorityGroups[key].icon;
    });
  }

  // Clear container
  container.innerHTML = '';

  // Rebuild with headers
  groupOrder.forEach(groupName => {
    if (!groups[groupName] || groups[groupName].length === 0) return;

    // Create group header
    const groupDiv = document.createElement('div');

    const headerDiv = document.createElement('div');
    headerDiv.className = 'flex items-center gap-2 mb-2';

    // Add icon for time, category, and priority views
    if (groupIcons[groupName]) {
      const iconBox = document.createElement('div');
      iconBox.className = 'w-5 h-5 rounded flex items-center justify-center flex-shrink-0';

      const icon = document.createElement('i');
      icon.className = 'text-white text-xs';

      if (view === 'category') {
        icon.className = `${groupIcons[groupName]} text-white text-xs`;
        iconBox.style.backgroundColor = groups[groupName][0].dataset.categoryColor;
      } else if (view === 'priority') {
        icon.className = `${groupIcons[groupName]} text-white text-xs`;
        iconBox.style.backgroundColor = groups[groupName][0].dataset.priorityColor;
      } else if (view === 'time') {
        icon.className = `${groupIcons[groupName]} text-white text-xs`;
        iconBox.style.backgroundColor = groups[groupName][0].dataset.timeBlockColor;
      } else {
        icon.className = `fa-solid ${groupIcons[groupName]} text-white text-xs`;
        iconBox.style.backgroundColor = '#1d3e4c';
      }

      iconBox.appendChild(icon);
      headerDiv.appendChild(iconBox);
    }

    const title = document.createElement('div');
    title.className = 'text-sm font-semibold';
    title.style.color = '#1d3e4c';

    // Set text based on view
    if (view === 'category' && groups[groupName].length > 0) {
      title.textContent = groups[groupName][0].dataset.categoryName;
    } else if (view === 'priority' && groups[groupName].length > 0) {
      title.textContent = groups[groupName][0].dataset.priorityName;
    } else if (view === 'time' && groups[groupName].length > 0) {
      title.textContent = groups[groupName][0].dataset.timeBlockName;
    } else {
      title.textContent = groupName.charAt(0).toUpperCase() + groupName.slice(1);
    }

    headerDiv.appendChild(title);

    // Create habits container
    const habitsDiv = document.createElement('div');
    habitsDiv.className = 'space-y-2 ml-6';

    groups[groupName].forEach(habitItem => {
      habitsDiv.appendChild(habitItem);
    });

    groupDiv.appendChild(headerDiv);
    groupDiv.appendChild(habitsDiv);
    container.appendChild(groupDiv);
  });
}

// Track all habits and their completion states
const habitStates = new Map();
let totalHabitsCount = 0;

// Initialize habit states on page load
document.addEventListener('DOMContentLoaded', () => {
  // Initialize habit states BEFORE reorganizing view
  document.querySelectorAll('.habit-item[data-habit-id]').forEach(row => {
    const habitId = parseInt(row.dataset.habitId);
    const targetCount = parseInt(row.dataset.target);
    const countText = row.querySelector('.text-xs').textContent.trim();
    const currentCount = parseInt(countText.split('/')[0]);

    habitStates.set(habitId, {
      currentCount,
      targetCount,
      isComplete: currentCount >= targetCount
    });
  });
  totalHabitsCount = habitStates.size;

  // Now initialize the view to time grouping
  switchFocusView('time');
});

async function toggleDashboardHabit(habitId, wasComplete) {
  const action = wasComplete ? 'decrement' : 'increment';

  try {
    const response = await fetch(`/habits/${habitId}/completions/${action}`, {
      method: 'POST',
      headers: {
        'X-CSRF-Token': document.querySelector('[name=csrf-token]').content,
        'Content-Type': 'application/json'
      }
    });

    const data = await response.json();

    // Find the habit row - use more specific selector
    const habitRow = document.querySelector(`.habit-item[data-habit-id="${habitId}"]`);
    if (!habitRow) {
      console.error('Could not find habit row for ID:', habitId);
      return;
    }

    const button = habitRow.querySelector('button');
    const icon = button.querySelector('i');
    const nameDiv = habitRow.querySelector('.flex-1');
    const countDiv = habitRow.querySelector('.text-xs');
    const targetCount = parseInt(habitRow.dataset.target);

    // Get category colors from data attributes
    const categoryColor = habitRow.dataset.categoryColor;
    const lightColor = habitRow.dataset.lightColor;

    // Store habit's health data for later updates
    habitRow.dataset.health = data.health;

    // Update state
    const oldState = habitStates.get(habitId);
    const newIsComplete = data.count >= targetCount;
    const statusChanged = oldState && oldState.isComplete !== newIsComplete;

    habitStates.set(habitId, {
      currentCount: data.count,
      targetCount,
      isComplete: newIsComplete
    });

    // Update UI
    if (newIsComplete) {
      icon.className = 'fa-solid fa-circle-check text-sm';
      icon.style.color = categoryColor;
      nameDiv.classList.add('line-through', 'opacity-60');
      nameDiv.style.color = lightColor;
    } else {
      icon.className = 'fa-regular fa-circle text-sm';
      icon.style.color = lightColor;
      nameDiv.classList.remove('line-through', 'opacity-60');
      nameDiv.style.color = categoryColor;
    }

    countDiv.textContent = `${data.count} / ${targetCount}`;
    button.setAttribute('onclick', `toggleDashboardHabit(${habitId}, ${newIsComplete})`);

    // Recalculate totals
    let totalComplete = 0;
    habitStates.forEach(state => {
      if (state.isComplete) totalComplete++;
    });

    const percentage = totalHabitsCount > 0 ? Math.round((totalComplete * 100) / totalHabitsCount) : 0;

    // Update header
    const completionHeader = document.getElementById('today-completion-count');
    if (completionHeader) {
      completionHeader.textContent = `${totalComplete} / ${totalHabitsCount} completed (${percentage}%)`;
    }

  } catch (error) {
    console.error('Error toggling habit:', error);
  }
}

// Tasks view toggle
function switchTasksView(view) {
  const container = document.getElementById('tasks-container');
  const dateBtn = document.getElementById('tasks-date-btn');
  const categoryBtn = document.getElementById('tasks-category-btn');
  const priorityBtn = document.getElementById('tasks-priority-btn');

  // Update button styles
  dateBtn.style.backgroundColor = '';
  dateBtn.style.color = '#657b84';
  categoryBtn.style.backgroundColor = '';
  categoryBtn.style.color = '#657b84';
  priorityBtn.style.backgroundColor = '';
  priorityBtn.style.color = '#657b84';

  if (view === 'date') {
    dateBtn.style.backgroundColor = '#1d3e4c';
    dateBtn.style.color = 'white';
  } else if (view === 'category') {
    categoryBtn.style.backgroundColor = '#1d3e4c';
    categoryBtn.style.color = 'white';
  } else {
    priorityBtn.style.backgroundColor = '#1d3e4c';
    priorityBtn.style.color = 'white';
  }

  // Get all task items
  const taskItems = Array.from(container.querySelectorAll('.task-item'));

  if (taskItems.length === 0) return;

  // Group and sort based on view
  let groups = {};
  let groupOrder = [];
  let groupLabels = {};
  let groupColors = {};

  if (view === 'date') {
    groupOrder = ['overdue', 'today', 'no_date', 'future'];
    groupLabels = {
      'overdue': 'Overdue',
      'today': 'Due Today',
      'no_date': 'No Due Date',
      'future': 'Upcoming'
    };
    groupColors = {
      'overdue': '#F8796D',
      'today': '#1d3e4c',
      'no_date': '#657b84',
      'future': '#657b84'
    };

    taskItems.forEach(item => {
      const group = item.dataset.dateGroup;
      if (!groups[group]) groups[group] = [];
      groups[group].push(item);
    });
  } else if (view === 'category') {
    // Group by category
    const categoryGroups = {};

    taskItems.forEach(item => {
      const group = item.dataset.categoryGroup;
      const name = item.dataset.categoryName;
      const color = item.dataset.categoryColor;

      if (!categoryGroups[group]) {
        categoryGroups[group] = {
          name: name,
          color: color,
          items: []
        };
      }
      categoryGroups[group].items.push(item);
    });

    // Sort groups alphabetically by name
    groupOrder = Object.keys(categoryGroups).sort((a, b) => {
      return categoryGroups[a].name.localeCompare(categoryGroups[b].name);
    });

    // Build groups object and labels
    groupOrder.forEach(key => {
      groups[key] = categoryGroups[key].items;
      groupLabels[key] = categoryGroups[key].name;
      groupColors[key] = categoryGroups[key].color;
    });
  } else {
    // Group by priority
    const priorityGroups = {};

    taskItems.forEach(item => {
      const group = item.dataset.priorityGroup;
      const name = item.dataset.priorityName;
      const rank = parseInt(item.dataset.priorityRank);
      const color = item.dataset.priorityColor;
      const icon = item.dataset.priorityIcon;

      if (!priorityGroups[group]) {
        priorityGroups[group] = {
          name: name,
          rank: rank,
          color: color,
          icon: icon,
          items: []
        };
      }
      priorityGroups[group].items.push(item);
    });

    // Sort groups by rank
    groupOrder = Object.keys(priorityGroups).sort((a, b) => {
      return priorityGroups[a].rank - priorityGroups[b].rank;
    });

    // Build groups object, labels, and colors
    groupOrder.forEach(key => {
      groups[key] = priorityGroups[key].items;
      groupLabels[key] = priorityGroups[key].name;
      groupColors[key] = priorityGroups[key].color;
    });
  }

  // Clear container
  container.innerHTML = '';

  // Rebuild with headers
  groupOrder.forEach(groupName => {
    if (!groups[groupName] || groups[groupName].length === 0) return;

    // Create group header
    const groupDiv = document.createElement('div');
    groupDiv.className = 'mb-4';

    const headerDiv = document.createElement('div');
    headerDiv.className = 'text-xs font-semibold mb-2 flex items-center gap-2';

    // Add icon
    if (view === 'date' && groupName === 'overdue') {
      const iconBox = document.createElement('div');
      iconBox.className = 'w-4 h-4 rounded flex items-center justify-center flex-shrink-0';
      iconBox.style.backgroundColor = groupColors[groupName] || '#1d3e4c';

      const icon = document.createElement('i');
      icon.className = 'fa-solid fa-exclamation-triangle text-white';
      icon.style.fontSize = '8px';

      iconBox.appendChild(icon);
      headerDiv.appendChild(iconBox);
    } else if (view === 'priority' && groups[groupName].length > 0) {
      const iconBox = document.createElement('div');
      iconBox.className = 'w-4 h-4 rounded flex items-center justify-center flex-shrink-0';
      const firstTask = groups[groupName][0];
      iconBox.style.backgroundColor = groupColors[groupName] || '#1d3e4c';

      const icon = document.createElement('i');
      icon.className = `${firstTask.dataset.priorityIcon} text-white`;
      icon.style.fontSize = '8px';

      iconBox.appendChild(icon);
      headerDiv.appendChild(iconBox);
    } else if (view === 'category' && groups[groupName].length > 0) {
      const iconBox = document.createElement('div');
      iconBox.className = 'w-4 h-4 rounded flex items-center justify-center flex-shrink-0';
      const firstTask = groups[groupName][0];
      iconBox.style.backgroundColor = groupColors[groupName] || '#1d3e4c';

      const icon = document.createElement('i');
      icon.className = `${firstTask.dataset.categoryIcon} text-white`;
      icon.style.fontSize = '8px';

      iconBox.appendChild(icon);
      headerDiv.appendChild(iconBox);
    }

    const label = document.createElement('span');
    label.style.color = '#1d3e4c';
    label.textContent = groupLabels[groupName] || groupName;
    headerDiv.appendChild(label);

    // Create tasks container
    const tasksDiv = document.createElement('div');
    tasksDiv.className = 'space-y-2';

    groups[groupName].forEach(taskItem => {
      tasksDiv.appendChild(taskItem);
    });

    groupDiv.appendChild(headerDiv);
    groupDiv.appendChild(tasksDiv);
    container.appendChild(groupDiv);
  });
}

// Initialize tasks view on page load
document.addEventListener('DOMContentLoaded', () => {
  const tasksContainer = document.getElementById('tasks-container');
  if (tasksContainer && tasksContainer.querySelectorAll('.task-item').length > 0) {
    switchTasksView('date');
  }
});

// Toggle task completion
async function toggleTask(taskId, wasCompleted) {
  const newCompleted = !wasCompleted;

  try {
    const response = await fetch(`/tasks/${taskId}`, {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name=csrf-token]').content,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        task: {
          completed: newCompleted,
          completed_at: newCompleted ? new Date().toISOString() : null
        }
      })
    });

    const data = await response.json();

    if (data.success) {
      // Find the task item
      const taskItem = document.querySelector(`.task-item[data-task-id="${taskId}"]`);
      if (!taskItem) {
        console.error('Could not find task item for ID:', taskId);
        return;
      }

      // Update data attribute
      taskItem.dataset.completed = newCompleted;

      // Find elements
      const button = taskItem.querySelector('button');
      const icon = button.querySelector('i');
      const nameSpan = taskItem.querySelector('.flex-1');

      // Get color from data attributes based on date group
      const dateGroup = taskItem.dataset.dateGroup;
      const color = dateGroup === 'overdue' ? '#F8796D' : (dateGroup === 'today' ? '#1d3e4c' : '#657b84');

      // Update UI
      if (newCompleted) {
        icon.className = 'fa-solid fa-circle-check text-xs';
        icon.style.color = color;
        nameSpan.classList.add('line-through', 'opacity-60');
      } else {
        icon.className = 'fa-regular fa-circle text-xs';
        icon.style.color = color;
        nameSpan.classList.remove('line-through', 'opacity-60');
      }

      button.setAttribute('onclick', `toggleTask(${taskId}, ${newCompleted})`);
    } else {
      console.error('Error toggling task:', data.errors);
    }
  } catch (error) {
    console.error('Error toggling task:', error);
  }
}
</script>
