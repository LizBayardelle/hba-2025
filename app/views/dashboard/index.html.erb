<div class="flex h-screen relative" style="background-color: #F5F5F7;">
  <%= render 'shared/sidebar' %>

  <!-- Mobile overlay -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 md:hidden hidden"></div>

  <!-- Menu flag button -->
  <button id="menu-button" class="fixed left-0 z-20 md:hidden rounded-r-lg shadow-lg flex items-center justify-center py-1.5 px-3 cursor-move"
    style="top: 200px; background: linear-gradient(135deg, #424245, #2C2C2E); writing-mode: vertical-rl;">
    <span class="text-white font-bold text-sm tracking-wider">MENU</span>
  </button>

  <script>
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const menuButton = document.getElementById('menu-button');
    const closeButton = document.getElementById('sidebar-close');

    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      sidebar.classList.add('translate-x-0');
      overlay.classList.remove('hidden');
      menuButton.classList.add('hidden');
    }

    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      sidebar.classList.remove('translate-x-0');
      overlay.classList.add('hidden');
      menuButton.classList.remove('hidden');
    }

    // Draggable menu button
    let isDragging = false;
    let startY = 0;
    let startTop = 200;
    let dragStartTime = 0;

    menuButton.addEventListener('mousedown', (e) => {
      isDragging = true;
      dragStartTime = Date.now();
      startY = e.clientY;
      startTop = parseInt(menuButton.style.top) || 200;
      e.preventDefault();
    });

    menuButton.addEventListener('touchstart', (e) => {
      isDragging = true;
      dragStartTime = Date.now();
      startY = e.touches[0].clientY;
      startTop = parseInt(menuButton.style.top) || 200;
    });

    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        const deltaY = e.clientY - startY;
        const newTop = Math.max(0, Math.min(window.innerHeight - menuButton.offsetHeight, startTop + deltaY));
        menuButton.style.top = newTop + 'px';
        localStorage.setItem('menuButtonTop', newTop);
      }
    });

    document.addEventListener('touchmove', (e) => {
      if (isDragging) {
        const deltaY = e.touches[0].clientY - startY;
        const newTop = Math.max(0, Math.min(window.innerHeight - menuButton.offsetHeight, startTop + deltaY));
        menuButton.style.top = newTop + 'px';
        localStorage.setItem('menuButtonTop', newTop);
      }
    });

    document.addEventListener('mouseup', (e) => {
      if (isDragging) {
        const dragDuration = Date.now() - dragStartTime;
        const dragDistance = Math.abs(e.clientY - startY);

        if (dragDuration < 200 && dragDistance < 5) {
          openSidebar();
        }
        isDragging = false;
      }
    });

    document.addEventListener('touchend', (e) => {
      if (isDragging) {
        const dragDuration = Date.now() - dragStartTime;
        if (dragDuration < 200) {
          openSidebar();
        }
        isDragging = false;
      }
    });

    closeButton.addEventListener('click', closeSidebar);
    overlay.addEventListener('click', closeSidebar);

    const savedTop = localStorage.getItem('menuButtonTop');
    if (savedTop) {
      menuButton.style.top = savedTop + 'px';
    }
  </script>

  <!-- Main Content Area -->
  <main class="flex-1 overflow-y-auto" style="background-color: #F5F5F7;">
    <!-- White Header Section with Shadow -->
    <div class="sticky top-0 z-10" style="background: #FFFFFF; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);">
      <div class="p-8">
        <div class="flex items-start justify-between mb-6">
          <div class="flex-1">
            <h1 class="text-5xl font-display" style="color: #1D1D1F;">
              Daily Briefing
            </h1>
            <p class="text-sm mt-1" style="color: #8E8E93; font-weight: 400; font-family: 'Inter', sans-serif;"><%= @today.strftime('%A, %B %d, %Y') %></p>
          </div>

          <!-- Date Navigation -->
          <div class="flex flex-col items-center gap-1">
            <div class="flex items-center gap-2">
              <%= link_to dashboard_path(date: (@today - 1.day).strftime('%Y-%m-%d')),
                  class: "w-10 h-10 rounded-lg flex items-center justify-center transition",
                  style: "background: linear-gradient(135deg, rgba(229, 229, 231, 0.3) 0%, rgba(199, 199, 204, 0.4) 50%, rgba(142, 142, 147, 0.3) 100%); border: 0.5px solid rgba(199, 199, 204, 0.3); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);" do %>
                <i class="fa-solid fa-chevron-left text-sm" style="color: #2C2C2E;"></i>
              <% end %>

              <div class="px-2 text-sm min-w-[60px] text-center" style="color: #1D1D1F; font-weight: 600; font-family: 'Inter', sans-serif;">
                <%= @today == Time.zone.today ? 'Today' : @today.strftime('%m/%d') %>
              </div>

              <% if @today < Time.zone.today %>
                <%= link_to dashboard_path(date: (@today + 1.day).strftime('%Y-%m-%d')),
                    class: "w-10 h-10 rounded-lg flex items-center justify-center transition",
                    style: "background: linear-gradient(135deg, rgba(229, 229, 231, 0.3) 0%, rgba(199, 199, 204, 0.4) 50%, rgba(142, 142, 147, 0.3) 100%); border: 0.5px solid rgba(199, 199, 204, 0.3); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);" do %>
                  <i class="fa-solid fa-chevron-right text-sm" style="color: #2C2C2E;"></i>
                <% end %>
              <% else %>
                <div class="w-10 h-10 rounded-lg flex items-center justify-center opacity-30 pointer-events-none" style="background: linear-gradient(135deg, rgba(229, 229, 231, 0.3) 0%, rgba(199, 199, 204, 0.4) 50%, rgba(142, 142, 147, 0.3) 100%); border: 0.5px solid rgba(199, 199, 204, 0.3);">
                  <i class="fa-solid fa-chevron-right text-sm" style="color: #2C2C2E;"></i>
                </div>
              <% end %>
            </div>

            <% if @today != Time.zone.today %>
              <%= link_to "BACK TO TODAY", dashboard_path,
                  class: "text-xs mt-1 hover:opacity-70 transition uppercase tracking-wide",
                  style: "color: #8E8E93; font-family: 'Inter', sans-serif; font-weight: 300;" %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Grey Background Content -->
    <div class="p-8 pt-6 space-y-6">
      <!-- Top Row: Today's Calendar (2/3) + Quick Links (1/3) -->
      <% if current_user.google_sync_enabled && current_user.google_calendar_id.present? %>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Today's Calendar -->
          <div class="md:col-span-2 rounded-xl p-4" style="background: #FFFFFF; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-2xl font-display" style="color: #1D1D1F;">
                <i class="fa-solid fa-calendar mr-2"></i>Today's Calendar
              </h2>
              <%= link_to "https://calendar.google.com", target: "_blank", rel: "noopener noreferrer",
                  class: "text-xs hover:underline",
                  style: "color: #8E8E93; font-weight: 200; font-family: 'Inter', sans-serif;" do %>
                Open in Google
              <% end %>
            </div>
            <% if @calendar_events.any? %>
              <div class="space-y-0">
                <% @calendar_events.each do |event| %>
                  <div class="flex items-center gap-4 py-1 transition rounded px-2" style="hover:background-color: rgba(199, 199, 204, 0.1);">
                    <% if event[:all_day] %>
                      <div class="text-xs w-20" style="color: #8E8E93; font-weight: 600; font-family: 'Inter', sans-serif;">All Day</div>
                    <% else %>
                      <div class="text-xs w-20" style="color: #1D1D1F; font-weight: 600; font-family: 'Inter', sans-serif;">
                        <%= event[:start_time].strftime('%l:%M %p') %>
                      </div>
                    <% end %>
                    <div class="flex-1 text-sm" style="color: #1D1D1F; font-weight: 400; font-family: 'Inter', sans-serif;">
                      <%= event[:summary] || 'Untitled Event' %>
                      <% if current_user.google_calendar_id.length > 1 %>
                        <span class="text-xs ml-2" style="color: #8E8E93; font-weight: 200; font-family: 'Inter', sans-serif;">
                          (<%= event[:calendar_name] %>)
                        </span>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="text-center py-8">
                <p class="text-sm" style="color: #8E8E93; font-weight: 200; font-family: 'Inter', sans-serif;">Nothing planned for today.</p>
              </div>
            <% end %>
            <!-- Footer with refresh and timestamp -->
            <div class="flex items-center justify-between mt-3 pt-2" style="border-top: 1px solid rgba(199, 199, 204, 0.2);">
              <%= form_with url: google_calendar_refresh_path(date: @today.strftime('%Y-%m-%d')), method: :post, local: true, id: "calendar-refresh-form", style: "display: inline; margin: 0;" do %>
                <button type="submit" id="calendar-refresh-btn" class="text-xs hover:underline flex items-center gap-1" style="color: #8E8E93; font-weight: 200; font-family: 'Inter', sans-serif; background: none; border: none; padding: 0; cursor: pointer;" title="Refresh calendar">
                  <i class="fa-solid fa-refresh text-xs" style="color: #8E8E93;"></i>
                  <span>Refresh</span>
                </button>
              <% end %>
              <% if current_user.calendar_events_cached_at %>
                <span class="text-xs" style="color: #8E8E93; font-weight: 200; font-family: 'Inter', sans-serif;">
                  Updated <%= time_ago_in_words(current_user.calendar_events_cached_at) %> ago
                </span>
              <% end %>
            </div>
          </div>

          <script>
            document.addEventListener('DOMContentLoaded', () => {
              const refreshForm = document.getElementById('calendar-refresh-form');
              if (refreshForm) {
                refreshForm.addEventListener('submit', (e) => {
                  const btn = document.getElementById('calendar-refresh-btn');
                  const icon = btn.querySelector('i');
                  const text = btn.querySelector('span');
                  icon.classList.add('fa-spin');
                  text.textContent = 'Refreshing...';
                  btn.disabled = true;
                });
              }
            });
          </script>

          <!-- Quick Links -->
          <div class="rounded-xl p-4" style="background: #FFFFFF; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
            <h2 class="text-2xl font-display mb-3" style="color: #1D1D1F;">Quick Links</h2>
            <div class="space-y-1">
              <%= link_to habits_path, class: "flex items-center gap-3 p-2 rounded-lg transition", style: "hover:background-color: rgba(199, 199, 204, 0.1);" do %>
                <i class="fa-solid fa-chart-line text-lg" style="color: #2C2C2E;"></i>
                <span class="text-sm" style="color: #1D1D1F; font-weight: 600; font-family: 'Inter', sans-serif;">View Analytics</span>
              <% end %>
              <%= link_to root_path, class: "flex items-center gap-3 p-2 rounded-lg transition", style: "hover:background-color: rgba(199, 199, 204, 0.1);" do %>
                <i class="fa-solid fa-folder text-lg" style="color: #2C2C2E;"></i>
                <span class="text-sm" style="color: #1D1D1F; font-weight: 600; font-family: 'Inter', sans-serif;">Browse Categories</span>
              <% end %>
              <%= link_to tasks_path, class: "flex items-center gap-3 p-2 rounded-lg transition", style: "hover:background-color: rgba(199, 199, 204, 0.1);" do %>
                <i class="fa-solid fa-tasks text-lg" style="color: #2C2C2E;"></i>
                <span class="text-sm" style="color: #1D1D1F; font-weight: 600; font-family: 'Inter', sans-serif;">All Tasks</span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Main Content Grid: Habits and Tasks -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Today's Habits -->
          <div class="rounded-xl p-6" style="background: #FFFFFF; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
            <div class="mb-4">
              <div class="flex items-center justify-between">
                <h2 class="text-2xl font-display" style="color: #1D1D1F;">Habits</h2>
                <!-- Toggle Buttons -->
                <div class="flex gap-1 rounded-lg p-1" style="background: rgba(199, 199, 204, 0.2);">
                  <button id="focus-time-btn" onclick="switchFocusView('time')" class="px-2 py-1 rounded text-xs transition" style="background: linear-gradient(135deg, #2C2C2E, #1D1D1F); color: white; font-weight: 600; font-family: 'Inter', sans-serif; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">
                    Time
                  </button>
                  <button id="focus-category-btn" onclick="switchFocusView('category')" class="px-2 py-1 rounded text-xs transition" style="color: #8E8E93; font-weight: 600; font-family: 'Inter', sans-serif;">
                    Category
                  </button>
                  <button id="focus-priority-btn" onclick="switchFocusView('priority')" class="px-2 py-1 rounded text-xs transition" style="color: #8E8E93; font-weight: 600; font-family: 'Inter', sans-serif;">
                    Priority
                  </button>
                </div>
              </div>
              <div id="today-completion-count" class="text-sm mt-1" style="color: #8E8E93; font-weight: 200; font-family: 'Inter', sans-serif;">
                <%= @completed_today %> / <%= @total_habits %> completed (<%= @today_percentage %>%)
              </div>
            </div>

            <% if @today_habits.any? %>
              <!-- Render all habits once with grouping metadata -->
              <div id="focus-habits-container" class="space-y-4">
                <%
                  # Light color mapping
                  light_color_map = {
                    '#6B8A99' => '#E8EEF1', '#9C8B7E' => '#E8E0D5', '#F8796D' => '#FFD4CE',
                    '#FFA07A' => '#FFE4D6', '#E5C730' => '#FEF7C3', '#A8A356' => '#E8EBCD',
                    '#7CB342' => '#D7EDCB', '#6EE7B7' => '#D1FAF0', '#22D3EE' => '#CFFAFE',
                    '#6366F1' => '#E0E7FF', '#A78BFA' => '#EDE9FE', '#E879F9' => '#FAE8FF',
                    '#FB7185' => '#FFE4E6', '#9CA3A8' => '#E8E8E8'
                  }

                  # Create a single list of all habits with their grouping info
                  all_habits_with_groups = @habits.map do |habit|
                    time_block_id = habit.time_block_id || 'anytime'
                    time_group = time_block_id == 'anytime' ? 'anytime' : "block_#{time_block_id}"

                    priority_group = habit.importance_level_id ? "level_#{habit.importance_level_id}" : 'none'
                    category_group = "category_#{habit.category_id}"

                    {
                      habit: habit,
                      time_group: time_group,
                      time_block_id: time_block_id,
                      time_block_name: habit.time_block&.name || 'Anytime',
                      time_block_icon: habit.time_block&.icon || 'fa-clock',
                      time_block_color: habit.time_block&.color || '#1d3e4c',
                      time_block_rank: habit.time_block&.rank || 999,
                      priority_group: priority_group,
                      priority_name: habit.importance_level&.name || 'No Priority',
                      priority_rank: habit.importance_level&.rank || 999,
                      priority_color: habit.importance_level&.color || '#657b84',
                      priority_icon: habit.importance_level&.icon || 'fa-circle',
                      category_group: category_group,
                      category_name: habit.category.name,
                      category_color: habit.category.color,
                      category_icon: habit.category.icon
                    }
                  end

                  # Sort by time_block rank by default (anytime last)
                  all_habits_with_groups.sort_by! { |h| h[:time_block_rank] }
                %>

                <% all_habits_with_groups.each do |habit_data| %>
                  <%
                    habit = habit_data[:habit]
                    completion_count = @today_completions[habit.id] || 0
                    is_complete = completion_count >= habit.target_count
                    category = habit.category
                    light_color = light_color_map[category.color] || (category.color + '20')
                  %>
                  <div class="habit-item flex items-center gap-2"
                       data-habit-id="<%= habit.id %>"
                       data-target="<%= habit.target_count %>"
                       data-health="<%= habit.health %>"
                       data-time-group="<%= habit_data[:time_group] %>"
                       data-time-block-id="<%= habit_data[:time_block_id] %>"
                       data-time-block-name="<%= habit_data[:time_block_name] %>"
                       data-time-block-icon="<%= habit_data[:time_block_icon] %>"
                       data-time-block-color="<%= habit_data[:time_block_color] %>"
                       data-time-block-rank="<%= habit_data[:time_block_rank] %>"
                       data-priority-group="<%= habit_data[:priority_group] %>"
                       data-priority-name="<%= habit_data[:priority_name] %>"
                       data-priority-rank="<%= habit_data[:priority_rank] %>"
                       data-priority-color="<%= habit_data[:priority_color] %>"
                       data-priority-icon="<%= habit_data[:priority_icon] %>"
                       data-category-group="<%= habit_data[:category_group] %>"
                       data-category-name="<%= habit_data[:category_name] %>"
                       data-category-icon="<%= habit_data[:category_icon] %>"
                       data-category-color="<%= category.color %>"
                       data-light-color="<%= light_color %>">
                    <button
                      onclick="toggleDashboardHabit(<%= habit.id %>, <%= is_complete ? 'true' : 'false' %>)"
                      class="flex-shrink-0 cursor-pointer transition-transform hover:scale-110">
                      <% if is_complete %>
                        <i class="fa-solid fa-circle-check text-sm" style="color: <%= category.color %>;"></i>
                      <% else %>
                        <i class="fa-regular fa-circle text-sm" style="color: <%= light_color %>;"></i>
                      <% end %>
                    </button>
                    <div class="flex-1 flex items-center gap-2">
                      <div class="text-sm font-semibold <%= is_complete ? 'line-through opacity-60' : '' %>" style="color: <%= is_complete ? light_color : category.color %>;">
                        <%= habit.name %>
                      </div>
                      <% if habit.documents.any? %>
                        <%= link_to habit_content_path(habit.documents.first),
                            class: "flex-shrink-0 text-xs hover:opacity-70 transition",
                            style: "color: #{category.color};",
                            title: "View attached content",
                            data: { habit_content_modal: true } do %>
                          <i class="fa-solid fa-file-alt"></i>
                        <% end %>
                      <% end %>
                    </div>
                    <div class="text-xs font-light" style="color: #657b84;">
                      <%= completion_count %> / <%= habit.target_count %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="text-center py-8">
                <i class="fa-solid fa-check-circle text-4xl mb-2" style="color: #E5E5E7;"></i>
                <p class="text-sm" style="color: #8E8E93; font-weight: 200; font-family: 'Inter', sans-serif;">No habits for today</p>
              </div>
            <% end %>
          </div>

        <!-- Tasks Section -->
        <div class="rounded-xl p-6" style="background: #FFFFFF; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
          <div class="mb-4">
            <div class="flex items-center justify-between">
              <h2 class="text-2xl font-display" style="color: #1D1D1F;">Tasks</h2>
              <!-- Toggle Buttons -->
              <div class="flex gap-1 rounded-lg p-1" style="background: rgba(199, 199, 204, 0.2);">
                <button id="tasks-date-btn" onclick="switchTasksView('date')" class="px-2 py-1 rounded text-xs transition" style="background: linear-gradient(135deg, #2C2C2E, #1D1D1F); color: white; font-weight: 600; font-family: 'Inter', sans-serif; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);">
                  Date
                </button>
                <button id="tasks-category-btn" onclick="switchTasksView('category')" class="px-2 py-1 rounded text-xs transition" style="color: #8E8E93; font-weight: 600; font-family: 'Inter', sans-serif;">
                  Category
                </button>
                <button id="tasks-priority-btn" onclick="switchTasksView('priority')" class="px-2 py-1 rounded text-xs transition" style="color: #8E8E93; font-weight: 600; font-family: 'Inter', sans-serif;">
                  Priority
                </button>
              </div>
            </div>
          </div>

          <div id="tasks-container">
            <%
              # Build task data with metadata for all tasks
              all_tasks_with_groups = @tasks.map do |task|
                # Date grouping
                date_group = if task.due_date.nil?
                  'no_date'
                elsif task.due_date < @today
                  'overdue'
                elsif task.due_date == @today
                  'today'
                else
                  'future'
                end

                # Category grouping
                category_group = task.category_id ? "category_#{task.category_id}" : 'none'

                # Priority grouping
                priority_group = task.importance_level_id ? "level_#{task.importance_level_id}" : 'none'

                {
                  task: task,
                  date_group: date_group,
                  category_group: category_group,
                  category_name: task.category&.name || 'No Category',
                  category_color: task.category&.color || '#9CA3A8',
                  category_icon: task.category&.icon || 'fa-circle',
                  priority_group: priority_group,
                  priority_name: task.importance_level&.name || 'No Priority',
                  priority_rank: task.importance_level&.rank || 999,
                  priority_color: task.importance_level&.color || '#657b84',
                  priority_icon: task.importance_level&.icon || 'fa-circle'
                }
              end

              # Sort by date by default (overdue, today, no date, future)
              date_order = {'overdue' => 0, 'today' => 1, 'no_date' => 2, 'future' => 3}
              all_tasks_with_groups.sort_by! { |t| [date_order[t[:date_group]] || 999, t[:task].due_date || Date.new(9999)] }
            %>

            <% all_tasks_with_groups.each do |task_data| %>
              <%
                task = task_data[:task]
                color = case task_data[:date_group]
                when 'overdue' then '#F8796D'
                when 'today' then '#1d3e4c'
                else '#657b84'
                end
              %>
              <div class="task-item flex items-center gap-2 mb-2"
                   data-task-id="<%= task.id %>"
                   data-completed="<%= task.completed %>"
                   data-date-group="<%= task_data[:date_group] %>"
                   data-category-group="<%= task_data[:category_group] %>"
                   data-category-name="<%= task_data[:category_name] %>"
                   data-category-color="<%= task_data[:category_color] %>"
                   data-category-icon="<%= task_data[:category_icon] %>"
                   data-priority-group="<%= task_data[:priority_group] %>"
                   data-priority-name="<%= task_data[:priority_name] %>"
                   data-priority-rank="<%= task_data[:priority_rank] %>"
                   data-priority-color="<%= task_data[:priority_color] %>"
                   data-priority-icon="<%= task_data[:priority_icon] %>"
                   data-due-date="<%= task.due_date&.strftime('%b %d') || '' %>">
                <button
                  onclick="toggleTask(<%= task.id %>, <%= task.completed ? 'true' : 'false' %>)"
                  class="flex-shrink-0 cursor-pointer transition-transform hover:scale-110">
                  <% if task.completed %>
                    <i class="fa-solid fa-circle-check text-xs" style="color: <%= color %>;"></i>
                  <% else %>
                    <i class="fa-regular fa-circle text-xs" style="color: <%= color %>;"></i>
                  <% end %>
                </button>
                <span class="flex-1 text-sm <%= task.completed ? 'line-through opacity-60' : '' %>" style="color: <%= color %>;"><%= task.name %></span>
                <% if task.due_date %>
                  <span class="text-xs" style="color: <%= color %>;"><%= task.due_date.strftime('%b %d') %></span>
                <% end %>
              </div>
            <% end %>

            <% if @tasks.empty? %>
              <div class="text-center py-8">
                <i class="fa-solid fa-list-check text-4xl mb-2" style="color: #E5E5E7;"></i>
                <p class="text-sm" style="color: #8E8E93; font-weight: 200; font-family: 'Inter', sans-serif;">No tasks yet</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- React Modal Root for Dashboard -->
<div id="dashboard-modals-root"></div>

<script>
// Today's Focus view toggle
function switchFocusView(view) {
  const container = document.getElementById('focus-habits-container');
  const timeBtn = document.getElementById('focus-time-btn');
  const categoryBtn = document.getElementById('focus-category-btn');
  const priorityBtn = document.getElementById('focus-priority-btn');

  // Update button styles
  timeBtn.style.background = '';
  timeBtn.style.boxShadow = '';
  timeBtn.style.color = '#8E8E93';
  categoryBtn.style.background = '';
  categoryBtn.style.boxShadow = '';
  categoryBtn.style.color = '#8E8E93';
  priorityBtn.style.background = '';
  priorityBtn.style.boxShadow = '';
  priorityBtn.style.color = '#8E8E93';

  if (view === 'time') {
    timeBtn.style.background = 'linear-gradient(135deg, #2C2C2E, #1D1D1F)';
    timeBtn.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.2)';
    timeBtn.style.color = 'white';
  } else if (view === 'category') {
    categoryBtn.style.background = 'linear-gradient(135deg, #2C2C2E, #1D1D1F)';
    categoryBtn.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.2)';
    categoryBtn.style.color = 'white';
  } else {
    priorityBtn.style.background = 'linear-gradient(135deg, #2C2C2E, #1D1D1F)';
    priorityBtn.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.2)';
    priorityBtn.style.color = 'white';
  }

  // Get all habit items
  const habitItems = Array.from(container.querySelectorAll('.habit-item'));

  // Group and sort based on view
  let groups = {};
  let groupOrder = [];
  let groupIcons = {};

  if (view === 'time') {
    // Group by user-defined time blocks
    const timeGroups = {};

    habitItems.forEach(item => {
      const group = item.dataset.timeGroup;
      const name = item.dataset.timeBlockName;
      const rank = parseInt(item.dataset.timeBlockRank);
      const color = item.dataset.timeBlockColor;
      const icon = item.dataset.timeBlockIcon;

      if (!timeGroups[group]) {
        timeGroups[group] = {
          name: name,
          rank: rank,
          color: color,
          icon: icon,
          items: []
        };
      }
      timeGroups[group].items.push(item);
    });

    // Sort groups by rank (anytime will have rank 999)
    groupOrder = Object.keys(timeGroups).sort((a, b) => {
      return timeGroups[a].rank - timeGroups[b].rank;
    });

    // Build groups object and icons
    groupOrder.forEach(key => {
      groups[key] = timeGroups[key].items;
      groupIcons[key] = timeGroups[key].icon;
    });
  } else if (view === 'category') {
    // Group by category
    const categoryGroups = {};

    habitItems.forEach(item => {
      const group = item.dataset.categoryGroup;
      const name = item.dataset.categoryName;
      const color = item.dataset.categoryColor;
      const icon = item.dataset.categoryIcon;

      if (!categoryGroups[group]) {
        categoryGroups[group] = {
          name: name,
          color: color,
          icon: icon,
          items: []
        };
      }
      categoryGroups[group].items.push(item);
    });

    // Sort groups alphabetically by name
    groupOrder = Object.keys(categoryGroups).sort((a, b) => {
      return categoryGroups[a].name.localeCompare(categoryGroups[b].name);
    });

    // Build groups object and icons
    groupOrder.forEach(key => {
      groups[key] = categoryGroups[key].items;
      groupIcons[key] = categoryGroups[key].icon;
    });
  } else {
    // Group by user-defined importance levels
    const priorityGroups = {};

    habitItems.forEach(item => {
      const group = item.dataset.priorityGroup;
      const name = item.dataset.priorityName;
      const rank = parseInt(item.dataset.priorityRank);
      const color = item.dataset.priorityColor;
      const icon = item.dataset.priorityIcon;

      if (!priorityGroups[group]) {
        priorityGroups[group] = {
          name: name,
          rank: rank,
          color: color,
          icon: icon,
          items: []
        };
      }
      priorityGroups[group].items.push(item);
    });

    // Sort groups by rank
    groupOrder = Object.keys(priorityGroups).sort((a, b) => {
      return priorityGroups[a].rank - priorityGroups[b].rank;
    });

    // Build groups object and icons
    groupOrder.forEach(key => {
      groups[key] = priorityGroups[key].items;
      groupIcons[key] = priorityGroups[key].icon;
    });
  }

  // Clear container
  container.innerHTML = '';

  // Rebuild with headers
  let isFirst = true;
  groupOrder.forEach(groupName => {
    if (!groups[groupName] || groups[groupName].length === 0) return;

    // Get color based on view
    let groupColor = '#8E8E93'; // Default metallic grey for time
    let groupIconClass = groupIcons[groupName] || 'fa-clock';
    let groupTitle = groupName.charAt(0).toUpperCase() + groupName.slice(1);

    if (view === 'category' && groups[groupName].length > 0) {
      groupColor = groups[groupName][0].dataset.categoryColor;
      groupTitle = groups[groupName][0].dataset.categoryName;
    } else if (view === 'priority' && groups[groupName].length > 0) {
      groupColor = groups[groupName][0].dataset.priorityColor;
      groupTitle = groups[groupName][0].dataset.priorityName;
    } else if (view === 'time' && groups[groupName].length > 0) {
      groupColor = '#8E8E93'; // Metallic grey for time blocks
      groupTitle = groups[groupName][0].dataset.timeBlockName;
    }

    // Create group container
    const groupDiv = document.createElement('div');
    groupDiv.className = isFirst ? 'mb-4' : 'mb-4 mt-4';

    // Create full-width stripe header
    const headerDiv = document.createElement('div');
    headerDiv.className = '-mx-6 px-6 py-2 mb-3 flex items-center gap-2';
    headerDiv.style.background = `linear-gradient(to bottom, color-mix(in srgb, ${groupColor} 85%, white) 0%, ${groupColor} 100%)`;
    headerDiv.style.boxShadow = '0 2px 6px rgba(0, 0, 0, 0.1)';

    // Add icon
    const icon = document.createElement('i');
    icon.className = `fa-solid ${groupIconClass} text-white text-sm`;
    headerDiv.appendChild(icon);

    // Add title
    const title = document.createElement('span');
    title.className = 'text-lg text-white font-display';
    title.style.fontWeight = '500';
    title.textContent = groupTitle;
    headerDiv.appendChild(title);

    // Create habits container
    const habitsDiv = document.createElement('div');
    habitsDiv.className = 'space-y-2';

    groups[groupName].forEach(habitItem => {
      habitsDiv.appendChild(habitItem);
    });

    groupDiv.appendChild(headerDiv);
    groupDiv.appendChild(habitsDiv);
    container.appendChild(groupDiv);
    isFirst = false;
  });
}

// Track all habits and their completion states
const habitStates = new Map();
let totalHabitsCount = 0;

// Initialize habit states on page load
document.addEventListener('DOMContentLoaded', () => {
  // Initialize habit states BEFORE reorganizing view
  document.querySelectorAll('.habit-item[data-habit-id]').forEach(row => {
    const habitId = parseInt(row.dataset.habitId);
    const targetCount = parseInt(row.dataset.target);
    const countText = row.querySelector('.text-xs').textContent.trim();
    const currentCount = parseInt(countText.split('/')[0]);

    habitStates.set(habitId, {
      currentCount,
      targetCount,
      isComplete: currentCount >= targetCount
    });
  });
  totalHabitsCount = habitStates.size;

  // Now initialize the view to time grouping
  switchFocusView('time');
});

async function toggleDashboardHabit(habitId, wasComplete) {
  const action = wasComplete ? 'decrement' : 'increment';

  try {
    const response = await fetch(`/habits/${habitId}/completions/${action}`, {
      method: 'POST',
      headers: {
        'X-CSRF-Token': document.querySelector('[name=csrf-token]').content,
        'Content-Type': 'application/json'
      }
    });

    const data = await response.json();

    // Find the habit row - use more specific selector
    const habitRow = document.querySelector(`.habit-item[data-habit-id="${habitId}"]`);
    if (!habitRow) {
      console.error('Could not find habit row for ID:', habitId);
      return;
    }

    const button = habitRow.querySelector('button');
    const icon = button.querySelector('i');
    const nameDiv = habitRow.querySelector('.flex-1');
    const countDiv = habitRow.querySelector('.text-xs');
    const targetCount = parseInt(habitRow.dataset.target);

    // Get category colors from data attributes
    const categoryColor = habitRow.dataset.categoryColor;
    const lightColor = habitRow.dataset.lightColor;

    // Store habit's health data for later updates
    habitRow.dataset.health = data.health;

    // Update state
    const oldState = habitStates.get(habitId);
    const newIsComplete = data.count >= targetCount;
    const statusChanged = oldState && oldState.isComplete !== newIsComplete;

    habitStates.set(habitId, {
      currentCount: data.count,
      targetCount,
      isComplete: newIsComplete
    });

    // Update UI
    if (newIsComplete) {
      icon.className = 'fa-solid fa-circle-check text-sm';
      icon.style.color = categoryColor;
      nameDiv.classList.add('line-through', 'opacity-60');
      nameDiv.style.color = lightColor;
    } else {
      icon.className = 'fa-regular fa-circle text-sm';
      icon.style.color = lightColor;
      nameDiv.classList.remove('line-through', 'opacity-60');
      nameDiv.style.color = categoryColor;
    }

    countDiv.textContent = `${data.count} / ${targetCount}`;
    button.setAttribute('onclick', `toggleDashboardHabit(${habitId}, ${newIsComplete})`);

    // Recalculate totals
    let totalComplete = 0;
    habitStates.forEach(state => {
      if (state.isComplete) totalComplete++;
    });

    const percentage = totalHabitsCount > 0 ? Math.round((totalComplete * 100) / totalHabitsCount) : 0;

    // Update header
    const completionHeader = document.getElementById('today-completion-count');
    if (completionHeader) {
      completionHeader.textContent = `${totalComplete} / ${totalHabitsCount} completed (${percentage}%)`;
    }

  } catch (error) {
    console.error('Error toggling habit:', error);
  }
}

// Tasks view toggle
function switchTasksView(view) {
  const container = document.getElementById('tasks-container');
  const dateBtn = document.getElementById('tasks-date-btn');
  const categoryBtn = document.getElementById('tasks-category-btn');
  const priorityBtn = document.getElementById('tasks-priority-btn');

  // Update button styles
  dateBtn.style.background = '';
  dateBtn.style.boxShadow = '';
  dateBtn.style.color = '#8E8E93';
  categoryBtn.style.background = '';
  categoryBtn.style.boxShadow = '';
  categoryBtn.style.color = '#8E8E93';
  priorityBtn.style.background = '';
  priorityBtn.style.boxShadow = '';
  priorityBtn.style.color = '#8E8E93';

  if (view === 'date') {
    dateBtn.style.background = 'linear-gradient(135deg, #2C2C2E, #1D1D1F)';
    dateBtn.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.2)';
    dateBtn.style.color = 'white';
  } else if (view === 'category') {
    categoryBtn.style.background = 'linear-gradient(135deg, #2C2C2E, #1D1D1F)';
    categoryBtn.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.2)';
    categoryBtn.style.color = 'white';
  } else {
    priorityBtn.style.background = 'linear-gradient(135deg, #2C2C2E, #1D1D1F)';
    priorityBtn.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.2)';
    priorityBtn.style.color = 'white';
  }

  // Get all task items
  const taskItems = Array.from(container.querySelectorAll('.task-item'));

  if (taskItems.length === 0) return;

  // Group and sort based on view
  let groups = {};
  let groupOrder = [];
  let groupLabels = {};
  let groupColors = {};

  if (view === 'date') {
    groupOrder = ['overdue', 'today', 'no_date', 'future'];
    groupLabels = {
      'overdue': 'Overdue',
      'today': 'Due Today',
      'no_date': 'No Due Date',
      'future': 'Upcoming'
    };
    groupColors = {
      'overdue': '#F8796D',
      'today': '#1d3e4c',
      'no_date': '#657b84',
      'future': '#657b84'
    };

    taskItems.forEach(item => {
      const group = item.dataset.dateGroup;
      if (!groups[group]) groups[group] = [];
      groups[group].push(item);
    });
  } else if (view === 'category') {
    // Group by category
    const categoryGroups = {};

    taskItems.forEach(item => {
      const group = item.dataset.categoryGroup;
      const name = item.dataset.categoryName;
      const color = item.dataset.categoryColor;

      if (!categoryGroups[group]) {
        categoryGroups[group] = {
          name: name,
          color: color,
          items: []
        };
      }
      categoryGroups[group].items.push(item);
    });

    // Sort groups alphabetically by name
    groupOrder = Object.keys(categoryGroups).sort((a, b) => {
      return categoryGroups[a].name.localeCompare(categoryGroups[b].name);
    });

    // Build groups object and labels
    groupOrder.forEach(key => {
      groups[key] = categoryGroups[key].items;
      groupLabels[key] = categoryGroups[key].name;
      groupColors[key] = categoryGroups[key].color;
    });
  } else {
    // Group by priority
    const priorityGroups = {};

    taskItems.forEach(item => {
      const group = item.dataset.priorityGroup;
      const name = item.dataset.priorityName;
      const rank = parseInt(item.dataset.priorityRank);
      const color = item.dataset.priorityColor;
      const icon = item.dataset.priorityIcon;

      if (!priorityGroups[group]) {
        priorityGroups[group] = {
          name: name,
          rank: rank,
          color: color,
          icon: icon,
          items: []
        };
      }
      priorityGroups[group].items.push(item);
    });

    // Sort groups by rank
    groupOrder = Object.keys(priorityGroups).sort((a, b) => {
      return priorityGroups[a].rank - priorityGroups[b].rank;
    });

    // Build groups object, labels, and colors
    groupOrder.forEach(key => {
      groups[key] = priorityGroups[key].items;
      groupLabels[key] = priorityGroups[key].name;
      groupColors[key] = priorityGroups[key].color;
    });
  }

  // Clear container
  container.innerHTML = '';

  // Define icons for date groups
  const dateIcons = {
    'overdue': 'fa-exclamation-triangle',
    'today': 'fa-calendar-day',
    'no_date': 'fa-infinity',
    'future': 'fa-calendar-alt'
  };

  // Rebuild with headers
  let isFirst = true;
  groupOrder.forEach(groupName => {
    if (!groups[groupName] || groups[groupName].length === 0) return;

    // Get color and icon based on view
    let groupColor = '#8E8E93'; // Default metallic grey
    let groupIconClass = 'fa-list';
    let groupTitle = groupLabels[groupName] || groupName;

    if (view === 'date') {
      groupColor = '#8E8E93'; // Metallic grey for date groups
      groupIconClass = dateIcons[groupName] || 'fa-calendar';
    } else if (view === 'category' && groups[groupName].length > 0) {
      groupColor = groupColors[groupName] || '#8E8E93';
      groupIconClass = groups[groupName][0].dataset.categoryIcon || 'fa-folder';
    } else if (view === 'priority' && groups[groupName].length > 0) {
      groupColor = groupColors[groupName] || '#8E8E93';
      groupIconClass = groups[groupName][0].dataset.priorityIcon || 'fa-star';
    }

    // Create group container
    const groupDiv = document.createElement('div');
    groupDiv.className = isFirst ? 'mb-4' : 'mb-4 mt-4';

    // Create full-width stripe header
    const headerDiv = document.createElement('div');
    headerDiv.className = '-mx-6 px-6 py-2 mb-3 flex items-center gap-2';
    headerDiv.style.background = `linear-gradient(to bottom, color-mix(in srgb, ${groupColor} 85%, white) 0%, ${groupColor} 100%)`;
    headerDiv.style.boxShadow = '0 2px 6px rgba(0, 0, 0, 0.1)';

    // Add icon
    const icon = document.createElement('i');
    icon.className = `fa-solid ${groupIconClass} text-white text-sm`;
    headerDiv.appendChild(icon);

    // Add title
    const title = document.createElement('span');
    title.className = 'text-lg text-white font-display';
    title.style.fontWeight = '500';
    title.textContent = groupTitle;
    headerDiv.appendChild(title);

    // Create tasks container
    const tasksDiv = document.createElement('div');
    tasksDiv.className = 'space-y-2';

    groups[groupName].forEach(taskItem => {
      tasksDiv.appendChild(taskItem);
    });

    groupDiv.appendChild(headerDiv);
    groupDiv.appendChild(tasksDiv);
    container.appendChild(groupDiv);
    isFirst = false;
  });
}

// Initialize tasks view on page load
document.addEventListener('DOMContentLoaded', () => {
  const tasksContainer = document.getElementById('tasks-container');
  if (tasksContainer && tasksContainer.querySelectorAll('.task-item').length > 0) {
    switchTasksView('date');
  }
});

// Toggle task completion
async function toggleTask(taskId, wasCompleted) {
  const newCompleted = !wasCompleted;

  try {
    const response = await fetch(`/tasks/${taskId}`, {
      method: 'PATCH',
      headers: {
        'X-CSRF-Token': document.querySelector('[name=csrf-token]').content,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        task: {
          completed: newCompleted,
          completed_at: newCompleted ? new Date().toISOString() : null
        }
      })
    });

    const data = await response.json();

    if (data.success) {
      // Find the task item
      const taskItem = document.querySelector(`.task-item[data-task-id="${taskId}"]`);
      if (!taskItem) {
        console.error('Could not find task item for ID:', taskId);
        return;
      }

      // Update data attribute
      taskItem.dataset.completed = newCompleted;

      // Find elements
      const button = taskItem.querySelector('button');
      const icon = button.querySelector('i');
      const nameSpan = taskItem.querySelector('.flex-1');

      // Get color from data attributes based on date group
      const dateGroup = taskItem.dataset.dateGroup;
      const color = dateGroup === 'overdue' ? '#F8796D' : (dateGroup === 'today' ? '#1d3e4c' : '#657b84');

      // Update UI
      if (newCompleted) {
        icon.className = 'fa-solid fa-circle-check text-xs';
        icon.style.color = color;
        nameSpan.classList.add('line-through', 'opacity-60');
      } else {
        icon.className = 'fa-regular fa-circle text-xs';
        icon.style.color = color;
        nameSpan.classList.remove('line-through', 'opacity-60');
      }

      button.setAttribute('onclick', `toggleTask(${taskId}, ${newCompleted})`);
    } else {
      console.error('Error toggling task:', data.errors);
    }
  } catch (error) {
    console.error('Error toggling task:', error);
  }
}
</script>
