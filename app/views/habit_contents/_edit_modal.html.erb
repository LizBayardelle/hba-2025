<!-- Edit Document Modal -->
<div x-show="editDocumentId === <%= content.id %>" @click.self="editDocumentId = null" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4" style="z-index: 100;" x-cloak>
  <div @click.stop class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col" x-data="{
    selectedHabitIds: <%= content.habit_ids.to_json %>,
    showHabitDropdown: false
  }">
    <div class="p-6 md:p-8 overflow-y-auto flex-1">
      <h2 class="text-2xl font-bold mb-6 display-font" style="color: #1d3e4c;">Edit Document</h2>

      <form @submit.prevent="updateDocument(<%= content.id %>)" id="edit-form-<%= content.id %>">
      <div id="edit-modal-errors-<%= content.id %>"></div>

      <!-- Attach to Habits -->
      <div class="mb-6">
        <label class="block text-sm font-semibold mb-2" style="color: #1d3e4c;">Attach to Habits (optional)</label>
        <div class="relative">
          <button type="button" @click="showHabitDropdown = !showHabitDropdown" class="w-full px-4 py-3 rounded-lg border-2 focus:outline-none transition font-light text-left flex items-center justify-between" style="border-color: #E8EEF1;">
            <span x-text="selectedHabitIds.length === 0 ? 'No habits selected' : selectedHabitIds.length + ' habit(s) selected'" style="color: #657b84;"></span>
            <i class="fa-solid fa-chevron-down text-sm" style="color: #657b84;"></i>
          </button>

          <!-- Dropdown with checkboxes -->
          <div x-show="showHabitDropdown" @click.away="showHabitDropdown = false" class="absolute z-10 w-full mt-2 bg-white border-2 rounded-lg shadow-lg max-h-60 overflow-y-auto" style="border-color: #E8EEF1;">
            <% Habit.joins(:user).where(users: { id: current_user.id }).where(archived_at: nil).includes(:category).order('categories.name, habits.name').group_by(&:category).each do |category, habits| %>
              <div class="p-2 border-b" style="border-color: #E8EEF1;">
                <div class="text-xs font-semibold uppercase tracking-wide px-2 py-1" style="color: #657b84;">
                  <%= category.name %>
                </div>
                <% habits.each do |habit| %>
                  <label class="flex items-center gap-2 px-2 py-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox"
                           name="habit_content[habit_ids][]"
                           value="<%= habit.id %>"
                           x-model="selectedHabitIds"
                           class="rounded border-gray-300">
                    <span class="text-sm font-light" style="color: #1d3e4c;"><%= habit.name %></span>
                  </label>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
        <p class="text-xs font-light mt-2" style="color: #657b84;">
          Documents can exist without being attached to any habit
        </p>
      </div>

      <!-- Content Type (read-only) -->
      <div class="mb-6">
        <label class="block text-sm font-semibold mb-2" style="color: #1d3e4c;">Content Type</label>
        <div class="px-4 py-3 rounded-lg bg-gray-100 font-light text-gray-600 capitalize">
          <%= content.content_type %>
        </div>
        <input type="hidden" name="habit_content[content_type]" value="<%= content.content_type %>">
      </div>

      <!-- Title -->
      <div class="mb-6">
        <label class="block text-sm font-semibold mb-2" style="color: #1d3e4c;">Title</label>
        <input type="text" name="habit_content[title]" value="<%= content.title %>"
            class="w-full px-4 py-3 rounded-lg border-2 focus:outline-none transition font-light"
            style="border-color: #E8EEF1;">
      </div>

      <!-- URL Field (for youtube, video, link) -->
      <% if ['youtube', 'video', 'link'].include?(content.content_type) %>
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2" style="color: #1d3e4c;">URL</label>
          <input type="text" name="habit_content[metadata][url]" value="<%= content.metadata['url'] %>"
              class="w-full px-4 py-3 rounded-lg border-2 focus:outline-none transition font-light"
              style="border-color: #E8EEF1;">
        </div>
      <% end %>

      <!-- Document Body (for document type) -->
      <% if content.content_type == 'document' %>
        <div class="mb-6">
          <label class="block text-sm font-semibold mb-2" style="color: #1d3e4c;">Document Content</label>
          <input type="hidden" name="habit_content[body]" id="edit-document-body-hidden-<%= content.id %>" value="<%= content.body.to_s.gsub('"', '&quot;') %>">
          <trix-editor input="edit-document-body-hidden-<%= content.id %>" class="trix-content" style="min-height: 200px;"></trix-editor>
        </div>
      <% end %>

        <!-- Actions -->
        <div class="flex gap-3 justify-between">
          <div>
            <button type="button" @click="deleteDocument(<%= content.id %>)" class="px-6 py-3 rounded-lg font-semibold border-2 transition" style="color: #DC2626; border-color: #FEE2E2;">
              Delete
            </button>
          </div>
          <div class="flex gap-3">
            <button type="button" @click="editDocumentId = null" class="px-6 py-3 rounded-lg font-semibold border-2 transition" style="color: #1d3e4c; border-color: #E8EEF1;">
              Cancel
            </button>
            <button type="submit" class="px-6 py-3 rounded-lg text-white font-semibold shadow-lg hover:shadow-xl transition cursor-pointer" style="background: linear-gradient(135deg, #1d3e4c, #45606b);">
              Update Document
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
