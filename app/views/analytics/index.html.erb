<div class="flex h-screen relative" style="background-color: #F5F5F7;">
  <%= render 'shared/sidebar' %>

  <!-- Mobile overlay -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 md:hidden hidden"></div>

  <!-- Menu flag button -->
  <button id="menu-button" class="fixed left-0 z-20 md:hidden rounded-r-lg shadow-lg flex items-center justify-center py-1.5 px-3 cursor-move"
    style="top: 200px; background: linear-gradient(135deg, #424245, #2C2C2E); writing-mode: vertical-rl;">
    <span class="text-white font-bold text-sm tracking-wider">MENU</span>
  </button>

  <script>
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const menuButton = document.getElementById('menu-button');
    const closeButton = document.getElementById('sidebar-close');

    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      sidebar.classList.add('translate-x-0');
      overlay.classList.remove('hidden');
      menuButton.classList.add('hidden');
    }

    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      sidebar.classList.remove('translate-x-0');
      overlay.classList.add('hidden');
      menuButton.classList.remove('hidden');
    }

    // Draggable menu button
    let isDragging = false;
    let startY = 0;
    let startTop = 200;
    let dragStartTime = 0;

    menuButton.addEventListener('mousedown', (e) => {
      isDragging = true;
      dragStartTime = Date.now();
      startY = e.clientY;
      startTop = parseInt(menuButton.style.top) || 200;
      e.preventDefault();
    });

    menuButton.addEventListener('touchstart', (e) => {
      isDragging = true;
      dragStartTime = Date.now();
      startY = e.touches[0].clientY;
      startTop = parseInt(menuButton.style.top) || 200;
    });

    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        const deltaY = e.clientY - startY;
        const newTop = Math.max(0, Math.min(window.innerHeight - menuButton.offsetHeight, startTop + deltaY));
        menuButton.style.top = newTop + 'px';
        localStorage.setItem('menuButtonTop', newTop);
      }
    });

    document.addEventListener('touchmove', (e) => {
      if (isDragging) {
        const deltaY = e.touches[0].clientY - startY;
        const newTop = Math.max(0, Math.min(window.innerHeight - menuButton.offsetHeight, startTop + deltaY));
        menuButton.style.top = newTop + 'px';
        localStorage.setItem('menuButtonTop', newTop);
      }
    });

    document.addEventListener('mouseup', (e) => {
      if (isDragging) {
        const dragDuration = Date.now() - dragStartTime;
        const dragDistance = Math.abs(e.clientY - startY);

        if (dragDuration < 200 && dragDistance < 5) {
          openSidebar();
        }
        isDragging = false;
      }
    });

    document.addEventListener('touchend', (e) => {
      if (isDragging) {
        const dragDuration = Date.now() - dragStartTime;
        if (dragDuration < 200) {
          openSidebar();
        }
        isDragging = false;
      }
    });

    closeButton.addEventListener('click', closeSidebar);
    overlay.addEventListener('click', closeSidebar);

    const savedTop = localStorage.getItem('menuButtonTop');
    if (savedTop) {
      menuButton.style.top = savedTop + 'px';
    }
  </script>

  <!-- Main Content Area -->
  <main class="flex-1 overflow-y-auto" style="background-color: #F5F5F5;">
    <!-- White Header Section with Shadow -->
    <div style="background: #FFFFFF; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);">
      <div class="p-8">
        <h1 class="text-5xl font-display" style="color: #1D1D1F;">Analytics</h1>
        <p class="text-sm mt-1" style="color: #8E8E93; font-family: 'Inter', sans-serif; font-weight: 300;">
          Track your habit activity and health
        </p>
      </div>
    </div>

    <!-- Grey Background Content -->
    <div class="p-8 pt-6 space-y-6">
      <!-- Calendar Heatmap -->
      <div class="bg-white rounded-xl p-6" style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
        <h2 class="text-2xl font-display mb-4" style="color: #1D1D1F;">Activity</h2>

        <!-- Overall Heatmap -->
        <div class="mb-6">
          <h3 class="text-sm font-semibold mb-3" style="color: #1D1D1F;">Overall</h3>
          <div class="flex flex-col lg:flex-row gap-8">
            <div class="flex-1 overflow-x-auto">
              <div class="inline-block">
                <div class="flex gap-1">
                  <!-- Day labels -->
                  <div class="flex flex-col gap-1 mr-1">
                    <div class="w-4 h-3 text-[10px] flex items-center" style="color: #8E8E93;">S</div>
                    <div class="w-4 h-3 text-[10px] flex items-center" style="color: #8E8E93;">M</div>
                    <div class="w-4 h-3 text-[10px] flex items-center" style="color: #8E8E93;">T</div>
                    <div class="w-4 h-3 text-[10px] flex items-center" style="color: #8E8E93;">W</div>
                    <div class="w-4 h-3 text-[10px] flex items-center" style="color: #8E8E93;">T</div>
                    <div class="w-4 h-3 text-[10px] flex items-center" style="color: #8E8E93;">F</div>
                    <div class="w-4 h-3 text-[10px] flex items-center" style="color: #8E8E93;">S</div>
                  </div>

                  <%
                    # Group heatmap data by week
                    weeks = []
                    current_week = []
                    @heatmap_data.keys.sort.each_with_index do |date_str, index|
                      date = Date.parse(date_str)
                      current_week << { date: date, percentage: @heatmap_data[date_str] }

                      # Start new week on Sunday or at the end
                      if date.wday == 6 || index == @heatmap_data.keys.length - 1
                        weeks << current_week
                        current_week = []
                      end
                    end
                  %>

                  <% weeks.each do |week| %>
                    <div class="flex flex-col gap-1">
                      <% 7.times do |day_index| %>
                        <% day_data = week[day_index] %>
                        <% if day_data %>
                          <%
                            percentage = day_data[:percentage]
                            color = if percentage == 0
                              '#E8EEF1'
                            elsif percentage < 25
                              '#c8dce4'
                            elsif percentage < 50
                              '#8fb9ca'
                            elsif percentage < 75
                              '#5696b0'
                            elsif percentage < 100
                              '#2d7088'
                            else
                              '#1D1D1F'
                            end
                          %>
                          <a href="<%= habits_path(date: day_data[:date].to_s, view: 'category') %>"
                            class="w-3 h-3 rounded-sm transition-all hover:ring-2 hover:ring-offset-1 hover:ring-gray-400 cursor-pointer block"
                            style="background-color: <%= color %>;"
                            title="<%= day_data[:date].strftime('%B %d, %Y') %>: <%= percentage %>% complete">
                          </a>
                        <% else %>
                          <div class="w-3 h-3"></div>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                </div>

                <!-- Legend -->
                <div class="flex items-center gap-2 mt-4 text-xs" style="color: #8E8E93;">
                  <span>Less</span>
                  <div class="w-3 h-3 rounded-sm" style="background-color: #E8EEF1;"></div>
                  <div class="w-3 h-3 rounded-sm" style="background-color: #c8dce4;"></div>
                  <div class="w-3 h-3 rounded-sm" style="background-color: #8fb9ca;"></div>
                  <div class="w-3 h-3 rounded-sm" style="background-color: #5696b0;"></div>
                  <div class="w-3 h-3 rounded-sm" style="background-color: #2d7088;"></div>
                  <div class="w-3 h-3 rounded-sm" style="background-color: #1D1D1F;"></div>
                  <span>More</span>
                </div>
              </div>
            </div>

            <!-- Stats -->
            <div class="flex-shrink-0 lg:w-64 w-full space-y-2 text-sm">
              <div class="flex items-center justify-between border-b border-dotted pb-2" style="border-color: rgba(199, 199, 204, 0.3);">
                <span class="font-light" style="color: #8E8E93;">Current Streak</span>
                <span class="font-semibold" style="color: #1D1D1F;"><%= @current_streak %> <%= @current_streak == 1 ? 'day' : 'days' %></span>
              </div>
              <div class="flex items-center justify-between border-b border-dotted pb-2" style="border-color: rgba(199, 199, 204, 0.3);">
                <span class="font-light" style="color: #8E8E93;">This Week</span>
                <span class="font-semibold" style="color: #1D1D1F;"><%= @weekly_completions %> <%= @weekly_completions == 1 ? 'completion' : 'completions' %></span>
              </div>
              <div class="flex items-center justify-between border-b border-dotted pb-2" style="border-color: rgba(199, 199, 204, 0.3);">
                <div class="flex items-center gap-2">
                  <span class="font-light" style="color: #8E8E93;">Overall Health</span>
                  <div class="relative group">
                    <i class="fa-solid fa-circle-info text-xs cursor-help" style="color: #8E8E93;"></i>
                    <%= render 'shared/health_explanation' %>
                  </div>
                </div>
                <span class="font-semibold" style="color: #1D1D1F;"><%= @overall_health %>%</span>
              </div>
              <div class="flex items-center justify-between border-b border-dotted pb-2" style="border-color: rgba(199, 199, 204, 0.3);">
                <span class="font-light" style="color: #8E8E93;">Habits at Risk</span>
                <span class="font-semibold" style="color: #1D1D1F;"><%= @habits_at_risk %></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Per-Category Heatmaps -->
        <% if @categories.any? %>
          <%
            # Calculate gradient colors for category heatmaps
            def calculate_category_gradient(base_color, percentage)
              # Convert hex to RGB
              r = base_color[1..2].to_i(16)
              g = base_color[3..4].to_i(16)
              b = base_color[5..6].to_i(16)

              # Create gradient from very light to full color
              if percentage == 0
                '#E8EEF1'  # Empty state
              else
                # Interpolate between white (255,255,255) and base color
                intensity = percentage / 100.0
                new_r = (255 + (r - 255) * intensity).round
                new_g = (255 + (g - 255) * intensity).round
                new_b = (255 + (b - 255) * intensity).round
                "#%02x%02x%02x" % [new_r, new_g, new_b]
              end
            end
          %>

          <!-- Toggle button for category heatmaps -->
          <button id="category-heatmaps-toggle" onclick="toggleCategoryHeatmaps()" class="flex items-center gap-2 text-sm font-semibold mb-3 transition hover:opacity-70" style="color: #1D1D1F;">
            <i id="category-chevron" class="fa-solid fa-chevron-right text-xs transition-transform"></i>
            <span>By Category</span>
          </button>

          <div id="category-heatmaps" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden">
            <% @categories.each do |category| %>
              <div>
                <div class="flex items-center gap-2 mb-2">
                  <i class="<%= category.icon %> text-xs" style="color: <%= category.color %>;"></i>
                  <h3 class="text-xs font-semibold" style="color: <%= category.color %>;"><%= category.name %></h3>
                </div>
                <div class="overflow-x-auto">
                  <div class="inline-block">
                    <div class="flex gap-1">
                      <%
                        # Group category heatmap data by week
                        cat_weeks = []
                        cat_current_week = []
                        @category_heatmap_data[category.id].keys.sort.each_with_index do |date_str, index|
                          date = Date.parse(date_str)
                          cat_current_week << { date: date, percentage: @category_heatmap_data[category.id][date_str] }

                          # Start new week on Sunday or at the end
                          if date.wday == 6 || index == @category_heatmap_data[category.id].keys.length - 1
                            cat_weeks << cat_current_week
                            cat_current_week = []
                          end
                        end
                      %>

                      <% cat_weeks.each do |week| %>
                        <div class="flex flex-col gap-1">
                          <% 7.times do |day_index| %>
                            <% day_data = week[day_index] %>
                            <% if day_data %>
                              <%
                                percentage = day_data[:percentage]
                                color = calculate_category_gradient(category.color, percentage)
                              %>
                              <a href="<%= habits_path(date: day_data[:date].to_s, view: 'category') %>"
                                class="w-3 h-3 rounded-sm transition-all hover:ring-2 hover:ring-offset-1 hover:ring-gray-400 cursor-pointer block"
                                style="background-color: <%= color %>;"
                                title="<%= category.name %> - <%= day_data[:date].strftime('%B %d, %Y') %>: <%= percentage %>% complete">
                              </a>
                            <% else %>
                              <div class="w-3 h-3"></div>
                            <% end %>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- Controls Bar -->
      <div class="py-2 mb-0 flex gap-2 items-center justify-between">
        <div>
          <h2 class="text-2xl font-display" style="color: #1D1D1F;">Habit Health Overview</h2>
          <p class="text-xs mt-0.5" style="color: #8E8E93; font-family: 'Inter', sans-serif; font-weight: 300;">
            Like a video game health bar—one mistake won't reset everything
          </p>
        </div>

        <!-- View Toggle -->
        <div>
          <span class="block text-xs uppercase tracking-wide mb-2" style="color: #8E8E93; font-weight: 600;">Group By</span>
          <div class="flex rounded-lg overflow-hidden" style="border: 0.5px solid rgba(199, 199, 204, 0.3);">
            <%= link_to analytics_path(view: 'category'), class: "px-4 py-2 text-sm transition", style: @view_mode == 'category' ? "background: linear-gradient(to bottom, #A8A8AD 0%, #8E8E93 100%); color: #FFFFFF; font-weight: 500; font-family: 'Inter', sans-serif;" : "background: #F5F5F7; color: #1D1D1F; font-weight: 500; font-family: 'Inter', sans-serif;" do %>
              Category
            <% end %>
            <%= link_to analytics_path(view: 'time'), class: "px-4 py-2 text-sm transition", style: @view_mode == 'time' ? "background: linear-gradient(to bottom, #A8A8AD 0%, #8E8E93 100%); color: #FFFFFF; font-weight: 500; font-family: 'Inter', sans-serif;" : "background: #F5F5F7; color: #1D1D1F; font-weight: 500; font-family: 'Inter', sans-serif;" do %>
              Time
            <% end %>
            <%= link_to analytics_path(view: 'importance'), class: "px-4 py-2 text-sm transition", style: @view_mode == 'importance' ? "background: linear-gradient(to bottom, #A8A8AD 0%, #8E8E93 100%); color: #FFFFFF; font-weight: 500; font-family: 'Inter', sans-serif;" : "background: #F5F5F7; color: #1D1D1F; font-weight: 500; font-family: 'Inter', sans-serif;" do %>
              Priority
            <% end %>
          </div>
        </div>
      </div>

      <!-- Habits List with Health Bars -->
      <% if @habits.any? %>
        <div class="space-y-8">
          <% @grouped_habits.each do |group, habits| %>
            <% if @view_mode == 'category' %>
              <%
                category = group
                dark_color = generate_dark_color(category.color)
                avg_health = (habits.sum(&:health) / habits.count.to_f).round
              %>
              <!-- Category Header -->
              <div data-section-id="category-<%= category.id %>">
                <!-- Full-width stripe header -->
                <button onclick="toggleSection('category-<%= category.id %>')" class="w-full -mx-8 px-8 py-4 flex items-center gap-3 hover:opacity-95 transition" style="background: linear-gradient(to bottom, color-mix(in srgb, <%= category.color %> 85%, white) 0%, <%= category.color %> 100%); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: calc(100% + 4rem);">
                  <i class="fa-solid <%= category.icon %> text-white text-lg"></i>
                  <h2 class="text-3xl flex-1 text-left text-white font-display" style="font-weight: 500;">
                    <%= category.name %>
                  </h2>
                  <div class="flex items-center gap-3">
                    <div class="w-48 hidden md:block">
                      <div class="w-full h-5 rounded-full overflow-hidden" style="background-color: rgba(255, 255, 255, 0.3);">
                        <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-2"
                             style="width: <%= avg_health %>%; background-color: rgba(255, 255, 255, 0.9);">
                          <% if avg_health >= 20 %>
                            <span class="text-xs font-bold" style="color: <%= category.color %>;"><%= avg_health %>%</span>
                          <% end %>
                        </div>
                      </div>
                    </div>
                    <span class="text-white text-sm font-semibold md:hidden"><%= avg_health %>%</span>
                    <i class="fa-solid fa-chevron-down section-chevron transition-transform text-white"></i>
                  </div>
                </button>

                <!-- Habits List -->
                <div class="section-content space-y-3 py-4">
                  <% habits.each do |habit| %>
                    <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-4 bg-white rounded-xl p-4" style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
                      <!-- Habit Name and Info -->
                      <div class="flex-1">
                        <div class="font-semibold text-base mb-0.5" style="color: #1D1D1F;">
                          <%= habit.name %>
                        </div>
                        <div class="text-xs font-light flex items-center gap-2" style="color: #8E8E93;">
                          <span><%= habit.target_count %> <%= habit.target_count == 1 ? 'time' : 'times' %> per day</span>
                          <% if @streaks[habit.id] > 0 %>
                            <span>•</span>
                            <i class="fa-solid fa-fire" style="color: #FFA07A;"></i>
                            <span><%= @streaks[habit.id] %> day streak</span>
                          <% end %>
                        </div>
                      </div>

                      <!-- Health Bar -->
                      <div class="w-full md:w-64 md:flex-shrink-0">
                        <div class="relative">
                          <div class="w-full h-8 rounded-full overflow-hidden" style="background-color: <%= category.color %>20;">
                            <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-3"
                                 style="width: <%= habit.health %>%; background-color: <%= category.color %>;">
                              <% if habit.health >= 15 %>
                                <span class="text-sm font-bold" style="color: <%= dark_color %>;"><%= habit.health %>%</span>
                              <% end %>
                            </div>
                          </div>
                          <% if habit.health < 15 %>
                            <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-8">
                              <span class="text-sm font-bold" style="color: <%= dark_color %>;"><%= habit.health %>%</span>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% elsif @view_mode == 'time' %>
              <!-- Time Block Header -->
              <%
                time_block = group
                avg_health = (habits.sum(&:health) / habits.count.to_f).round
                block_color = time_block&.color || '#8E8E93'
                block_name = time_block&.name || 'Anytime'
                block_icon = time_block&.icon || 'fa-clock'
                section_id = time_block ? "time-#{time_block.id}" : "time-anytime"
              %>
              <div data-section-id="<%= section_id %>">
                <!-- Full-width stripe header -->
                <button onclick="toggleSection('<%= section_id %>')" class="w-full -mx-8 px-8 py-4 flex items-center gap-3 hover:opacity-95 transition" style="background: linear-gradient(to bottom, color-mix(in srgb, <%= block_color %> 85%, white) 0%, <%= block_color %> 100%); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: calc(100% + 4rem);">
                  <i class="<%= block_icon %> text-white text-lg"></i>
                  <h2 class="text-3xl flex-1 text-left text-white font-display" style="font-weight: 500;">
                    <%= block_name %>
                  </h2>
                  <div class="flex items-center gap-3">
                    <div class="w-48 hidden md:block">
                      <div class="w-full h-5 rounded-full overflow-hidden" style="background-color: rgba(255, 255, 255, 0.3);">
                        <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-2"
                             style="width: <%= avg_health %>%; background-color: rgba(255, 255, 255, 0.9);">
                          <% if avg_health >= 20 %>
                            <span class="text-xs font-bold" style="color: <%= block_color %>;"><%= avg_health %>%</span>
                          <% end %>
                        </div>
                      </div>
                    </div>
                    <span class="text-white text-sm font-semibold md:hidden"><%= avg_health %>%</span>
                    <i class="fa-solid fa-chevron-down section-chevron transition-transform text-white"></i>
                  </div>
                </button>

                <!-- Habits List -->
                <div class="section-content space-y-3 py-4">
                  <% habits.each do |habit| %>
                    <% habit_dark_color = generate_dark_color(habit.category.color) %>
                    <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-4 bg-white rounded-xl p-4" style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
                      <!-- Habit Name and Info -->
                      <div class="flex-1">
                        <div class="font-semibold text-base mb-0.5" style="color: #1D1D1F;">
                          <%= habit.name %>
                        </div>
                        <div class="text-xs font-light flex items-center gap-2" style="color: #8E8E93;">
                          <span><%= habit.target_count %> <%= habit.target_count == 1 ? 'time' : 'times' %> per day</span>
                          <% if @streaks[habit.id] > 0 %>
                            <span>•</span>
                            <i class="fa-solid fa-fire" style="color: #FFA07A;"></i>
                            <span><%= @streaks[habit.id] %> day streak</span>
                          <% end %>
                        </div>
                      </div>

                      <!-- Health Bar -->
                      <div class="w-full md:w-64 md:flex-shrink-0">
                        <div class="relative">
                          <div class="w-full h-8 rounded-full overflow-hidden" style="background-color: <%= habit.category.color %>20;">
                            <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-3"
                                 style="width: <%= habit.health %>%; background-color: <%= habit.category.color %>;">
                              <% if habit.health >= 15 %>
                                <span class="text-sm font-bold" style="color: <%= habit_dark_color %>;"><%= habit.health %>%</span>
                              <% end %>
                            </div>
                          </div>
                          <% if habit.health < 15 %>
                            <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-8">
                              <span class="text-sm font-bold" style="color: <%= habit_dark_color %>;"><%= habit.health %>%</span>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% else %>
              <!-- Importance Level Header -->
              <%
                importance_level = group
                avg_health = (habits.sum(&:health) / habits.count.to_f).round
                level_color = importance_level&.color || '#8E8E93'
                level_name = importance_level&.name || 'Normal'
                level_icon = importance_level&.icon || 'fa-circle'
                section_id = importance_level ? "importance-#{importance_level.id}" : "importance-normal"
              %>
              <div data-section-id="<%= section_id %>">
                <!-- Full-width stripe header -->
                <button onclick="toggleSection('<%= section_id %>')" class="w-full -mx-8 px-8 py-4 flex items-center gap-3 hover:opacity-95 transition" style="background: linear-gradient(to bottom, color-mix(in srgb, <%= level_color %> 85%, white) 0%, <%= level_color %> 100%); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); width: calc(100% + 4rem);">
                  <i class="<%= level_icon %> text-white text-lg"></i>
                  <h2 class="text-3xl flex-1 text-left text-white font-display" style="font-weight: 500;">
                    <%= level_name %>
                  </h2>
                  <div class="flex items-center gap-3">
                    <div class="w-48 hidden md:block">
                      <div class="w-full h-5 rounded-full overflow-hidden" style="background-color: rgba(255, 255, 255, 0.3);">
                        <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-2"
                             style="width: <%= avg_health %>%; background-color: rgba(255, 255, 255, 0.9);">
                          <% if avg_health >= 20 %>
                            <span class="text-xs font-bold" style="color: <%= level_color %>;"><%= avg_health %>%</span>
                          <% end %>
                        </div>
                      </div>
                    </div>
                    <span class="text-white text-sm font-semibold md:hidden"><%= avg_health %>%</span>
                    <i class="fa-solid fa-chevron-down section-chevron transition-transform text-white"></i>
                  </div>
                </button>

                <!-- Habits List -->
                <div class="section-content space-y-3 py-4">
                  <% habits.each do |habit| %>
                    <% habit_dark_color = generate_dark_color(habit.category.color) %>
                    <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-4 bg-white rounded-xl p-4" style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
                      <!-- Habit Name and Info -->
                      <div class="flex-1">
                        <div class="font-semibold text-base mb-0.5" style="color: #1D1D1F;">
                          <%= habit.name %>
                        </div>
                        <div class="text-xs font-light flex items-center gap-2" style="color: #8E8E93;">
                          <span><%= habit.target_count %> <%= habit.target_count == 1 ? 'time' : 'times' %> per day</span>
                          <% if @streaks[habit.id] > 0 %>
                            <span>•</span>
                            <i class="fa-solid fa-fire" style="color: #FFA07A;"></i>
                            <span><%= @streaks[habit.id] %> day streak</span>
                          <% end %>
                        </div>
                      </div>

                      <!-- Health Bar -->
                      <div class="w-full md:w-64 md:flex-shrink-0">
                        <div class="relative">
                          <div class="w-full h-8 rounded-full overflow-hidden" style="background-color: <%= habit.category.color %>20;">
                            <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-3"
                                 style="width: <%= habit.health %>%; background-color: <%= habit.category.color %>;">
                              <% if habit.health >= 15 %>
                                <span class="text-sm font-bold" style="color: <%= habit_dark_color %>;"><%= habit.health %>%</span>
                              <% end %>
                            </div>
                          </div>
                          <% if habit.health < 15 %>
                            <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-8">
                              <span class="text-sm font-bold" style="color: <%= habit_dark_color %>;"><%= habit.health %>%</span>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      <% else %>
        <div class="bg-white rounded-xl p-12 text-center" style="box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(199, 199, 204, 0.2);">
          <i class="fa-solid fa-clipboard-list text-6xl mb-4" style="color: #E5E5E7;"></i>
          <h3 class="text-xl mb-2" style="color: #1D1D1F; font-family: 'Inter', sans-serif; font-weight: 700;">No Habits Yet</h3>
          <p class="mb-4" style="color: #8E8E93; font-weight: 300; font-family: 'Inter', sans-serif;">Start building better habits by creating your first one!</p>
          <%= link_to "Browse Categories", root_path, class: "inline-block px-6 py-3 rounded-lg text-white transition transform hover:scale-105", style: "background: linear-gradient(135deg, #2C2C2E, #1D1D1F); font-weight: 600; font-family: 'Inter', sans-serif; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);" %>
        </div>
      <% end %>
    </div>
  </main>
</div>

<script>
  // Category heatmaps toggle
  function toggleCategoryHeatmaps() {
    const container = document.getElementById('category-heatmaps');
    const chevron = document.getElementById('category-chevron');

    if (container.classList.contains('hidden')) {
      container.classList.remove('hidden');
      chevron.classList.add('rotate-90');
    } else {
      container.classList.add('hidden');
      chevron.classList.remove('rotate-90');
    }
  }

  function toggleSection(sectionId) {
    const section = document.querySelector(`[data-section-id="${sectionId}"]`);
    if (!section) return;

    const content = section.querySelector('.section-content');
    const chevron = section.querySelector('.section-chevron');

    if (content.style.display === 'none') {
      content.style.display = '';
      chevron.style.transform = '';
    } else {
      content.style.display = 'none';
      chevron.style.transform = 'rotate(-90deg)';
    }
  }
</script>
