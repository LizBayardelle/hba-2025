<div class="flex h-screen relative" style="background-color: #F5F5F5;">
  <%= render 'shared/sidebar' %>

  <!-- Mobile overlay -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 md:hidden hidden"></div>

  <!-- Menu flag button -->
  <button id="menu-button" class="fixed left-0 z-20 md:hidden rounded-r-lg shadow-lg flex items-center justify-center py-1.5 px-3 cursor-move"
    style="top: 200px; background: linear-gradient(135deg, #1d3e4c, #45606b); writing-mode: vertical-rl;">
    <span class="text-white font-bold text-sm tracking-wider">MENU</span>
  </button>

  <script>
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const menuButton = document.getElementById('menu-button');
    const closeButton = document.getElementById('sidebar-close');

    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      sidebar.classList.add('translate-x-0');
      overlay.classList.remove('hidden');
      menuButton.classList.add('hidden');
    }

    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      sidebar.classList.remove('translate-x-0');
      overlay.classList.add('hidden');
      menuButton.classList.remove('hidden');
    }

    // Draggable menu button
    let isDragging = false;
    let startY = 0;
    let startTop = 200;
    let dragStartTime = 0;

    menuButton.addEventListener('mousedown', (e) => {
      isDragging = true;
      dragStartTime = Date.now();
      startY = e.clientY;
      startTop = parseInt(menuButton.style.top) || 200;
      e.preventDefault();
    });

    menuButton.addEventListener('touchstart', (e) => {
      isDragging = true;
      dragStartTime = Date.now();
      startY = e.touches[0].clientY;
      startTop = parseInt(menuButton.style.top) || 200;
    });

    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        const deltaY = e.clientY - startY;
        const newTop = Math.max(0, Math.min(window.innerHeight - menuButton.offsetHeight, startTop + deltaY));
        menuButton.style.top = newTop + 'px';
        localStorage.setItem('menuButtonTop', newTop);
      }
    });

    document.addEventListener('touchmove', (e) => {
      if (isDragging) {
        const deltaY = e.touches[0].clientY - startY;
        const newTop = Math.max(0, Math.min(window.innerHeight - menuButton.offsetHeight, startTop + deltaY));
        menuButton.style.top = newTop + 'px';
        localStorage.setItem('menuButtonTop', newTop);
      }
    });

    document.addEventListener('mouseup', (e) => {
      if (isDragging) {
        const dragDuration = Date.now() - dragStartTime;
        const dragDistance = Math.abs(e.clientY - startY);

        if (dragDuration < 200 && dragDistance < 5) {
          openSidebar();
        }
        isDragging = false;
      }
    });

    document.addEventListener('touchend', (e) => {
      if (isDragging) {
        const dragDuration = Date.now() - dragStartTime;
        if (dragDuration < 200) {
          openSidebar();
        }
        isDragging = false;
      }
    });

    closeButton.addEventListener('click', closeSidebar);
    overlay.addEventListener('click', closeSidebar);

    const savedTop = localStorage.getItem('menuButtonTop');
    if (savedTop) {
      menuButton.style.top = savedTop + 'px';
    }
  </script>

  <!-- Main Content Area -->
  <main class="flex-1 overflow-y-auto" style="background-color: #F5F5F5;">
    <!-- White Header Section with Shadow -->
    <div class="bg-white shadow-md sticky top-0 z-10">
      <div class="p-8 pb-6">
        <div class="mb-4">
          <h1 class="text-4xl font-bold display-font mb-1" style="color: #1d3e4c;">Analytics</h1>
          <p class="text-sm font-light" style="color: #657b84;">Track your habit activity and health</p>
        </div>
      </div>
    </div>

    <!-- Grey Background Content -->
    <div class="p-8 pt-6 space-y-6">
      <!-- Calendar Heatmap -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-xl font-bold display-font mb-4" style="color: #1d3e4c;">Activity</h2>

        <!-- Overall Heatmap -->
        <div class="mb-6">
          <h3 class="text-sm font-semibold mb-3" style="color: #1d3e4c;">Overall</h3>
          <div class="flex flex-col lg:flex-row gap-8">
            <div class="flex-1 overflow-x-auto">
              <div class="inline-block">
                <div class="flex gap-1">
                  <!-- Day labels -->
                  <div class="flex flex-col gap-1 mr-1">
                    <div class="w-4 h-3 text-[10px] flex items-center" style="color: #657b84;">S</div>
                    <div class="w-4 h-3 text-[10px] flex items-center" style="color: #657b84;">M</div>
                    <div class="w-4 h-3 text-[10px] flex items-center" style="color: #657b84;">T</div>
                    <div class="w-4 h-3 text-[10px] flex items-center" style="color: #657b84;">W</div>
                    <div class="w-4 h-3 text-[10px] flex items-center" style="color: #657b84;">T</div>
                    <div class="w-4 h-3 text-[10px] flex items-center" style="color: #657b84;">F</div>
                    <div class="w-4 h-3 text-[10px] flex items-center" style="color: #657b84;">S</div>
                  </div>

                  <%
                    # Group heatmap data by week
                    weeks = []
                    current_week = []
                    @heatmap_data.keys.sort.each_with_index do |date_str, index|
                      date = Date.parse(date_str)
                      current_week << { date: date, percentage: @heatmap_data[date_str] }

                      # Start new week on Sunday or at the end
                      if date.wday == 6 || index == @heatmap_data.keys.length - 1
                        weeks << current_week
                        current_week = []
                      end
                    end
                  %>

                  <% weeks.each do |week| %>
                    <div class="flex flex-col gap-1">
                      <% 7.times do |day_index| %>
                        <% day_data = week[day_index] %>
                        <% if day_data %>
                          <%
                            percentage = day_data[:percentage]
                            color = if percentage == 0
                              '#E8EEF1'
                            elsif percentage < 25
                              '#c8dce4'
                            elsif percentage < 50
                              '#8fb9ca'
                            elsif percentage < 75
                              '#5696b0'
                            elsif percentage < 100
                              '#2d7088'
                            else
                              '#1d3e4c'
                            end
                          %>
                          <a href="<%= habits_path(date: day_data[:date].to_s, view: 'category') %>"
                            class="w-3 h-3 rounded-sm transition-all hover:ring-2 hover:ring-offset-1 hover:ring-gray-400 cursor-pointer block"
                            style="background-color: <%= color %>;"
                            title="<%= day_data[:date].strftime('%B %d, %Y') %>: <%= percentage %>% complete">
                          </a>
                        <% else %>
                          <div class="w-3 h-3"></div>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                </div>

                <!-- Legend -->
                <div class="flex items-center gap-2 mt-4 text-xs" style="color: #657b84;">
                  <span>Less</span>
                  <div class="w-3 h-3 rounded-sm" style="background-color: #E8EEF1;"></div>
                  <div class="w-3 h-3 rounded-sm" style="background-color: #c8dce4;"></div>
                  <div class="w-3 h-3 rounded-sm" style="background-color: #8fb9ca;"></div>
                  <div class="w-3 h-3 rounded-sm" style="background-color: #5696b0;"></div>
                  <div class="w-3 h-3 rounded-sm" style="background-color: #2d7088;"></div>
                  <div class="w-3 h-3 rounded-sm" style="background-color: #1d3e4c;"></div>
                  <span>More</span>
                </div>
              </div>
            </div>

            <!-- Stats -->
            <div class="flex-shrink-0 lg:w-64 w-full space-y-2 text-sm">
              <div class="flex items-center justify-between border-b border-dotted pb-2" style="border-color: #E8EEF1;">
                <span class="font-light" style="color: #657b84;">Current Streak</span>
                <span class="font-semibold" style="color: #1d3e4c;"><%= @current_streak %> <%= @current_streak == 1 ? 'day' : 'days' %></span>
              </div>
              <div class="flex items-center justify-between border-b border-dotted pb-2" style="border-color: #E8EEF1;">
                <span class="font-light" style="color: #657b84;">This Week</span>
                <span class="font-semibold" style="color: #1d3e4c;"><%= @weekly_completions %> <%= @weekly_completions == 1 ? 'completion' : 'completions' %></span>
              </div>
              <div class="flex items-center justify-between border-b border-dotted pb-2" style="border-color: #E8EEF1;">
                <div class="flex items-center gap-2">
                  <span class="font-light" style="color: #657b84;">Overall Health</span>
                  <div class="relative group">
                    <i class="fa-solid fa-circle-info text-xs cursor-help" style="color: #657b84;"></i>
                    <%= render 'shared/health_explanation' %>
                  </div>
                </div>
                <span class="font-semibold" style="color: #1d3e4c;"><%= @overall_health %>%</span>
              </div>
              <div class="flex items-center justify-between border-b border-dotted pb-2" style="border-color: #E8EEF1;">
                <span class="font-light" style="color: #657b84;">Habits at Risk</span>
                <span class="font-semibold" style="color: #1d3e4c;"><%= @habits_at_risk %></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Per-Category Heatmaps -->
        <% if @categories.any? %>
          <%
            # Calculate gradient colors for category heatmaps
            def calculate_category_gradient(base_color, percentage)
              # Convert hex to RGB
              r = base_color[1..2].to_i(16)
              g = base_color[3..4].to_i(16)
              b = base_color[5..6].to_i(16)

              # Create gradient from very light to full color
              if percentage == 0
                '#E8EEF1'  # Empty state
              else
                # Interpolate between white (255,255,255) and base color
                intensity = percentage / 100.0
                new_r = (255 + (r - 255) * intensity).round
                new_g = (255 + (g - 255) * intensity).round
                new_b = (255 + (b - 255) * intensity).round
                "#%02x%02x%02x" % [new_r, new_g, new_b]
              end
            end
          %>

          <!-- Toggle button for category heatmaps -->
          <button id="category-heatmaps-toggle" onclick="toggleCategoryHeatmaps()" class="flex items-center gap-2 text-sm font-semibold mb-3 transition hover:opacity-70" style="color: #1d3e4c;">
            <i id="category-chevron" class="fa-solid fa-chevron-right text-xs transition-transform"></i>
            <span>By Category</span>
          </button>

          <div id="category-heatmaps" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden">
            <% @categories.each do |category| %>
              <div>
                <div class="flex items-center gap-2 mb-2">
                  <i class="<%= category.icon %> text-xs" style="color: <%= category.color %>;"></i>
                  <h3 class="text-xs font-semibold" style="color: <%= category.color %>;"><%= category.name %></h3>
                </div>
                <div class="overflow-x-auto">
                  <div class="inline-block">
                    <div class="flex gap-1">
                      <%
                        # Group category heatmap data by week
                        cat_weeks = []
                        cat_current_week = []
                        @category_heatmap_data[category.id].keys.sort.each_with_index do |date_str, index|
                          date = Date.parse(date_str)
                          cat_current_week << { date: date, percentage: @category_heatmap_data[category.id][date_str] }

                          # Start new week on Sunday or at the end
                          if date.wday == 6 || index == @category_heatmap_data[category.id].keys.length - 1
                            cat_weeks << cat_current_week
                            cat_current_week = []
                          end
                        end
                      %>

                      <% cat_weeks.each do |week| %>
                        <div class="flex flex-col gap-1">
                          <% 7.times do |day_index| %>
                            <% day_data = week[day_index] %>
                            <% if day_data %>
                              <%
                                percentage = day_data[:percentage]
                                color = calculate_category_gradient(category.color, percentage)
                              %>
                              <a href="<%= habits_path(date: day_data[:date].to_s, view: 'category') %>"
                                class="w-3 h-3 rounded-sm transition-all hover:ring-2 hover:ring-offset-1 hover:ring-gray-400 cursor-pointer block"
                                style="background-color: <%= color %>;"
                                title="<%= category.name %> - <%= day_data[:date].strftime('%B %d, %Y') %>: <%= percentage %>% complete">
                              </a>
                            <% else %>
                              <div class="w-3 h-3"></div>
                            <% end %>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- Controls Bar -->
      <div class="py-2 mb-0 flex gap-2 items-center justify-between">
        <h2 class="text-xl font-bold display-font" style="color: #1d3e4c;">Habit Health Overview</h2>

        <!-- View Toggle -->
        <div class="flex gap-1 bg-white p-0.5 rounded-lg shadow-sm">
          <%= link_to habits_path(view: 'category'), class: "px-2 py-1 rounded-lg text-xs font-semibold transition #{@view_mode == 'category' ? 'shadow-sm' : 'hover:bg-gray-100'}", style: @view_mode == 'category' ? "background-color: #E8EEF1; color: #1d3e4c;" : "color: #1d3e4c;" do %>
            <i class="fa-solid fa-folder mr-1"></i><span class="hidden sm:inline">Category</span><span class="sm:hidden">Cat</span>
          <% end %>
          <%= link_to habits_path(view: 'time'), class: "px-2 py-1 rounded-lg text-xs font-semibold transition #{@view_mode == 'time' ? 'shadow-sm' : 'hover:bg-gray-100'}", style: @view_mode == 'time' ? "background-color: #E8EEF1; color: #1d3e4c;" : "color: #1d3e4c;" do %>
            <i class="fa-solid fa-clock mr-1"></i><span class="hidden sm:inline">Time</span><span class="sm:hidden">Time</span>
          <% end %>
          <%= link_to habits_path(view: 'importance'), class: "px-2 py-1 rounded-lg text-xs font-semibold transition #{@view_mode == 'importance' ? 'shadow-sm' : 'hover:bg-gray-100'}", style: @view_mode == 'importance' ? "background-color: #E8EEF1; color: #1d3e4c;" : "color: #1d3e4c;" do %>
            <i class="fa-solid fa-exclamation mr-1"></i><span class="hidden sm:inline">Priority</span><span class="sm:hidden">Pri</span>
          <% end %>
        </div>
      </div>

      <!-- Habits List with Health Bars -->
      <% if @habits.any? %>
        <div class="space-y-8">
          <% @grouped_habits.each do |group, habits| %>
            <% if @view_mode == 'category' %>
              <%
                category = group
                dark_color = {
                  '#6B8A99' => '#1d3e4c', '#9C8B7E' => '#5C4F45', '#F8796D' => '#B8352A',
                  '#FFA07A' => '#D66A3E', '#E5C730' => '#B89F0A', '#A8A356' => '#7A7637',
                  '#7CB342' => '#4A6B27', '#6EE7B7' => '#2C9D73', '#22D3EE' => '#0E7490',
                  '#6366F1' => '#3730A3', '#A78BFA' => '#6B21A8', '#E879F9' => '#A21CAF',
                  '#FB7185' => '#BE123C', '#9CA3A8' => '#4A5057'
                }[category.color] || '#1d3e4c'
              %>
              <!-- Category Header -->
              <div class="bg-white rounded-xl shadow-md overflow-hidden border" style="border-color: <%= category.color %>;" data-section-id="category-<%= category.id %>">
                <%
                  avg_health = (habits.sum(&:health) / habits.count.to_f).round
                %>
                <button onclick="toggleSection('category-<%= category.id %>')" class="w-full p-4 hover:opacity-80 transition border-b flex flex-col md:flex-row md:items-center gap-3" style="background-color: <%= category.color %>20; border-color: <%= category.color %>;">
                  <div class="flex items-center gap-3 flex-1">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center shadow-sm" style="background-color: <%= category.color %>;">
                      <i class="fa-solid <%= category.icon %> text-white text-sm"></i>
                    </div>
                    <h2 class="text-2xl font-bold display-font flex-1 text-left" style="color: <%= dark_color %>;">
                      <%= category.name %>
                    </h2>
                  </div>
                  <div class="flex items-center gap-3 md:flex-shrink-0">
                    <div class="w-full md:w-64">
                      <div class="w-full h-6 rounded-full overflow-hidden" style="background-color: <%= category.color %>20;">
                        <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-2"
                             style="width: <%= avg_health %>%; background-color: <%= category.color %>;">
                          <% if avg_health >= 15 %>
                            <span class="text-xs font-bold" style="color: <%= dark_color %>;"><%= avg_health %>%</span>
                          <% end %>
                        </div>
                      </div>
                      <% if avg_health < 15 %>
                        <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-6" style="margin-top: -24px;">
                          <span class="text-xs font-bold" style="color: <%= dark_color %>;"><%= avg_health %>%</span>
                        </div>
                      <% end %>
                    </div>
                    <i class="fa-solid fa-chevron-down section-chevron transition-transform" style="color: <%= dark_color %>;"></i>
                  </div>
                </button>

                <!-- Habits List -->
                <div class="section-content space-y-3 p-4">
                  <% habits.each do |habit| %>
                    <% health_state = habit.health_state %>
                    <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-4">
                      <!-- Habit Name and Info -->
                      <div class="flex-1">
                        <div class="font-semibold text-base mb-0.5 flex items-center gap-2" style="color: <%= dark_color %>;">
                          <span><%= habit.name %></span>
                          <% if habit.importance == 'critical' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= category.color %>40; color: <%= dark_color %>;">!!</span>
                          <% elsif habit.importance == 'important' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= category.color %>40; color: <%= dark_color %>;">!</span>
                          <% elsif habit.importance == 'optional' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= category.color %>40; color: <%= dark_color %>;">?</span>
                          <% end %>
                        </div>
                        <div class="text-xs font-light flex items-center gap-2" style="color: #657b84;">
                          <span><%= habit.target_count %> <%= habit.target_count == 1 ? 'time' : 'times' %> per day</span>
                          <% if habit.time_of_day.present? %>
                            <span>•</span>
                            <span class="capitalize"><%= habit.time_of_day %></span>
                          <% end %>
                          <% if @streaks[habit.id] > 0 %>
                            <span>•</span>
                            <i class="fa-solid fa-fire" style="color: #FFA07A;"></i>
                            <span><%= @streaks[habit.id] %> day streak</span>
                          <% end %>
                        </div>
                      </div>

                      <!-- Health Bar -->
                      <div class="w-full md:w-64 md:flex-shrink-0">
                        <div class="relative">
                          <div class="w-full h-8 rounded-full overflow-hidden" style="background-color: <%= category.color %>20;">
                            <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-3"
                                 style="width: <%= habit.health %>%; background-color: <%= category.color %>;">
                              <% if habit.health >= 15 %>
                                <span class="text-sm font-bold" style="color: <%= dark_color %>;"><%= habit.health %>%</span>
                              <% end %>
                            </div>
                          </div>
                          <% if habit.health < 15 %>
                            <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-8">
                              <span class="text-sm font-bold" style="color: <%= dark_color %>;"><%= habit.health %>%</span>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% elsif @view_mode == 'time' %>
              <!-- Time of Day Header -->
              <%
                time_labels = {
                  'morning' => { icon: 'fa-sun', label: 'Morning' },
                  'afternoon' => { icon: 'fa-cloud-sun', label: 'Afternoon' },
                  'evening' => { icon: 'fa-moon', label: 'Evening' },
                  'anytime' => { icon: 'fa-clock', label: 'Anytime' }
                }
                time_info = time_labels[group] || time_labels['anytime']
                avg_health = (habits.sum(&:health) / habits.count.to_f).round
                # Calculate average category color for this time group
                avg_color = habits.first.category.color
              %>
              <div class="bg-white rounded-xl shadow-md overflow-hidden border" style="border-color: #1d3e4c;" data-section-id="time-<%= group %>">
                <button onclick="toggleSection('time-<%= group %>')" class="w-full p-4 hover:opacity-80 transition border-b flex flex-col md:flex-row md:items-center gap-3" style="background-color: #1d3e4c20; border-color: #1d3e4c;">
                  <div class="flex items-center gap-3 flex-1">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center shadow-sm" style="background-color: #1d3e4c;">
                      <i class="fa-solid <%= time_info[:icon] %> text-white text-sm"></i>
                    </div>
                    <h2 class="text-2xl font-bold display-font flex-1 text-left" style="color: #1d3e4c;">
                      <%= time_info[:label] %>
                    </h2>
                  </div>
                  <div class="flex items-center gap-3 md:flex-shrink-0">
                    <div class="w-full md:w-64">
                      <div class="w-full h-6 rounded-full overflow-hidden" style="background-color: #1d3e4c20;">
                        <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-2"
                             style="width: <%= avg_health %>%; background-color: #1d3e4c;">
                          <% if avg_health >= 15 %>
                            <span class="text-xs font-bold text-white"><%= avg_health %>%</span>
                          <% end %>
                        </div>
                      </div>
                      <% if avg_health < 15 %>
                        <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-6" style="margin-top: -24px;">
                          <span class="text-xs font-bold" style="color: #1d3e4c;"><%= avg_health %>%</span>
                        </div>
                      <% end %>
                    </div>
                    <i class="fa-solid fa-chevron-down section-chevron transition-transform" style="color: #1d3e4c;"></i>
                  </div>
                </button>

                <!-- Habits List -->
                <div class="section-content space-y-3 p-4">
                  <% habits.each do |habit| %>
                    <%
                      health_state = habit.health_state
                      habit_dark_color = {
                        '#6B8A99' => '#1d3e4c', '#9C8B7E' => '#5C4F45', '#F8796D' => '#B8352A',
                        '#FFA07A' => '#D66A3E', '#E5C730' => '#B89F0A', '#A8A356' => '#7A7637',
                        '#7CB342' => '#4A6B27', '#6EE7B7' => '#2C9D73', '#22D3EE' => '#0E7490',
                        '#6366F1' => '#3730A3', '#A78BFA' => '#6B21A8', '#E879F9' => '#A21CAF',
                        '#FB7185' => '#BE123C', '#9CA3A8' => '#4A5057'
                      }[habit.category.color] || '#1d3e4c'
                    %>
                    <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-4">
                      <!-- Habit Name and Info -->
                      <div class="flex-1">
                        <div class="font-semibold text-base mb-0.5 flex items-center gap-2" style="color: <%= habit_dark_color %>;">
                          <span><%= habit.name %></span>
                          <% if habit.importance == 'critical' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= habit.category.color %>40; color: <%= habit_dark_color %>;">!!</span>
                          <% elsif habit.importance == 'important' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= habit.category.color %>40; color: <%= habit_dark_color %>;">!</span>
                          <% elsif habit.importance == 'optional' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= habit.category.color %>40; color: <%= habit_dark_color %>;">?</span>
                          <% end %>
                        </div>
                        <div class="text-xs font-light flex items-center gap-2" style="color: #657b84;">
                          <span><%= habit.target_count %> <%= habit.target_count == 1 ? 'time' : 'times' %></span>
                          <% if @streaks[habit.id] > 0 %>
                            <span>•</span>
                            <i class="fa-solid fa-fire" style="color: #FFA07A;"></i>
                            <span><%= @streaks[habit.id] %> day streak</span>
                          <% end %>
                        </div>
                      </div>

                      <!-- Health Bar -->
                      <div class="w-full md:w-64 md:flex-shrink-0">
                        <div class="relative">
                          <div class="w-full h-8 rounded-full overflow-hidden" style="background-color: <%= habit.category.color %>20;">
                            <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-3"
                                 style="width: <%= habit.health %>%; background-color: <%= habit.category.color %>;">
                              <% if habit.health >= 15 %>
                                <span class="text-sm font-bold" style="color: <%= habit_dark_color %>;"><%= habit.health %>%</span>
                              <% end %>
                            </div>
                          </div>
                          <% if habit.health < 15 %>
                            <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-8">
                              <span class="text-sm font-bold" style="color: <%= habit_dark_color %>;"><%= habit.health %>%</span>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% else %>
              <!-- Importance Header -->
              <%
                importance_labels = {
                  'critical' => { label: 'Critical', symbol: '!!' },
                  'important' => { label: 'Important', symbol: '!' },
                  'normal' => { label: 'Normal', symbol: '' },
                  'optional' => { label: 'Optional', symbol: '?' }
                }
                importance_info = importance_labels[group] || importance_labels['normal']
                avg_health = (habits.sum(&:health) / habits.count.to_f).round
              %>
              <div class="bg-white rounded-xl shadow-md overflow-hidden border" style="border-color: #1d3e4c;" data-section-id="importance-<%= group %>">
                <button onclick="toggleSection('importance-<%= group %>')" class="w-full p-4 hover:opacity-80 transition border-b flex flex-col md:flex-row md:items-center gap-3" style="background-color: #1d3e4c20; border-color: #1d3e4c;">
                  <div class="flex items-center gap-3 flex-1">
                    <% if importance_info[:symbol].present? %>
                      <div class="w-8 h-8 rounded-lg flex items-center justify-center shadow-sm text-sm font-bold text-white" style="background-color: #1d3e4c;">
                        <%= importance_info[:symbol] %>
                      </div>
                    <% else %>
                      <div class="w-8 h-8 rounded-lg flex items-center justify-center shadow-sm" style="background-color: #1d3e4c;">
                        <i class="fa-solid fa-circle text-white text-xs"></i>
                      </div>
                    <% end %>
                    <h2 class="text-2xl font-bold display-font flex-1 text-left" style="color: #1d3e4c;">
                      <%= importance_info[:label] %>
                    </h2>
                  </div>
                  <div class="flex items-center gap-3 md:flex-shrink-0">
                    <div class="w-full md:w-64">
                      <div class="w-full h-6 rounded-full overflow-hidden" style="background-color: #1d3e4c20;">
                        <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-2"
                             style="width: <%= avg_health %>%; background-color: #1d3e4c;">
                          <% if avg_health >= 15 %>
                            <span class="text-xs font-bold text-white"><%= avg_health %>%</span>
                          <% end %>
                        </div>
                      </div>
                      <% if avg_health < 15 %>
                        <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-6" style="margin-top: -24px;">
                          <span class="text-xs font-bold" style="color: #1d3e4c;"><%= avg_health %>%</span>
                        </div>
                      <% end %>
                    </div>
                    <i class="fa-solid fa-chevron-down section-chevron transition-transform" style="color: #1d3e4c;"></i>
                  </div>
                </button>

                <!-- Habits List -->
                <div class="section-content space-y-3 p-4">
                  <% habits.each do |habit| %>
                    <%
                      health_state = habit.health_state
                      habit_dark_color = {
                        '#6B8A99' => '#1d3e4c', '#9C8B7E' => '#5C4F45', '#F8796D' => '#B8352A',
                        '#FFA07A' => '#D66A3E', '#E5C730' => '#B89F0A', '#A8A356' => '#7A7637',
                        '#7CB342' => '#4A6B27', '#6EE7B7' => '#2C9D73', '#22D3EE' => '#0E7490',
                        '#6366F1' => '#3730A3', '#A78BFA' => '#6B21A8', '#E879F9' => '#A21CAF',
                        '#FB7185' => '#BE123C', '#9CA3A8' => '#4A5057'
                      }[habit.category.color] || '#1d3e4c'
                    %>
                    <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-4">
                      <!-- Habit Name and Info -->
                      <div class="flex-1">
                        <div class="font-semibold text-base mb-0.5 flex items-center gap-2" style="color: <%= habit_dark_color %>;">
                          <span><%= habit.name %></span>
                          <% if habit.importance == 'critical' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= habit.category.color %>40; color: <%= habit_dark_color %>;">!!</span>
                          <% elsif habit.importance == 'important' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= habit.category.color %>40; color: <%= habit_dark_color %>;">!</span>
                          <% elsif habit.importance == 'optional' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= habit.category.color %>40; color: <%= habit_dark_color %>;">?</span>
                          <% end %>
                        </div>
                        <div class="text-xs font-light flex items-center gap-2" style="color: #657b84;">
                          <span><%= habit.target_count %> <%= habit.target_count == 1 ? 'time' : 'times' %></span>
                          <% if @streaks[habit.id] > 0 %>
                            <span>•</span>
                            <i class="fa-solid fa-fire" style="color: #FFA07A;"></i>
                            <span><%= @streaks[habit.id] %> day streak</span>
                          <% end %>
                        </div>
                      </div>

                      <!-- Health Bar -->
                      <div class="w-full md:w-64 md:flex-shrink-0">
                        <div class="relative">
                          <div class="w-full h-8 rounded-full overflow-hidden" style="background-color: <%= habit.category.color %>20;">
                            <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-3"
                                 style="width: <%= habit.health %>%; background-color: <%= habit.category.color %>;">
                              <% if habit.health >= 15 %>
                                <span class="text-sm font-bold" style="color: <%= habit_dark_color %>;"><%= habit.health %>%</span>
                              <% end %>
                            </div>
                          </div>
                          <% if habit.health < 15 %>
                            <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-8">
                              <span class="text-sm font-bold" style="color: <%= habit_dark_color %>;"><%= habit.health %>%</span>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      <% else %>
        <div class="bg-white rounded-xl shadow-md p-12 text-center">
          <i class="fa-solid fa-clipboard-list text-6xl mb-4" style="color: #E8EEF1;"></i>
          <h3 class="text-xl font-bold display-font mb-2" style="color: #1d3e4c;">No Habits Yet</h3>
          <p class="text-gray-500 font-light mb-4">Start building better habits by creating your first one!</p>
          <%= link_to "Browse Categories", root_path, class: "inline-block px-6 py-3 rounded-lg text-white font-semibold shadow-lg hover:shadow-xl transition", style: "background: linear-gradient(135deg, #1d3e4c, #45606b);" %>
        </div>
      <% end %>
    </div>
  </main>
</div>

<script>
  // Category heatmaps toggle
  function toggleCategoryHeatmaps() {
    const container = document.getElementById('category-heatmaps');
    const chevron = document.getElementById('category-chevron');

    if (container.classList.contains('hidden')) {
      container.classList.remove('hidden');
      chevron.classList.add('rotate-90');
    } else {
      container.classList.add('hidden');
      chevron.classList.remove('rotate-90');
    }
  }

  function toggleSection(sectionId) {
    const section = document.querySelector(`[data-section-id="${sectionId}"]`);
    if (!section) return;

    const content = section.querySelector('.section-content');
    const chevron = section.querySelector('.section-chevron');

    if (content.style.display === 'none') {
      content.style.display = '';
      chevron.style.transform = '';
    } else {
      content.style.display = 'none';
      chevron.style.transform = 'rotate(-90deg)';
    }
  }
</script>
