<div class="flex h-screen relative" style="background-color: #F5F5F7;">
  <%= render 'shared/sidebar' %>

  <!-- Mobile overlay -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 md:hidden hidden"></div>

  <!-- Menu flag button -->
  <button id="menu-button" class="fixed left-0 z-20 md:hidden rounded-r-lg shadow-lg flex items-center justify-center py-1.5 px-3 transition-all"
    style="top: 200px; background: linear-gradient(135deg, #424245, #2C2C2E); writing-mode: vertical-rl;">
    <span class="text-white font-bold text-sm tracking-wider">MENU</span>
  </button>

  <script>
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const menuButton = document.getElementById('menu-button');
    const closeButton = document.getElementById('sidebar-close');

    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      sidebar.classList.add('translate-x-0');
      overlay.classList.remove('hidden');
      menuButton.classList.add('hidden');
    }

    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      sidebar.classList.remove('translate-x-0');
      overlay.classList.add('hidden');
      menuButton.classList.remove('hidden');
    }

    // Draggable menu button
    let isDragging = false;
    let startY = 0;
    let startTop = 200;
    let dragStartTime = 0;

    menuButton.addEventListener('mousedown', (e) => {
      isDragging = true;
      dragStartTime = Date.now();
      startY = e.clientY;
      startTop = parseInt(menuButton.style.top) || 200;
      e.preventDefault();
    });

    menuButton.addEventListener('touchstart', (e) => {
      isDragging = true;
      dragStartTime = Date.now();
      startY = e.touches[0].clientY;
      startTop = parseInt(menuButton.style.top) || 200;
    });

    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        const deltaY = e.clientY - startY;
        const newTop = Math.max(0, Math.min(window.innerHeight - menuButton.offsetHeight, startTop + deltaY));
        menuButton.style.top = newTop + 'px';
        localStorage.setItem('menuButtonTop', newTop);
      }
    });

    document.addEventListener('touchmove', (e) => {
      if (isDragging) {
        const deltaY = e.touches[0].clientY - startY;
        const newTop = Math.max(0, Math.min(window.innerHeight - menuButton.offsetHeight, startTop + deltaY));
        menuButton.style.top = newTop + 'px';
        localStorage.setItem('menuButtonTop', newTop);
      }
    });

    document.addEventListener('mouseup', (e) => {
      if (isDragging) {
        const dragDuration = Date.now() - dragStartTime;
        const dragDistance = Math.abs(e.clientY - startY);

        if (dragDuration < 200 && dragDistance < 5) {
          openSidebar();
        }
        isDragging = false;
      }
    });

    document.addEventListener('touchend', (e) => {
      if (isDragging) {
        const dragDuration = Date.now() - dragStartTime;
        if (dragDuration < 200) {
          openSidebar();
        }
        isDragging = false;
      }
    });

    closeButton.addEventListener('click', closeSidebar);
    overlay.addEventListener('click', closeSidebar);

    // Restore saved position
    const savedTop = localStorage.getItem('menuButtonTop');
    if (savedTop) {
      menuButton.style.top = savedTop + 'px';
    }
  </script>

  <!-- Main Content Area -->
  <main class="flex-1 overflow-y-auto" style="background-color: #F5F5F7;">
    <div id="habits-root" data-default-grouping="<%= current_user.default_habits_grouping %>"></div>
  </main>
</div>

<%= javascript_include_tag "habits_app", type: "module", "data-turbo-track": "reload", defer: true %>
