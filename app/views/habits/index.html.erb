<div class="flex h-screen relative" style="background-color: #F5F5F5;">
  <%= render 'shared/sidebar' %>

  <!-- Mobile overlay -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 md:hidden hidden"></div>

  <!-- Menu flag button -->
  <button id="menu-button" class="fixed left-0 z-20 md:hidden rounded-r-lg shadow-lg flex items-center justify-center py-1.5 px-3 cursor-move"
    style="top: 200px; background: linear-gradient(135deg, #1d3e4c, #45606b); writing-mode: vertical-rl;">
    <span class="text-white font-bold text-sm tracking-wider">MENU</span>
  </button>

  <script>
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const menuButton = document.getElementById('menu-button');
    const closeButton = document.getElementById('sidebar-close');

    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      sidebar.classList.add('translate-x-0');
      overlay.classList.remove('hidden');
      menuButton.classList.add('hidden');
    }

    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      sidebar.classList.remove('translate-x-0');
      overlay.classList.add('hidden');
      menuButton.classList.remove('hidden');
    }

    // Draggable menu button
    let isDragging = false;
    let startY = 0;
    let startTop = 200;
    let dragStartTime = 0;

    menuButton.addEventListener('mousedown', (e) => {
      isDragging = true;
      dragStartTime = Date.now();
      startY = e.clientY;
      startTop = parseInt(menuButton.style.top) || 200;
      e.preventDefault();
    });

    menuButton.addEventListener('touchstart', (e) => {
      isDragging = true;
      dragStartTime = Date.now();
      startY = e.touches[0].clientY;
      startTop = parseInt(menuButton.style.top) || 200;
    });

    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        const deltaY = e.clientY - startY;
        const newTop = Math.max(0, Math.min(window.innerHeight - menuButton.offsetHeight, startTop + deltaY));
        menuButton.style.top = newTop + 'px';
        localStorage.setItem('menuButtonTop', newTop);
      }
    });

    document.addEventListener('touchmove', (e) => {
      if (isDragging) {
        const deltaY = e.touches[0].clientY - startY;
        const newTop = Math.max(0, Math.min(window.innerHeight - menuButton.offsetHeight, startTop + deltaY));
        menuButton.style.top = newTop + 'px';
        localStorage.setItem('menuButtonTop', newTop);
      }
    });

    document.addEventListener('mouseup', (e) => {
      if (isDragging) {
        const dragDuration = Date.now() - dragStartTime;
        const dragDistance = Math.abs(e.clientY - startY);

        if (dragDuration < 200 && dragDistance < 5) {
          openSidebar();
        }
        isDragging = false;
      }
    });

    document.addEventListener('touchend', (e) => {
      if (isDragging) {
        const dragDuration = Date.now() - dragStartTime;
        if (dragDuration < 200) {
          openSidebar();
        }
        isDragging = false;
      }
    });

    closeButton.addEventListener('click', closeSidebar);
    overlay.addEventListener('click', closeSidebar);

    const savedTop = localStorage.getItem('menuButtonTop');
    if (savedTop) {
      menuButton.style.top = savedTop + 'px';
    }
  </script>

  <!-- Main Content Area -->
  <main class="flex-1 overflow-y-auto" style="background-color: #F5F5F5;">
    <!-- White Header Section with Shadow -->
    <div class="bg-white shadow-md sticky top-0 z-10">
      <div class="p-8 pb-6">
        <div class="mb-4">
          <h1 class="text-4xl font-bold display-font mb-1" style="color: #1d3e4c;">My Habits</h1>
          <p class="text-sm font-light" style="color: #657b84;">Track your habit health and progress</p>
        </div>
      </div>
    </div>

    <!-- Grey Background Content -->
    <div class="p-8 pt-6">
      <!-- Controls Bar -->
      <div class="py-2 mb-6 flex gap-2 items-center justify-between">
        <h2 class="text-xl font-bold display-font" style="color: #1d3e4c;">Habit Health Overview</h2>

        <!-- View Toggle -->
        <div class="flex gap-1 bg-white p-0.5 rounded-lg shadow-sm">
          <%= link_to habits_path(view: 'category'), class: "px-2 py-1 rounded-lg text-xs font-semibold transition #{@view_mode == 'category' ? 'shadow-sm' : 'hover:bg-gray-100'}", style: @view_mode == 'category' ? "background-color: #E8EEF1; color: #1d3e4c;" : "color: #1d3e4c;" do %>
            <i class="fa-solid fa-folder mr-1"></i><span class="hidden sm:inline">Category</span><span class="sm:hidden">Cat</span>
          <% end %>
          <%= link_to habits_path(view: 'time'), class: "px-2 py-1 rounded-lg text-xs font-semibold transition #{@view_mode == 'time' ? 'shadow-sm' : 'hover:bg-gray-100'}", style: @view_mode == 'time' ? "background-color: #E8EEF1; color: #1d3e4c;" : "color: #1d3e4c;" do %>
            <i class="fa-solid fa-clock mr-1"></i><span class="hidden sm:inline">Time</span><span class="sm:hidden">Time</span>
          <% end %>
          <%= link_to habits_path(view: 'importance'), class: "px-2 py-1 rounded-lg text-xs font-semibold transition #{@view_mode == 'importance' ? 'shadow-sm' : 'hover:bg-gray-100'}", style: @view_mode == 'importance' ? "background-color: #E8EEF1; color: #1d3e4c;" : "color: #1d3e4c;" do %>
            <i class="fa-solid fa-exclamation mr-1"></i><span class="hidden sm:inline">Priority</span><span class="sm:hidden">Pri</span>
          <% end %>
        </div>
      </div>

      <!-- Habits List with Health Bars -->
      <% if @habits.any? %>
        <div class="space-y-8">
          <% @grouped_habits.each do |group, habits| %>
            <% if @view_mode == 'category' %>
              <%
                category = group
                dark_color = {
                  '#6B8A99' => '#1d3e4c', '#9C8B7E' => '#5C4F45', '#F8796D' => '#B8352A',
                  '#FFA07A' => '#D66A3E', '#E5C730' => '#B89F0A', '#A8A356' => '#7A7637',
                  '#7CB342' => '#4A6B27', '#6EE7B7' => '#2C9D73', '#22D3EE' => '#0E7490',
                  '#6366F1' => '#3730A3', '#A78BFA' => '#6B21A8', '#E879F9' => '#A21CAF',
                  '#FB7185' => '#BE123C', '#9CA3A8' => '#4A5057'
                }[category.color] || '#1d3e4c'
              %>
              <!-- Category Header -->
              <div class="bg-white rounded-xl shadow-md overflow-hidden" data-section-id="category-<%= category.id %>">
                <%
                  avg_health = (habits.sum(&:health) / habits.count.to_f).round
                %>
                <button onclick="toggleSection('category-<%= category.id %>')" class="w-full flex items-center gap-3 p-4 hover:opacity-80 transition border-b border-gray-200">
                  <div class="w-8 h-8 rounded-lg flex items-center justify-center shadow-sm" style="background-color: <%= category.color %>;">
                    <i class="fa-solid <%= category.icon %> text-white text-sm"></i>
                  </div>
                  <h2 class="text-2xl font-bold display-font flex-1 text-left" style="color: <%= dark_color %>;">
                    <%= category.name %>
                  </h2>
                  <div class="w-64 flex-shrink-0 ml-auto">
                    <div class="w-full h-6 rounded-full overflow-hidden" style="background-color: #1d3e4c20;">
                      <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-2"
                           style="width: <%= avg_health %>%; background-color: #1d3e4c;">
                        <% if avg_health >= 15 %>
                          <span class="text-xs font-bold text-white"><%= avg_health %>%</span>
                        <% end %>
                      </div>
                    </div>
                    <% if avg_health < 15 %>
                      <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-6" style="margin-top: -24px;">
                        <span class="text-xs font-bold" style="color: #1d3e4c;"><%= avg_health %>%</span>
                      </div>
                    <% end %>
                  </div>
                  <i class="fa-solid fa-chevron-down section-chevron transition-transform" style="color: <%= dark_color %>;"></i>
                </button>

                <!-- Habits List -->
                <div class="section-content space-y-3 p-4">
                  <% habits.each do |habit| %>
                    <% health_state = habit.health_state %>
                    <div class="flex items-center gap-4">
                      <!-- Habit Name and Info -->
                      <div class="flex-1">
                        <div class="font-semibold text-base mb-0.5 flex items-center gap-2" style="color: <%= dark_color %>;">
                          <span><%= habit.name %></span>
                          <% if habit.importance == 'critical' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= category.color %>40; color: <%= dark_color %>;">!!</span>
                          <% elsif habit.importance == 'important' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= category.color %>40; color: <%= dark_color %>;">!</span>
                          <% elsif habit.importance == 'optional' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= category.color %>40; color: <%= dark_color %>;">?</span>
                          <% end %>
                        </div>
                        <div class="text-xs font-light flex items-center gap-2" style="color: #657b84;">
                          <span><%= habit.target_count %> <%= habit.target_count == 1 ? 'time' : 'times' %> per day</span>
                          <% if habit.time_of_day.present? %>
                            <span>•</span>
                            <span class="capitalize"><%= habit.time_of_day %></span>
                          <% end %>
                          <% if @streaks[habit.id] > 0 %>
                            <span>•</span>
                            <i class="fa-solid fa-fire" style="color: #FFA07A;"></i>
                            <span><%= @streaks[habit.id] %> day streak</span>
                          <% end %>
                        </div>
                      </div>

                      <!-- Health Bar -->
                      <div class="w-64 flex-shrink-0">
                        <div class="relative">
                          <div class="w-full h-8 rounded-full overflow-hidden" style="background-color: <%= category.color %>20;">
                            <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-3"
                                 style="width: <%= habit.health %>%; background-color: <%= category.color %>;">
                              <% if habit.health >= 15 %>
                                <span class="text-sm font-bold" style="color: <%= dark_color %>;"><%= habit.health %>%</span>
                              <% end %>
                            </div>
                          </div>
                          <% if habit.health < 15 %>
                            <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-8">
                              <span class="text-sm font-bold" style="color: <%= dark_color %>;"><%= habit.health %>%</span>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% elsif @view_mode == 'time' %>
              <!-- Time of Day Header -->
              <%
                time_labels = {
                  'morning' => { icon: 'fa-sun', label: 'Morning' },
                  'afternoon' => { icon: 'fa-cloud-sun', label: 'Afternoon' },
                  'evening' => { icon: 'fa-moon', label: 'Evening' },
                  'anytime' => { icon: 'fa-clock', label: 'Anytime' }
                }
                time_info = time_labels[group] || time_labels['anytime']
                avg_health = (habits.sum(&:health) / habits.count.to_f).round
                # Calculate average category color for this time group
                avg_color = habits.first.category.color
              %>
              <div class="bg-white rounded-xl shadow-md overflow-hidden" data-section-id="time-<%= group %>">
                <button onclick="toggleSection('time-<%= group %>')" class="w-full flex items-center gap-3 p-4 hover:opacity-80 transition border-b border-gray-200">
                  <div class="w-8 h-8 rounded-lg flex items-center justify-center shadow-sm" style="background-color: #1d3e4c;">
                    <i class="fa-solid <%= time_info[:icon] %> text-white text-sm"></i>
                  </div>
                  <h2 class="text-2xl font-bold display-font flex-1 text-left" style="color: #1d3e4c;">
                    <%= time_info[:label] %>
                  </h2>
                  <div class="w-64 flex-shrink-0 ml-auto">
                    <div class="w-full h-6 rounded-full overflow-hidden" style="background-color: #1d3e4c20;">
                      <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-2"
                           style="width: <%= avg_health %>%; background-color: #1d3e4c;">
                        <% if avg_health >= 15 %>
                          <span class="text-xs font-bold text-white"><%= avg_health %>%</span>
                        <% end %>
                      </div>
                    </div>
                    <% if avg_health < 15 %>
                      <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-6" style="margin-top: -24px;">
                        <span class="text-xs font-bold" style="color: #1d3e4c;"><%= avg_health %>%</span>
                      </div>
                    <% end %>
                  </div>
                  <i class="fa-solid fa-chevron-down section-chevron transition-transform" style="color: #1d3e4c;"></i>
                </button>

                <!-- Habits List -->
                <div class="section-content space-y-3 p-4">
                  <% habits.each do |habit| %>
                    <%
                      health_state = habit.health_state
                      habit_dark_color = {
                        '#6B8A99' => '#1d3e4c', '#9C8B7E' => '#5C4F45', '#F8796D' => '#B8352A',
                        '#FFA07A' => '#D66A3E', '#E5C730' => '#B89F0A', '#A8A356' => '#7A7637',
                        '#7CB342' => '#4A6B27', '#6EE7B7' => '#2C9D73', '#22D3EE' => '#0E7490',
                        '#6366F1' => '#3730A3', '#A78BFA' => '#6B21A8', '#E879F9' => '#A21CAF',
                        '#FB7185' => '#BE123C', '#9CA3A8' => '#4A5057'
                      }[habit.category.color] || '#1d3e4c'
                    %>
                    <div class="flex items-center gap-4">
                      <!-- Habit Name and Info -->
                      <div class="flex-1">
                        <div class="font-semibold text-base mb-0.5 flex items-center gap-2" style="color: <%= habit_dark_color %>;">
                          <span><%= habit.name %></span>
                          <% if habit.importance == 'critical' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= habit.category.color %>40; color: <%= habit_dark_color %>;">!!</span>
                          <% elsif habit.importance == 'important' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= habit.category.color %>40; color: <%= habit_dark_color %>;">!</span>
                          <% elsif habit.importance == 'optional' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= habit.category.color %>40; color: <%= habit_dark_color %>;">?</span>
                          <% end %>
                        </div>
                        <div class="text-xs font-light flex items-center gap-2" style="color: #657b84;">
                          <span><%= habit.target_count %> <%= habit.target_count == 1 ? 'time' : 'times' %></span>
                          <% if @streaks[habit.id] > 0 %>
                            <span>•</span>
                            <i class="fa-solid fa-fire" style="color: #FFA07A;"></i>
                            <span><%= @streaks[habit.id] %> day streak</span>
                          <% end %>
                        </div>
                      </div>

                      <!-- Health Bar -->
                      <div class="w-64 flex-shrink-0">
                        <div class="relative">
                          <div class="w-full h-8 rounded-full overflow-hidden" style="background-color: <%= habit.category.color %>20;">
                            <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-3"
                                 style="width: <%= habit.health %>%; background-color: <%= habit.category.color %>;">
                              <% if habit.health >= 15 %>
                                <span class="text-sm font-bold" style="color: <%= habit_dark_color %>;"><%= habit.health %>%</span>
                              <% end %>
                            </div>
                          </div>
                          <% if habit.health < 15 %>
                            <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-8">
                              <span class="text-sm font-bold" style="color: <%= habit_dark_color %>;"><%= habit.health %>%</span>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% else %>
              <!-- Importance Header -->
              <%
                importance_labels = {
                  'critical' => { label: 'Critical', symbol: '!!' },
                  'important' => { label: 'Important', symbol: '!' },
                  'normal' => { label: 'Normal', symbol: '' },
                  'optional' => { label: 'Optional', symbol: '?' }
                }
                importance_info = importance_labels[group] || importance_labels['normal']
                avg_health = (habits.sum(&:health) / habits.count.to_f).round
              %>
              <div class="bg-white rounded-xl shadow-md overflow-hidden" data-section-id="importance-<%= group %>">
                <button onclick="toggleSection('importance-<%= group %>')" class="w-full flex items-center gap-3 p-4 hover:opacity-80 transition border-b border-gray-200">
                  <% if importance_info[:symbol].present? %>
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center shadow-sm text-sm font-bold text-white" style="background-color: #1d3e4c;">
                      <%= importance_info[:symbol] %>
                    </div>
                  <% else %>
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center shadow-sm" style="background-color: #1d3e4c;">
                      <i class="fa-solid fa-circle text-white text-xs"></i>
                    </div>
                  <% end %>
                  <h2 class="text-2xl font-bold display-font flex-1 text-left" style="color: #1d3e4c;">
                    <%= importance_info[:label] %>
                  </h2>
                  <div class="w-64 flex-shrink-0 ml-auto">
                    <div class="w-full h-6 rounded-full overflow-hidden" style="background-color: #1d3e4c20;">
                      <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-2"
                           style="width: <%= avg_health %>%; background-color: #1d3e4c;">
                        <% if avg_health >= 15 %>
                          <span class="text-xs font-bold text-white"><%= avg_health %>%</span>
                        <% end %>
                      </div>
                    </div>
                    <% if avg_health < 15 %>
                      <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-6" style="margin-top: -24px;">
                        <span class="text-xs font-bold" style="color: #1d3e4c;"><%= avg_health %>%</span>
                      </div>
                    <% end %>
                  </div>
                  <i class="fa-solid fa-chevron-down section-chevron transition-transform" style="color: #1d3e4c;"></i>
                </button>

                <!-- Habits List -->
                <div class="section-content space-y-3 p-4">
                  <% habits.each do |habit| %>
                    <%
                      health_state = habit.health_state
                      habit_dark_color = {
                        '#6B8A99' => '#1d3e4c', '#9C8B7E' => '#5C4F45', '#F8796D' => '#B8352A',
                        '#FFA07A' => '#D66A3E', '#E5C730' => '#B89F0A', '#A8A356' => '#7A7637',
                        '#7CB342' => '#4A6B27', '#6EE7B7' => '#2C9D73', '#22D3EE' => '#0E7490',
                        '#6366F1' => '#3730A3', '#A78BFA' => '#6B21A8', '#E879F9' => '#A21CAF',
                        '#FB7185' => '#BE123C', '#9CA3A8' => '#4A5057'
                      }[habit.category.color] || '#1d3e4c'
                    %>
                    <div class="flex items-center gap-4">
                      <!-- Habit Name and Info -->
                      <div class="flex-1">
                        <div class="font-semibold text-base mb-0.5 flex items-center gap-2" style="color: <%= habit_dark_color %>;">
                          <span><%= habit.name %></span>
                          <% if habit.importance == 'critical' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= habit.category.color %>40; color: <%= habit_dark_color %>;">!!</span>
                          <% elsif habit.importance == 'important' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= habit.category.color %>40; color: <%= habit_dark_color %>;">!</span>
                          <% elsif habit.importance == 'optional' %>
                            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold" style="background-color: <%= habit.category.color %>40; color: <%= habit_dark_color %>;">?</span>
                          <% end %>
                        </div>
                        <div class="text-xs font-light flex items-center gap-2" style="color: #657b84;">
                          <span><%= habit.target_count %> <%= habit.target_count == 1 ? 'time' : 'times' %></span>
                          <% if @streaks[habit.id] > 0 %>
                            <span>•</span>
                            <i class="fa-solid fa-fire" style="color: #FFA07A;"></i>
                            <span><%= @streaks[habit.id] %> day streak</span>
                          <% end %>
                        </div>
                      </div>

                      <!-- Health Bar -->
                      <div class="w-64 flex-shrink-0">
                        <div class="relative">
                          <div class="w-full h-8 rounded-full overflow-hidden" style="background-color: <%= habit.category.color %>20;">
                            <div class="h-full rounded-full transition-all duration-500 flex items-center justify-end px-3"
                                 style="width: <%= habit.health %>%; background-color: <%= habit.category.color %>;">
                              <% if habit.health >= 15 %>
                                <span class="text-sm font-bold" style="color: <%= habit_dark_color %>;"><%= habit.health %>%</span>
                              <% end %>
                            </div>
                          </div>
                          <% if habit.health < 15 %>
                            <div class="absolute top-0 left-0 right-0 flex items-center justify-center h-8">
                              <span class="text-sm font-bold" style="color: <%= habit_dark_color %>;"><%= habit.health %>%</span>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      <% else %>
        <div class="bg-white rounded-xl shadow-md p-12 text-center">
          <i class="fa-solid fa-clipboard-list text-6xl mb-4" style="color: #E8EEF1;"></i>
          <h3 class="text-xl font-bold display-font mb-2" style="color: #1d3e4c;">No Habits Yet</h3>
          <p class="text-gray-500 font-light mb-4">Start building better habits by creating your first one!</p>
          <%= link_to "Browse Categories", root_path, class: "inline-block px-6 py-3 rounded-lg text-white font-semibold shadow-lg hover:shadow-xl transition", style: "background: linear-gradient(135deg, #1d3e4c, #45606b);" %>
        </div>
      <% end %>
    </div>
  </main>
</div>

<script>
  function toggleSection(sectionId) {
    const section = document.querySelector(`[data-section-id="${sectionId}"]`);
    if (!section) return;

    const content = section.querySelector('.section-content');
    const chevron = section.querySelector('.section-chevron');

    if (content.style.display === 'none') {
      content.style.display = '';
      chevron.style.transform = '';
    } else {
      content.style.display = 'none';
      chevron.style.transform = 'rotate(-90deg)';
    }
  }
</script>
