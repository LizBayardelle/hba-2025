<div class="flex h-screen relative" style="background-color: #F5F5F5;">
  <%= render 'shared/sidebar' %>

  <!-- Mobile overlay -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 md:hidden hidden"></div>

  <!-- Menu flag button -->
  <button id="menu-button" class="fixed left-0 z-20 md:hidden rounded-r-lg shadow-lg flex items-center justify-center py-1.5 px-3 transition-all"
    style="top: 200px; background: linear-gradient(135deg, #1d3e4c, #45606b); writing-mode: vertical-rl;">
    <span class="text-white font-bold text-sm tracking-wider">MENU</span>
  </button>

  <script>
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const menuButton = document.getElementById('menu-button');
    const closeButton = document.getElementById('sidebar-close');

    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      sidebar.classList.add('translate-x-0');
      overlay.classList.remove('hidden');
      menuButton.classList.add('hidden');
    }

    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      sidebar.classList.remove('translate-x-0');
      overlay.classList.add('hidden');
      menuButton.classList.remove('hidden');
    }

    menuButton.addEventListener('click', openSidebar);
    closeButton.addEventListener('click', closeSidebar);
    overlay.addEventListener('click', closeSidebar);
  </script>

  <!-- Main Content Area -->
  <main class="flex-1 overflow-y-auto" style="background-color: #F5F5F5;" x-data="documentsPageData()">
    <!-- White Header Section with Shadow -->
    <div class="bg-white shadow-md">
      <div class="p-8">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-4 mb-2">
              <div class="w-16 h-16 rounded-xl flex items-center justify-center shadow-md" style="background: linear-gradient(135deg, #1d3e4c, #45606b);">
                <i class="fa-solid fa-file-alt text-white text-2xl"></i>
              </div>
              <div>
                <h1 class="text-3xl font-bold display-font" style="color: #1d3e4c;">
                  Documents
                </h1>
                <p class="text-sm font-light" style="color: #657b84;">
                  Manage all your habit resources
                </p>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-2 items-end">
            <button @click="showNewDocumentModal = true" class="px-4 py-2 rounded-lg text-white font-semibold shadow-md hover:shadow-lg transition transform hover:scale-[1.02]" style="background: linear-gradient(135deg, #1d3e4c, #45606b);">
              <i class="fa-solid fa-plus mr-2"></i>Add Document
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Grey Background Content -->
    <div class="p-8 pt-6">
      <% if @habit_contents.any? %>
        <div class="space-y-4">
          <% @habit_contents.each do |content| %>
            <%
              # Determine icon and color based on content type
              icon_data = case content.content_type
              when 'document' then { icon: 'fa-file-alt', color: '#6B8A99' }
              when 'youtube' then { icon: 'fa-brands fa-youtube', color: '#FB7185' }
              when 'video' then { icon: 'fa-video', color: '#A78BFA' }
              when 'link' then { icon: 'fa-link', color: '#22D3EE' }
              else { icon: 'fa-file', color: '#9CA3A8' }
              end
            %>
            <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition">
              <div class="p-6">
                <div class="flex items-start gap-4">
                  <!-- Icon -->
                  <div class="flex-shrink-0 w-12 h-12 rounded-lg flex items-center justify-center shadow-sm" style="background-color: <%= icon_data[:color] %>;">
                    <i class="<%= icon_data[:icon] %> text-white text-lg"></i>
                  </div>

                  <!-- Content Info -->
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-3 mb-2">
                      <h3 class="text-lg font-bold display-font" style="color: #1d3e4c;">
                        <%= content.title %>
                      </h3>
                      <span class="text-xs px-2 py-1 rounded-full font-semibold capitalize" style="background-color: <%= icon_data[:color] %>20; color: <%= icon_data[:color] %>;">
                        <%= content.content_type %>
                      </span>
                    </div>

                    <!-- Associated Habits -->
                    <div class="flex items-center gap-2 text-sm font-light mb-3" style="color: #657b84;">
                      <i class="fa-solid fa-link text-xs"></i>
                      <% if content.habits.any? %>
                        <span>Attached to:
                          <% content.habits.each_with_index do |habit, index| %>
                            <strong style="color: #1d3e4c;"><%= habit.name %></strong><%= index < content.habits.size - 1 ? ', ' : '' %>
                          <% end %>
                        </span>
                      <% else %>
                        <span style="color: #9CA3A8;">Not attached to any habit</span>
                      <% end %>
                    </div>

                    <!-- Actions -->
                    <div class="flex items-center gap-3">
                      <%= link_to habit_content_path(content),
                          class: "text-sm font-semibold hover:opacity-70 transition",
                          style: "color: #{icon_data[:color]};",
                          title: "View content",
                          data: { habit_content_modal: true } do %>
                        <i class="fa-solid fa-eye mr-1"></i>View
                      <% end %>
                      <button @click="editDocumentId = <%= content.id %>" class="text-sm font-semibold hover:opacity-70 transition" style="color: #657b84;">
                        <i class="fa-solid fa-edit mr-1"></i>Edit
                      </button>
                      <button @click="deleteDocument(<%= content.id %>)" class="text-sm font-semibold hover:opacity-70 transition" style="color: #DC2626;">
                        <i class="fa-solid fa-trash mr-1"></i>Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="bg-white rounded-xl shadow-md p-12 text-center">
          <i class="fa-solid fa-file-circle-plus text-6xl mb-4" style="color: #6B8A9940;"></i>
          <p class="text-gray-500 font-light">No documents yet. Click "Add Document" to get started!</p>
        </div>
      <% end %>
    </div>

    <!-- New Document Modal -->
    <%= render 'documents/new_modal' %>

    <!-- Edit Document Modals -->
    <% @habit_contents.each do |content| %>
      <%= render 'habit_contents/edit_modal', content: content %>
    <% end %>
  </main>
</div>

<script>
  function documentsPageData() {
    return {
      showNewDocumentModal: false,
      editDocumentId: null,
      preselectedHabitId: null,

      async submitNewDocument(event) {
        const form = event.target;
        const formData = new FormData(form);

        const habitIds = formData.getAll('habit_content[habit_ids][]').filter(id => id);

        const contentType = formData.get('habit_content[content_type]');
        let bodyContent = formData.get('habit_content[body]');
        if (contentType === 'document') {
          const trixEditor = document.querySelector('trix-editor[input="new-document-body-hidden"]');
          if (trixEditor) {
            bodyContent = trixEditor.value;
          }
        }

        const data = {
          habit_content: {
            content_type: contentType,
            title: formData.get('habit_content[title]'),
            body: bodyContent,
            habit_ids: habitIds,
            metadata: {
              url: formData.get('habit_content[metadata][url]')
            }
          }
        };

        try {
          const response = await fetch('/contents', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('[name=csrf-token]').content
            },
            body: JSON.stringify(data)
          });

          if (!response.ok) {
            const text = await response.text();
            console.error('Response not OK:', response.status, text);
            alert(`Error: Server returned ${response.status}`);
            return;
          }

          const result = await response.json();

          if (result.success) {
            this.showNewDocumentModal = false;
            this.preselectedHabitId = null;
            window.location.reload();
          } else {
            alert('Error: ' + result.errors.join(', '));
          }
        } catch (error) {
          console.error('Caught error:', error);
          alert('An error occurred. Please try again. Check console for details.');
        }
      },

      async updateDocument(contentId) {
        const form = document.getElementById(`edit-form-${contentId}`);
        const formData = new FormData(form);

        const habitIds = formData.getAll('habit_content[habit_ids][]').filter(id => id);

        const contentType = formData.get('habit_content[content_type]');
        let bodyContent = formData.get('habit_content[body]');
        if (contentType === 'document') {
          const trixEditor = document.querySelector(`trix-editor[input="edit-document-body-hidden-${contentId}"]`);
          if (trixEditor) {
            bodyContent = trixEditor.value;
          }
        }

        const data = {
          habit_content: {
            content_type: contentType,
            title: formData.get('habit_content[title]'),
            body: bodyContent,
            habit_ids: habitIds,
            metadata: {
              url: formData.get('habit_content[metadata][url]')
            }
          }
        };

        try {
          const response = await fetch(`/contents/${contentId}`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('[name=csrf-token]').content
            },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          if (result.success) {
            this.editDocumentId = null;
            window.location.reload();
          } else {
            alert('Error: ' + result.errors.join(', '));
          }
        } catch (error) {
          alert('An error occurred. Please try again.');
        }
      },

      async deleteDocument(contentId) {
        if (!confirm('Are you sure you want to delete this document?')) {
          return;
        }

        try {
          const response = await fetch(`/contents/${contentId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('[name=csrf-token]').content
            }
          });

          const result = await response.json();

          if (result.success) {
            window.location.reload();
          } else {
            alert('Error deleting document');
          }
        } catch (error) {
          alert('An error occurred. Please try again.');
        }
      }
    };
  }
</script>
